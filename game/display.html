<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spielbrett-Anzeige</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .player-pawn {
            transition: all 0.5s ease-in-out;
            width: 60%;
            height: 60%;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: absolute;
            z-index: 10;
        }
        .player-pawn:nth-child(2) { transform: translateX(20%); z-index: 11; }
        .player-pawn:nth-child(3) { transform: translateX(-20%); z-index: 12; }
        .player-pawn:nth-child(4) { transform: translateY(20%); z-index: 13; }
        .board-field {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="w-full max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6">Spielbrett</h1>
        <div id="game-board-container" class="bg-gray-800 p-4 rounded-lg shadow-xl">
            <div id="waiting-message" class="text-center text-xl p-10">
                <p>Warte auf Spielstart vom Controller...</p>
                <p class="text-sm text-gray-400 mt-2">Verbinde mit Firebase-Projekt: game-8e351</p>
            </div>
            <div id="game-board" class="grid grid-cols-10 gap-2">
                <!-- Fields will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // --- HIER IST IHRE FIREBASE-KONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyD0bYsfuu1EipFJ_i-2WAikHQ9ycP1jye0",
          authDomain: "game-8e351.firebaseapp.com",
          projectId: "game-8e351",
          storageBucket: "game-8e351.firebasestorage.app",
          messagingSenderId: "713515393193",
          appId: "1:713515393193:web:534d68c9f0d223f6e149b8",
          measurementId: "G-F21SP6RW0B"
        };
        // ----------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Vereinfachter Firestore Document Reference ---
        // Dieser Pfad wird jetzt in IHREM Projekt verwendet.
        const gameDocRef = doc(db, "publicGames", "mainGameState");

        const boardElement = document.getElementById("game-board");
        const waitingMessage = document.getElementById("waiting-message");

        function renderBoard(totalFields) {
            boardElement.innerHTML = "";
            if (!totalFields || totalFields === 0) {
                waitingMessage.classList.remove("hidden");
                return;
            }
            waitingMessage.classList.add("hidden");

            for (let i = 1; i <= totalFields; i++) {
                const field = document.createElement("div");
                field.id = `field-${i}`;
                field.className = "board-field aspect-square bg-gray-700 rounded-md text-xs text-gray-400 p-1 flex items-center justify-center relative";
                field.textContent = i;
                if (i === 1) field.classList.add("bg-green-600", "text-white");
                if (i === totalFields) field.classList.add("bg-yellow-500", "text-white");
                boardElement.appendChild(field);
            }
        }

        function renderPlayers(players) {
            document.querySelectorAll('.player-pawn').forEach(pawn => pawn.remove());
            if (!players) return;

            players.forEach(player => {
                if (player.position > 0) {
                    const field = document.getElementById(`field-${player.position}`);
                    if (field) {
                        const pawn = document.createElement("div");
                        pawn.id = `pawn-${player.id}`;
                        pawn.className = "player-pawn";
                        pawn.style.backgroundColor = player.color;
                        pawn.textContent = `S${player.id}`;
                        field.appendChild(pawn);
                    }
                }
            });
        }

        async function setupRealtimeListener() {
            try {
                // Nur noch anonyme Anmeldung
                await signInAnonymously(auth);
                console.log("Board: Authenticated successfully (Anonymously) in your project.");
                waitingMessage.innerHTML = '<p>Erfolgreich verbunden. Warte auf Daten...</p>';

                onSnapshot(gameDocRef, (doc) => {
                    console.log("Board: Received data update from YOUR project.");
                    if (doc.exists()) {
                        const gameState = doc.data();
                        const currentFields = boardElement.childElementCount;
                        if (currentFields !== gameState.totalFields) {
                            renderBoard(gameState.totalFields);
                        }
                        renderPlayers(gameState.players);
                    } else {
                        console.log("Board: No game state document.");
                        renderBoard(0); // Show waiting message
                    }
                }, (error) => {
                    console.error("Board: Error in onSnapshot: ", error);
                    waitingMessage.textContent = "Fehler bei der Verbindung (onSnapshot).";
                });

            } catch (error) {
                console.error("Board: Authentication failed: ", error);
                waitingMessage.textContent = "Fehler bei der Authentifizierung (Anonym).";
            }
        }

        setupRealtimeListener();
    </script>
</body>
</html>
