<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spiel-Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Game PWA">
    <style>
        body { -webkit-font-smoothing: antialiased; }
        .btn { transition: all 0.1s ease; }
        .btn:active { transform: scale(0.95); }
        .player-btn.selected {
            box-shadow: 0 0 0 4px #a78bfa; /* violet-400 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen font-sans">

    <div class="p-6 rounded-lg bg-gray-800 shadow-xl w-full max-w-md mx-4">
        <h1 class="text-2xl font-bold text-center mb-6 text-purple-400">Spiel-Steuerung</h1>

        <!-- SETUP SECTION -->
        <div class="mb-6 p-4 bg-gray-700 rounded-lg">
            <h2 class="text-lg font-semibold mb-3 text-purple-300">Spiel-Setup</h2>
            <div class="flex space-x-4 mb-4">
                <div class="flex-1">
                    <label for="totalFields" class="block text-sm font-medium text-gray-300 mb-1">Felder</label>
                    <input type="number" id="totalFields" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500" value="50">
                </div>
                <div class="flex-1">
                    <label for="playerCount" class="block text-sm font-medium text-gray-300 mb-1">Spieler</label>
                    <select id="playerCount" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                        <option value="1">1 Spieler</option>
                        <option value="2" selected>2 Spieler</option>
                        <option value="3">3 Spieler</option>
                        <option value="4">4 Spieler</option>
                    </select>
                </div>
            </div>
            <button id="startGameBtn" class="btn w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md shadow-lg">
                Spiel starten / Neu einrichten
            </button>
        </div>

        <!-- SPIELER-KONTROLLEN -->
        <div id="game-controls" class="hidden">
            <div class="mb-4 p-4 bg-gray-700 rounded-lg">
                <h2 class="text-lg font-semibold mb-3 text-purple-300">1. Spieler auswählen</h2>
                <div id="player-selection" class="flex justify-center space-x-3">
                    <!-- Player buttons will be injected here -->
                </div>
            </div>

            <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                <h2 class="text-lg font-semibold mb-3 text-purple-300">2. Aktionen</h2>
                
                <!-- NEUER BUTTON -->
                <button id="revealCardBtn" class="btn w-full px-4 py-2 mb-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-md shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Karte aufdecken
                </button>
                
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <button data-move="1" class="btn move-btn px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-md shadow-lg disabled:opacity-50">+1</button>
                    <button data-move="2" class="btn move-btn px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-md shadow-lg disabled:opacity-50">+2</button>
                    <button data-move="3" class="btn move-btn px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-md shadow-lg disabled:opacity-50">+3</button>
                    <button data-move="4" class="btn move-btn px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-md shadow-lg disabled:opacity-50">+4</button>
                    <button data-move="5" class="btn move-btn px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-md shadow-lg disabled:opacity-50">+5</button>
                    <button data-move="6" class="btn move-btn px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-md shadow-lg disabled:opacity-50">+6</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button id="resetPlayerBtn" class="btn px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md shadow-lg disabled:opacity-50">Auf Start setzen</button>
                    <button data-move="-1" class="btn move-btn px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-black font-bold rounded-md shadow-lg disabled:opacity-50">-1 Feld zurück</button>
                </div>
            </div>
        </div>
        
        <p id="status-text" class="text-center text-yellow-400 text-sm h-4"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        const firebaseConfig = {
          apiKey: "AIzaSyD0bYsfuu1EipFJ_i-2WAikHQ9ycP1jye0",
          authDomain: "game-8e351.firebaseapp.com",
          projectId: "game-8e351",
          storageBucket: "game-8e351.firebasestorage.app",
          messagingSenderId: "713515393193",
          appId: "1:713515393193:web:534d68c9f0d223f6e149b8",
          measurementId: "G-F21SP6RW0B"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const gameDocRef = doc(db, "publicGames", "mainGameState");

        const statusText = document.getElementById("status-text");
        const gameControls = document.getElementById("game-controls");
        const playerSelectionDiv = document.getElementById("player-selection");
        const moveButtons = document.querySelectorAll(".move-btn");
        const resetPlayerBtn = document.getElementById("resetPlayerBtn");
        const revealCardBtn = document.getElementById("revealCardBtn"); // Neuer Knopf
        const startGameBtn = document.getElementById("startGameBtn");

        let selectedPlayer = null;
        let controlButtons = [];

        async function initAuth() {
            try {
                await signInAnonymously(auth);
                console.log("Controller: Authenticated successfully.");
                statusText.textContent = "Verbunden.";
                
                const docSnap = await getDoc(gameDocRef);
                if (docSnap.exists()) {
                    console.log("Controller: Existing game found");
                    const gameData = docSnap.data();
                    setupGameControls(gameData.players);
                } else {
                    statusText.textContent = "Verbunden. Starte ein neues Spiel.";
                }
            } catch (error) {
                console.error("Controller: Authentication failed: ", error);
                statusText.textContent = "Authentifizierung fehlgeschlagen.";
            }
        }

        function setupGameControls(players) {
            playerSelectionDiv.innerHTML = "";
            controlButtons = [
                ...moveButtons, 
                resetPlayerBtn, 
                revealCardBtn // Neuer Knopf zu den Kontrollen hinzufügen
            ];
            
            controlButtons.forEach(btn => btn.disabled = true);

            players.forEach(player => {
                const btn = document.createElement("button");
                btn.className = "player-btn btn w-14 h-14 rounded-full font-bold text-lg border-4";
                btn.textContent = player.id.replace('player', 'P');
                btn.style.backgroundColor = player.color;
                btn.style.borderColor = player.color;
                btn.style.color = "black";
                btn.dataset.playerId = player.id;

                btn.addEventListener("click", () => {
                    selectedPlayer = player.id;
                    document.querySelectorAll('.player-btn').forEach(b => b.classList.remove("selected"));
                    btn.classList.add("selected");
                    controlButtons.forEach(btn => btn.disabled = false);
                    statusText.textContent = `${player.id} ausgewählt.`;
                });
                playerSelectionDiv.appendChild(btn);
            });
            gameControls.classList.remove("hidden");
        }

        async function handleStartGame() {
            statusText.textContent = "Spiel wird erstellt...";
            const totalFields = parseInt(document.getElementById("totalFields").value, 10);
            const playerCount = parseInt(document.getElementById("playerCount").value, 10);
            
            const playerColors = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b"];
            const players = [];
            for (let i = 0; i < playerCount; i++) {
                players.push({
                    id: `player${i + 1}`,
                    color: playerColors[i],
                    position: 0
                });
            }

            try {
                await setDoc(gameDocRef, {
                    totalFields: totalFields,
                    players: players
                });
                console.log("Controller: Game started/reset.");
                statusText.textContent = "Spiel gestartet!";
                setupGameControls(players);
                selectedPlayer = null;
            } catch (error) {
                console.error("Controller: Error starting game: ", error);
                statusText.textContent = "Fehler beim Starten des Spiels.";
            }
        }

        async function movePlayer(moveAmount) {
            if (!selectedPlayer) return;
            statusText.textContent = "Spieler wird bewegt...";
            try {
                const docSnap = await getDoc(gameDocRef);
                if (!docSnap.exists()) return;

                const gameData = docSnap.data();
                const playerIndex = gameData.players.findIndex(p => p.id === selectedPlayer);
                if (playerIndex === -1) return;
                
                let newPosition = gameData.players[playerIndex].position + moveAmount;
                if (newPosition < 0) newPosition = 0;
                
                gameData.players[playerIndex].position = newPosition;

                await setDoc(gameDocRef, gameData);
                statusText.textContent = `${selectedPlayer} bewegt.`;
            } catch (error) {
                console.error("Controller: Error moving player: ", error);
                statusText.textContent = "Fehler beim Bewegen.";
            }
        }
        
        async function resetPlayer() {
            if (!selectedPlayer) return;
            statusText.textContent = "Spieler wird zurückgesetzt...";
            try {
                const docSnap = await getDoc(gameDocRef);
                if (!docSnap.exists()) return;

                const gameData = docSnap.data();
                const playerIndex = gameData.players.findIndex(p => p.id === selectedPlayer);
                if (playerIndex === -1) return;
                
                gameData.players[playerIndex].position = 0; // Auf Start setzen

                await setDoc(gameDocRef, gameData);
                statusText.textContent = `${selectedPlayer} auf Start gesetzt.`;
            } catch (error) {
                console.error("Controller: Error resetting player: ", error);
                statusText.textContent = "Fehler beim Zurücksetzen.";
            }
        }
        
        // --- NEUE FUNKTION ---
        async function revealCard() {
            if (!selectedPlayer) return;
            statusText.textContent = "Karte wird aufgedeckt...";
            try {
                // Wir 'mergen', um nur dieses eine Feld zu aktualisieren
                // Wir senden ein Objekt mit ID und Zeitstempel, 
                // damit das Board das Update bemerkt, 
                // auch wenn derselbe Spieler es erneut anklickt.
                await setDoc(gameDocRef, { 
                    showCardForPlayer: {
                        id: selectedPlayer,
                        timestamp: Date.now()
                    }
                }, { merge: true });
                statusText.textContent = `Karten-Aufdeck-Befehl gesendet.`;
            } catch (error) {
                console.error("Controller: Error revealing card: ", error);
                statusText.textContent = "Fehler beim Aufdecken.";
            }
        }

        startGameBtn.addEventListener("click", handleStartGame);
        moveButtons.forEach(btn => {
            btn.addEventListener("click", () => movePlayer(parseInt(btn.dataset.move, 10)));
        });
        resetPlayerBtn.addEventListener("click", resetPlayer);
        revealCardBtn.addEventListener("click", revealCard); // Event Listener hinzufügen

        initAuth();
    </script>
</body>
</html>
