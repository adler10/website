<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Individuelle Pizza-Konten V4 (LOKAL)</title>
    <!-- Lade Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lade Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        /* Definierte Farben und Schatten f√ºr das Pizza-Thema */
        .pizza-color { color: #f97316; } /* Orange 600 */
        .pizza-bg { background-color: #f97316; }
        .pizza-hover-bg:hover { background-color: #ea580c; } /* Orange 700 */
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        
        /* Modale Zentrierung */
        .modal {
            transition: opacity 0.3s ease;
        }
    </style>
   <!-- FIREBASE AUTH PROTECTION START -->
<style>
    /* Hide body by default to prevent "Flash of Unauthenticated Content" */
    body { display: none; }
</style>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBSI3GyiL3584lh0Nwb79hEEW35suvSh4g",
        authDomain: "auth-107d8.firebaseapp.com",
        projectId: "auth-107d8",
        storageBucket: "auth-107d8.firebasestorage.app",
        messagingSenderId: "735861054924",
        appId: "1:735861054924:web:c87c51e6abcb8f48481169",
        measurementId: "G-SYBYJH5P8D"
    };

    // Initialize with a unique name to avoid conflicts
    const app = initializeApp(firebaseConfig, "AuthGuardApp");
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            // User NOT logged in:
            // 1. Redirect to 403 error page
            // 2. Use 'replace' so the Back button doesn't bring them back here
            window.location.replace('403.html');
        } else {
            // User IS logged in:
            // 1. Reveal the page content
            document.body.style.display = 'block';
            // 2. Trigger a resize event in case canvas/layout needs to recalculate
            window.dispatchEvent(new Event('resize'));
        }
    });

    // Make logout globally available for any buttons on the page
    window.logout = () => {
        signOut(auth).then(() => window.location.replace('403.html'));
    };
</script>
<!-- FIREBASE AUTH PROTECTION END -->
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Hauptcontainer -->
    <div class="max-w-7xl mx-auto">
        
        <!-- Header und Globaler Status -->
        <header class="text-center mb-8 p-6 bg-white rounded-xl card-shadow border-t-4 border-pizza-bg">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2 flex items-center justify-center">
                <span class="text-5xl mr-3 pizza-color">üçï</span>
                Individuelle Pizza-Konten (LOKAL)
            </h1>
            <p class="text-lg text-gray-600 mb-4">Preis pro Pizza: <span class="font-bold pizza-color">7,00 ‚Ç¨</span></p>
            
            <!-- Globaler Kassenstand -->
            <div class="bg-amber-50 p-4 rounded-lg shadow-inner">
                <p class="text-sm font-medium text-amber-800 uppercase tracking-wider">Gesamter Kassenstand (Alle Konten)</p>
                <p class="text-5xl font-extrabold text-amber-900 mt-1">
                    <span id="global-total-amount">0,00</span> ‚Ç¨
                </p>
            </div>
             <p id="user-id-display" class="text-xs text-gray-400 mt-4">Daten werden im lokalen Speicher deines Browsers abgelegt.</p>
        </header>

        <!-- Hauptbereich: Kontoauswahl & Aktionen (3 Spalten Layout) -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <!-- Spalte 1: Konto-Management (Auswahl, Guthaben, Alle Konten) -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- Mein Konto ausw√§hlen & Guthaben -->
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Dein Konto</h2>
                    
                    <label for="account-selector" class="block text-sm font-medium text-gray-700">W√§hle dein Konto</label>
                    <select id="account-selector" 
                            class="mt-1 mb-4 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-amber-500 focus:border-amber-500 bg-white">
                        <option value="">--- W√§hle ein Konto ---</option>
                    </select>

                    <p class="text-sm font-medium text-gray-700">Aktuelles Guthaben:</p>
                    <p class="text-3xl font-extrabold mt-1" id="my-balance">0,00 ‚Ç¨</p>
                    <p id="account-status" class="text-sm text-gray-500 italic mt-2"></p>
                </div>
                
                 <!-- Alle Konten (Neu positioniert) -->
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Alle Kontost√§nde</h2>
                    <ul id="all-accounts-list" class="divide-y divide-gray-200">
                        <p class="text-center text-gray-500 italic">Lade Konten...</p>
                    </ul>
                </div>
            </div>

            <!-- Spalte 2: Bestellung & Kauf (lg:col-span-2) -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Pizza bestellen -->
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Pizza bestellen (Abbuchung von deinem Konto)</h2>
                    
                    <div class="space-y-6">
                        <p id="buy-status" class="text-sm font-medium text-red-500 h-5"></p>
                        
                        <!-- Schnelle Auswahl (Nur 1 Pizza) -->
                        <div class="flex flex-wrap gap-4">
                            <button id="buy-one-pizza" data-count="1" disabled
                                    class="flex-1 min-w-[120px] py-3 px-4 rounded-lg shadow-md text-base font-medium text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-400 transition transform hover:scale-[1.01]">
                                1 Pizza (7,00 ‚Ç¨)
                            </button>
                        </div>

                        <!-- Freie Anzahl -->
                        <div class="flex space-x-4 items-end">
                            <div class="flex-1">
                                <label for="custom-pizza-count" class="block text-sm font-medium text-gray-700">Freie Pizza-Anzahl</label>
                                <input type="number" id="custom-pizza-count" placeholder="z.B. 3" value="1" min="1"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-green-500 focus:border-green-500">
                            </div>
                            <button id="buy-custom-pizza" disabled
                                    class="w-full sm:w-auto py-3 px-6 rounded-lg shadow-md text-base font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 transition duration-150">
                                Bestellen
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Aktuelle Bestellung -->
                <div class="bg-indigo-50 p-6 rounded-xl card-shadow border border-indigo-200">
                    <h2 class="text-xl font-semibold text-indigo-800 mb-4 border-b pb-2 flex justify-between items-center">
                        Aktuelle Bestellung
                        <span id="order-total" class="text-2xl font-extrabold">0,00 ‚Ç¨</span>
                    </h2>
                    
                    <ul id="current-order-list" class="divide-y divide-indigo-200 min-h-[50px]">
                        <p class="text-center text-indigo-500 italic py-2">Noch keine Pizzen bestellt.</p>
                    </ul>

                    <div class="mt-4 pt-4 border-t border-indigo-200 flex justify-end">
                        <button id="complete-order-btn" disabled
                                class="py-2 px-4 rounded-lg shadow-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 transition duration-150">
                            Bestellung abschlie√üen & Zusammenfassung
                        </button>
                    </div>
                </div>

            </div>

            <!-- Spalte 3: Einzahlung, Verlauf, Konto Erstellen -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- Einzahlung (Neu positioniert) -->
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Geld einzahlen</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="deposit-amount" class="block text-sm font-medium text-gray-700">Betrag (‚Ç¨)</label>
                            <input type="number" id="deposit-amount" placeholder="z.B. 10.00" step="0.01" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-amber-500 focus:border-amber-500">
                        </div>
                        <button id="add-deposit-btn" disabled
                                class="w-full py-3 px-6 rounded-lg shadow-md text-base font-medium text-white pizza-bg pizza-hover-bg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition duration-150 ease-in-out">
                            Einzahlen
                        </button>
                    </div>
                </div>
                
                <!-- Neues Konto erstellen (Neu positioniert) -->
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Neues Konto erstellen</h2>
                     <div>
                        <label for="new-account-name" class="block text-sm font-medium text-gray-700">Name des neuen Kontos</label>
                        <input type="text" id="new-account-name" placeholder="Neuer Name"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-amber-500 focus:border-amber-500">
                    </div>
                    <button id="create-account-btn" 
                            class="w-full mt-4 py-2 px-4 rounded-lg shadow-sm text-sm font-medium text-white pizza-bg pizza-hover-bg transition duration-150">
                        Konto erstellen
                    </button>
                </div>

                <!-- Verlauf des aktiven Kontos -->
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Mein Verlauf (<span id="history-name-display">...</span>)</h2>
                    <ul id="transaction-history" class="divide-y divide-gray-200 max-h-60 overflow-y-auto">
                        <p class="text-center text-gray-500 italic">Bitte w√§hle ein Konto aus.</p>
                    </ul>
                </div>

            </div>
        </div>

        <!-- Admin / Reset Button -->
        <div class="mt-8 text-center">
            <button id="reset-fund-btn" 
                    class="py-2 px-4 border border-red-300 rounded-lg shadow-sm text-sm font-medium text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                ‚ö†Ô∏è Alle Konten & aktuelle Bestellung LOKAL l√∂schen
            </button>
        </div>

    </div>

    <!-- Benutzerdefinierte Statusmeldung (ersetzt alert/confirm) -->
    <div id="status-message" class="opacity-0"></div>

    <!-- Modals (Best√§tigung & Zusammenfassung) -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <p id="modal-message" class="text-lg font-medium text-gray-800 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-no" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Abbrechen</button>
                <button id="confirm-yes" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Best√§tigen</button>
            </div>
        </div>
    </div>
    
    <div id="summary-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full mx-4">
            <h2 class="text-2xl font-bold text-gray-900 border-b pb-2 mb-4">Bestell-Zusammenfassung</h2>
            <div id="summary-content">
                <!-- Inhalt wird von JS eingef√ºgt -->
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-summary" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Schlie√üen & Bestellung leeren</button>
            </div>
        </div>
    </div>

    <!-- Lokales JavaScript (ersetzt Firebase Logik) -->
    <script>
        // --- KONSTANTEN & Globale Variablen ---
        const PIZZA_COST = 7.00;
        const STORAGE_KEY_ACCOUNTS = 'pizza_accounts_local';
        const STORAGE_KEY_ORDER = 'current_order_local';

        let accounts = {}; // Lokaler Cache f√ºr alle Konten
        let currentOrder = []; // Lokaler Cache f√ºr die aktuelle Bestellung
        let activeAccountName = '';
        let currentAccountBalance = 0;

        // --- HILFSFUNKTIONEN F√úR LOCALSTORAGE ---

        /** L√§dt Konten und Bestellungen aus dem localStorage */
        function loadData() {
            try {
                const storedAccounts = localStorage.getItem(STORAGE_KEY_ACCOUNTS);
                accounts = storedAccounts ? JSON.parse(storedAccounts) : {};
                
                const storedOrder = localStorage.getItem(STORAGE_KEY_ORDER);
                currentOrder = storedOrder ? JSON.parse(storedOrder) : [];
            } catch (e) {
                console.error("Fehler beim Laden der lokalen Daten:", e);
                accounts = {};
                currentOrder = [];
            }
        }

        /** Speichert Konten und Bestellungen im localStorage und aktualisiert die UI */
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY_ACCOUNTS, JSON.stringify(accounts));
                localStorage.setItem(STORAGE_KEY_ORDER, JSON.stringify(currentOrder));
                // Da wir keine Realtime-Listener von Firebase haben, rufen wir die UI-Updates hier auf
                updateAllUI();
            } catch (e) {
                console.error("Fehler beim Speichern der lokalen Daten:", e);
                showMessage('Fehler beim Speichern der Daten im Browser.', 'error');
            }
        }
        
        // --- UI & EVENT HANDLER ---

        function setupUIHandlers() {
            const selector = document.getElementById('account-selector');
            
            selector.addEventListener('change', () => {
                // Setze activeAccountName auf den neuen Wert (kann leer sein)
                activeAccountName = selector.value;
                updateUIForActiveAccount();
            });

            document.getElementById('create-account-btn').onclick = createNewAccount;
            
            document.getElementById('add-deposit-btn').onclick = () => {
                const amount = parseFloat(document.getElementById('deposit-amount').value) || 0;
                depositMoney(amount);
            };

            document.getElementById('buy-one-pizza').onclick = () => buyPizza(1);
            document.getElementById('buy-custom-pizza').onclick = () => {
                const count = parseInt(document.getElementById('custom-pizza-count').value) || 0;
                buyPizza(count);
            };
            
            document.getElementById('complete-order-btn').onclick = showOrderSummary;
            document.getElementById('close-summary').onclick = completeOrder;

            document.getElementById('reset-fund-btn').onclick = resetAllAccounts;
        }

        /** Aktualisiert alle UI-Elemente */
        function updateAllUI() {
            updateAccountsListAndGlobalTotal();
            updateOrderDisplay();
            updateUIForActiveAccount();
        }
        
        /** Aktualisiert die Konten-Liste, den Globalstand und den Selector */
        function updateAccountsListAndGlobalTotal() {
            let globalTotal = 0;
            let accountListHTML = '';
            const selector = document.getElementById('account-selector');
            const selectedValue = activeAccountName;
            
            selector.innerHTML = '<option value="">--- W√§hle ein Konto ---</option>';

            const accountNames = Object.keys(accounts).sort();

            accountNames.forEach(name => {
                const data = accounts[name];
                // Wichtig: Null oder undefined Salden als 0 behandeln
                const balance = data.balance || 0;
                
                globalTotal += balance;

                const selected = (name === selectedValue) ? 'selected' : '';
                // F√ºge die Option dem Selector hinzu
                selector.innerHTML += `<option value="${name}" ${selected}>${name} (${balance.toFixed(2).replace('.', ',')} ‚Ç¨)</option>`;

                const balanceFormatted = balance.toFixed(2).replace('.', ',');
                accountListHTML += `
                    <li class="flex justify-between items-center py-3">
                        <span class="font-medium text-gray-800">${name}</span>
                        <span class="text-xl font-bold ${balance >= PIZZA_COST ? 'text-green-600' : 'text-gray-500'}">${balanceFormatted} ‚Ç¨</span>
                    </li>
                `;
            });
            
            // Setze den aktiven Kontonamen im Dropdown zur√ºck (oder behalte ihn, wenn vorhanden)
            if (activeAccountName && accounts[activeAccountName]) {
                selector.value = activeAccountName;
            } else {
                 // Wenn das aktive Konto gel√∂scht wurde oder kein Konto ausgew√§hlt war, setze es auf den aktuellen Wert des Selectors (meist leere Option)
                activeAccountName = selector.value;
            }
            
            document.getElementById('global-total-amount').innerText = globalTotal.toFixed(2).replace('.', ',');
            document.getElementById('all-accounts-list').innerHTML = accountListHTML || '<p class="text-center text-gray-500 italic py-2">Noch keine Konten vorhanden. Erstelle jetzt eines!</p>';
        }

        /** Aktualisiert das aktive Konto (Balance, History, Buttons) */
        function updateUIForActiveAccount() {
            const name = activeAccountName;
            const enabled = name !== '';
            const accountData = accounts[name] || {};
            
            // Lade den aktuellen Kontostand aus den lokalen Daten
            currentAccountBalance = accountData.balance || 0;

            // Status anzeigen
            document.getElementById('account-status').innerText = name ? `Angemeldet als: ${name}` : 'Bitte w√§hle ein Konto aus.';
            document.getElementById('history-name-display').innerText = name || '...';
            
            const myBalanceDisplay = document.getElementById('my-balance');
            const historyList = document.getElementById('transaction-history');

            if (!enabled) {
                 // Kein aktives Konto
                 myBalanceDisplay.innerText = '0,00 ‚Ç¨';
                 myBalanceDisplay.className = 'text-3xl font-extrabold mt-1'; // Klassen zur√ºcksetzen
                 historyList.innerHTML = '<p class="text-center text-gray-500 italic py-2">Bitte w√§hle ein Konto aus.</p>';
            } else {
                // Balance anzeigen und f√§rben
                myBalanceDisplay.innerText = currentAccountBalance.toFixed(2).replace('.', ',') + ' ‚Ç¨';
                myBalanceDisplay.classList.toggle('text-green-600', currentAccountBalance >= PIZZA_COST);
                myBalanceDisplay.classList.toggle('text-red-600', currentAccountBalance < PIZZA_COST);

                // History anzeigen
                const history = accountData.history || [];
                historyList.innerHTML = '';
                if (history.length === 0) {
                    historyList.innerHTML = '<p class="text-center text-gray-500 italic py-2">Noch keine Transaktionen.</p>';
                } else {
                    history.forEach(h => {
                        const amountAbs = Math.abs(h.amount);
                        const sign = (h.type === 'Einzahlung' || h.type === 'R√ºckbuchung') ? '' : '-'; 
                        const color = h.amount >= 0 ? 'text-green-600' : 'text-red-600';
                        
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center py-2';
                        li.innerHTML = `
                            <div class="flex flex-col">
                                <span class="font-medium text-gray-800">${h.type} ${h.count ? `(${h.count} Pizzen)` : ''}</span>
                                <span class="text-xs text-gray-400">${h.date}</span>
                            </div>
                            <span class="font-bold ${color}">${sign}${amountAbs.toFixed(2).replace('.', ',')} ‚Ç¨</span>
                        `;
                        historyList.appendChild(li);
                    });
                }
            }
            
            // Buttons enablen/disablen basierend auf dem aktiven Status und dem Guthaben
            const canBuy = currentAccountBalance >= PIZZA_COST;
            document.getElementById('add-deposit-btn').disabled = !enabled;
            document.getElementById('buy-one-pizza').disabled = !enabled || !canBuy;
            document.getElementById('buy-custom-pizza').disabled = !enabled || !canBuy;
        }
        
        /** Aktualisiert die Anzeige der aktuellen Bestellung */
        function updateOrderDisplay() {
            let orderTotal = 0;
            const orderList = document.getElementById('current-order-list');
            const totalDisplay = document.getElementById('order-total');
            const completeBtn = document.getElementById('complete-order-btn');

            orderList.innerHTML = '';
            if (currentOrder.length === 0) {
                orderList.innerHTML = '<p class="text-center text-indigo-500 italic py-2">Noch keine Pizzen bestellt.</p>';
                completeBtn.disabled = true;
            } else {
                currentOrder.forEach(item => {
                    orderTotal += item.cost;
                    
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center py-2 items-start';
                    li.setAttribute('data-name', item.name);
                    li.setAttribute('data-count', item.count);
                    li.innerHTML = `
                        <div class="flex flex-col">
                            <span class="font-medium text-indigo-900">${item.name}</span>
                            <span class="text-xs text-gray-600">${item.count}x Pizza</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="font-bold text-indigo-600">${item.cost.toFixed(2).replace('.', ',')} ‚Ç¨</span>
                            <button class="remove-item-btn text-red-500 hover:text-red-700 p-1 rounded-full bg-red-100 transition duration-150" data-item-id="${item.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94l-1.72-1.72z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    orderList.appendChild(li);
                });
                completeBtn.disabled = false;
                
                // Event-Listener f√ºr L√∂sch-Buttons hinzuf√ºgen
                orderList.querySelectorAll('.remove-item-btn').forEach(btn => {
                    // Verwende einen eindeutigen Handler, um Doppelungen zu vermeiden
                    btn.onclick = (e) => {
                        const itemId = e.currentTarget.dataset.itemId;
                        customConfirm("Soll dieser Artikel wirklich aus der Bestellung entfernt werden? Der Betrag wird dem Besteller gutgeschrieben.").then(confirmed => {
                            if (confirmed) {
                                removeOrderItem(itemId);
                            }
                        });
                    };
                });
            }

            totalDisplay.innerText = orderTotal.toFixed(2).replace('.', ',') + ' ‚Ç¨';
        }

        // --- LOKALE GESCH√ÑFTSLOGIK ---
        
        function createNewAccount() {
            const newNameInput = document.getElementById('new-account-name');
            const newName = newNameInput.value.trim();

            if (!newName) {
                showMessage('Bitte gib einen Namen f√ºr das neue Konto ein.', 'error');
                return;
            }
            
            if (accounts[newName]) {
                showMessage(`Konto "${newName}" existiert bereits. W√§hle es bitte in der Liste aus.`, 'error');
                return;
            }
            
            // Neues Konto erstellen
            accounts[newName] = {
                name: newName,
                balance: 0.00,
                history: []
            };
            
            // Setze das neu erstellte Konto als aktiv
            activeAccountName = newName;
            document.getElementById('new-account-name').value = '';
            
            saveData();
            showMessage(`Konto "${newName}" wurde erfolgreich erstellt.`, 'success');
        }

        function depositMoney(amount) {
            if (!activeAccountName || !accounts[activeAccountName]) return;
            if (isNaN(amount) || amount <= 0) {
                showMessage('Bitte gib einen g√ºltigen Einzahlungsbetrag (> 0,00 ‚Ç¨) ein.', 'error');
                return;
            }
            
            // Betrag auf 2 Dezimalstellen fixieren
            const fixedAmount = parseFloat(amount.toFixed(2));
            const account = accounts[activeAccountName];
            
            // Saldo-Berechnung
            account.balance = parseFloat((account.balance + fixedAmount).toFixed(2)); 
            
            // History Eintrag
            const newHistoryItem = {
                type: 'Einzahlung',
                amount: fixedAmount,
                timestamp: Date.now(),
                date: new Date().toLocaleString('de-DE')
            };
            account.history.unshift(newHistoryItem); // F√ºge am Anfang hinzu

            saveData();
            showMessage(`${activeAccountName} hat ${fixedAmount.toFixed(2).replace('.', ',')}‚Ç¨ eingezahlt.`, 'success');
            document.getElementById('deposit-amount').value = '';
        }

        function buyPizza(count) {
            const parsedCount = parseInt(count);
            if (!activeAccountName || !accounts[activeAccountName] || parsedCount <= 0) return;
            
            const cost = parsedCount * PIZZA_COST;
            const account = accounts[activeAccountName];

            // √úberziehungspr√ºfung
            if (account.balance < cost) {
                document.getElementById('buy-status').innerText = `Kauf abgelehnt! Nicht gen√ºgend Guthaben. Du brauchst ${cost.toFixed(2).replace('.', ',')}‚Ç¨, hast aber nur ${account.balance.toFixed(2).replace('.', ',')}‚Ç¨.`;
                return;
            }
            document.getElementById('buy-status').innerText = '';

            // 1. Konto aktualisieren (Abbuchung)
            account.balance = parseFloat((account.balance - cost).toFixed(2));
            
            // 2. History Eintrag
            const newHistoryItem = {
                type: 'Bestellung',
                amount: -cost,
                count: parsedCount,
                timestamp: Date.now(),
                date: new Date().toLocaleString('de-DE')
            };
            account.history.unshift(newHistoryItem); // F√ºge am Anfang hinzu
            
            // 3. Bestellposten hinzuf√ºgen
            const orderItem = {
                name: activeAccountName,
                count: parsedCount,
                cost: cost,
                timestamp: Date.now(),
                // Einzigartige ID
                id: Date.now().toString() + Math.random().toString(36).substring(2, 9),
            };
            currentOrder.push(orderItem);

            saveData();
            showMessage(`${activeAccountName} hat ${parsedCount} Pizza(s) f√ºr ${cost.toFixed(2).replace('.', ',')}‚Ç¨ bestellt!`, 'success');
        }

        function removeOrderItem(itemId) {
            const itemIndex = currentOrder.findIndex(item => item.id === itemId);

            if (itemIndex === -1) {
                showMessage('Bestellposition nicht gefunden.', 'error');
                return;
            }
            
            const itemToRemove = currentOrder[itemIndex];
            const removedCost = itemToRemove.cost;
            const removedName = itemToRemove.name;
            
            // 1. Bestellposition entfernen
            currentOrder.splice(itemIndex, 1);
            
            // 2. Konto des Bestellers korrigieren (Geld zur√ºckbuchen)
            const account = accounts[removedName];
            if (!account) {
                 // Sollte nicht passieren, aber zur Sicherheit
                 showMessage('Konto des Bestellers f√ºr R√ºckbuchung nicht gefunden.', 'error');
                 return;
            }
            
            account.balance = parseFloat((account.balance + removedCost).toFixed(2));
            
            // 3. History Eintrag
            const newHistoryItem = {
                type: 'R√ºckbuchung',
                amount: removedCost,
                timestamp: Date.now(),
                date: new Date().toLocaleString('de-DE'),
                note: 'Storno aus aktueller Bestellung'
            };
            account.history.unshift(newHistoryItem);

            saveData();
            showMessage(`Bestellposition von ${removedName} (${removedCost.toFixed(2).replace('.', ',')}‚Ç¨) wurde entfernt und gutgeschrieben.`, 'success');
        }
        
        async function completeOrder() {
            document.getElementById('summary-modal').classList.add('hidden');
            if (!await customConfirm("Soll die aktuelle Bestellung wirklich abgeschlossen und geleert werden?")) return;

            currentOrder = []; // Bestellung leeren
            saveData();
            showMessage('Bestellung abgeschlossen und Korb geleert.', 'success');
        }
        
        function showOrderSummary() {
            if (currentOrder.length === 0) {
                showMessage('Es gibt noch keine Artikel in der aktuellen Bestellung.', 'error');
                return;
            }
            
            const totalCost = currentOrder.reduce((sum, item) => sum + item.cost, 0);
            
            const summary = {};

            currentOrder.forEach(item => {
                
                if (summary[item.name]) {
                    summary[item.name].count += item.count;
                    summary[item.name].cost += item.cost;
                } else {
                    summary[item.name] = { count: item.count, cost: item.cost };
                }
            });

            const totalQuantity = Object.values(summary).reduce((sum, item) => sum + item.count, 0);

            // HTML f√ºr die Zusammenfassung erstellen
            let summaryHTML = `<p class="text-xl font-medium mb-4">Insgesamt wurden <span class="text-indigo-600 font-bold">${totalQuantity} Pizzen</span> f√ºr <span class="text-indigo-600 font-bold">${totalCost.toFixed(2).replace('.', ',')} ‚Ç¨</span> bestellt.</p>`;
            summaryHTML += `<h3 class="text-lg font-semibold mt-4 mb-2">Bestellungen nach Person:</h3>`;
            summaryHTML += `<ul class="list-disc list-inside space-y-2">`;
            
            const sortedNames = Object.keys(summary).sort();
            
            sortedNames.forEach(name => {
                const item = summary[name];
                summaryHTML += `<li><span class="font-bold">${name}:</span> ${item.count} Pizzen (${item.cost.toFixed(2).replace('.', ',')} ‚Ç¨)</li>`;
            });

            summaryHTML += `</ul>`;

            document.getElementById('summary-content').innerHTML = summaryHTML;
            document.getElementById('summary-modal').classList.remove('hidden');
        }

        async function resetAllAccounts() {
            if (!await customConfirm("Sollen WIRKLICH ALLE Konten und die aktuelle Bestellung unwiderruflich LOKAL GEL√ñSCHT werden?")) return;

            accounts = {};
            currentOrder = [];
            activeAccountName = '';
            
            localStorage.removeItem(STORAGE_KEY_ACCOUNTS);
            localStorage.removeItem(STORAGE_KEY_ORDER);
            
            updateAllUI();
            showMessage('Alle Konten und die Bestellung wurden lokal gel√∂scht.', 'success');
        }

        // --- UI HILFSFUNKTIONEN (KEIN alert/confirm) ---

        let messageTimeout;
        function showMessage(text, type = 'info') {
            const msgBox = document.getElementById('status-message');
            clearTimeout(messageTimeout);
            msgBox.innerText = text;
            msgBox.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 z-50';

            if (type === 'success') {
                msgBox.classList.add('bg-green-500');
                msgBox.classList.remove('bg-red-500', 'bg-blue-500');
            } else if (type === 'error') {
                msgBox.classList.add('bg-red-500');
                msgBox.classList.remove('bg-green-500', 'bg-blue-500');
            } else {
                msgBox.classList.add('bg-blue-500');
                msgBox.classList.remove('bg-green-500', 'bg-red-500');
            }

            msgBox.classList.remove('opacity-0');
            msgBox.classList.add('opacity-100'); 

            messageTimeout = setTimeout(() => {
                msgBox.classList.remove('opacity-100');
                msgBox.classList.add('opacity-0');
            }, 4000);
        }

        function customConfirm(message) {
            return new Promise(resolve => {
                const modal = document.getElementById('confirm-modal');
                const modalMessage = document.getElementById('modal-message');
                const confirmBtn = document.getElementById('confirm-yes');
                const cancelBtn = document.getElementById('confirm-no');

                // Entferne alte Listener durch Klonen und Ersetzen (wichtig f√ºr Promises)
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                modalMessage.innerText = message;
                modal.classList.remove('hidden');

                const confirmHandler = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };

                const cancelHandler = () => {
                    modal.classList.add('hidden');
                    resolve(false);
                };

                newConfirmBtn.addEventListener('click', confirmHandler, { once: true });
                newCancelBtn.addEventListener('click', cancelHandler, { once: true });
            });
        }
        
        // --- INITIALISIERUNG ---
        function initializeApp() {
            loadData(); // Lade gespeicherte Daten
            setupUIHandlers(); // Setze alle Event-Listener
            updateAllUI(); // Aktualisiere die Oberfl√§che mit den geladenen Daten
            
            // Zeige eine Willkommensnachricht, wenn die App das erste Mal geladen wird
            if (Object.keys(accounts).length === 0) {
                 showMessage('Willkommen! Erstelle zuerst ein neues Konto, um loszulegen.', 'info');
            } else {
                 showMessage('Daten erfolgreich aus dem lokalen Speicher geladen.', 'success');
            }
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
