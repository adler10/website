<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Lagezeichner | FF Li-Ho</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Typography: Roboto Slab (Hero) & Inter (Tech) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Slab:wght@700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fire-red': '#cc0000',
                        'fire-red-hover': '#a30000',
                        'police-blue': '#2563eb',
                        'alert-amber': '#d97706',
                        'soot-black': '#1a1a1a',
                        'cool-gray': '#f9fafb',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        slab: ['Roboto Slab', 'serif'],
                    },
                    boxShadow: {
                        'hero': '0 4px 20px -2px rgba(0, 0, 0, 0.1)',
                        'sticky': '0 4px 6px -1px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        h1, h2, h3, .font-hero { font-family: 'Roboto Slab', serif; font-weight: 700; }
        
        #map { height: 100%; width: 100%; z-index: 0; background-color: #e5e7eb; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Map Cursors */
        .map-draw-mode, .map-pin-mode { cursor: crosshair !important; }
        
        /* Leaflet Draw Markers */
        .leaflet-drawing-icon {
            background-color: #cc0000; 
            border: 2px solid #ffffff;
            width: 14px; height: 14px;
            border-radius: 50%;
            margin-top: -7px; margin-left: -7px;
            position: absolute;
            box-shadow: 0 0 0 3px rgba(204, 0, 0, 0.3);
            cursor: pointer !important;
            transition: transform 0.1s;
            z-index: 1000;
        }
        .leaflet-drawing-icon:hover { transform: scale(1.4); }
        
        /* Snap Guide Markers */
        .leaflet-snap-icon {
            background-color: rgba(26, 26, 26, 0.5); 
            border: 1px solid #1a1a1a;
            width: 8px; height: 8px;
            border-radius: 50%;
            margin-top: -4px; margin-left: -4px;
            position: absolute;
            pointer-events: none; 
            z-index: 500;
        }

        /* Incident Selection Styling */
        .incident-selected {
            border-color: #cc0000 !important;
            background-color: #fff1f1 !important;
            box-shadow: 0 10px 15px -3px rgba(204, 0, 0, 0.1), 0 4px 6px -2px rgba(204, 0, 0, 0.05);
            transform: scale(1.01);
        }

        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }

        /* Toasts */
        .toast-notification {
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0; transform: translateX(100%);
        }
        .toast-notification.show { opacity: 1; transform: translateX(0); }
        .toast-notification.fade-out { opacity: 0; transform: translateX(100%); }

        /* Z-Indices */
        #offline-overlay { z-index: 9999 !important; }
        .modal-backdrop { z-index: 5000 !important; }
        
        /* Status Badges */
        .status-badge-open { background-color: #cc0000; color: #ffffff; border: 1px solid #990000; }
        .status-badge-dispatched { background-color: #2563eb; color: #ffffff; border: 1px solid #1d4ed8; }
        .status-badge-completed { background-color: #d97706; color: #ffffff; border: 1px solid #b45309; }

        .ea-label {
            background: transparent;
            border: none;
            box-shadow: none;
            color: #1a1a1a !important; 
            text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff;
            font-family: 'Roboto Slab', serif;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Button Styles */
        .btn-hero {
            background-color: #cc0000; color: white; text-transform: uppercase; font-weight: 700;
            font-family: 'Inter', sans-serif; letter-spacing: 0.05em; transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-hero:hover { background-color: #a30000; transform: translateY(-1px); }
        .btn-hero:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-secondary {
            background-color: white; border: 1px solid #d1d5db; color: #1a1a1a; font-weight: 600;
            text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;
        }
        .btn-secondary:hover { background-color: #f3f4f6; border-color: #9ca3af; }

    </style>
</head>
<body class="bg-cool-gray text-soot-black h-screen overflow-hidden flex flex-col md:flex-row relative">

    <!-- SIDEBAR TOGGLE BUTTON (Desktop Only) -->
    <button id="sidebar-toggle-btn" class="fixed z-[2000] top-1/2 -translate-y-1/2 left-0 md:left-[480px] bg-white border border-gray-300 shadow-lg rounded-r-lg p-1 transition-all duration-300 hover:bg-gray-50 hover:text-fire-red h-12 w-6 hidden md:flex items-center justify-center" title="Seitenleiste umschalten">
        <!-- Lucide: Chevron Left -->
        <svg id="sidebar-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
    </button>

    <!-- LEFT SIDEBAR (Main Scroll Container) -->
    <div id="sidebar-container" class="w-full md:w-[480px] bg-white border-r border-gray-200 h-full shadow-hero z-20 relative overflow-y-auto transition-[width] duration-300 flex-shrink-0">
        
        <!-- 1. HEADER (Scrolls Away) -->
        <div class="p-6 bg-soot-black">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-3">
                    <div class="bg-fire-red text-white p-2 rounded shadow-lg">
                        <!-- Lucide: Shield Alert -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-alert"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
                    </div>
                    <div>
                        <h1 class="text-2xl text-white leading-none tracking-tight">EINSATZ<span class="text-fire-red">LEITUNG</span></h1>
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest font-medium">Feuerwehr & Katastrophenschutz</p>
                    </div>
                </div>
                
                <button id="undo-btn" class="text-[10px] uppercase font-bold px-3 py-1.5 rounded bg-gray-800 text-gray-300 hover:bg-gray-700 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed flex items-center transition-colors border border-gray-700" disabled>
                    <!-- Lucide: Rotate Ccw -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-ccw mr-1"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 5v7h7"/></svg>
                    Rückgängig
                </button>
            </div>

            <div id="status-indicator" class="flex items-center justify-center space-x-2 text-xs font-bold uppercase tracking-wide py-2 px-3 rounded bg-green-900/30 text-green-400 border border-green-800/50">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                <span>System online</span>
            </div>
        </div>

        <!-- 2. STICKY CONTROLS (Sticks to top) -->
        <div class="sticky top-0 z-30 bg-white/95 backdrop-blur border-b border-gray-200 shadow-sticky">
            <!-- Main Actions -->
            <div class="p-4 grid grid-cols-2 gap-3">
                <button id="open-create-incident-modal-btn" class="col-span-2 btn-hero py-3 px-4 rounded-lg flex items-center justify-center space-x-2">
                    <!-- Lucide: Siren -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-siren"><path d="M7 12a5 5 0 0 1 5-5v0a5 5 0 0 1 5 5v6H7v-6Z"/><path d="M5 20a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v2H5v-2Z"/><path d="M21 12h1"/><path d="M18.5 4.5 18 5"/><path d="M2 12h1"/><path d="M5.5 4.5 6 5"/></svg>
                    <span>Neuer Einsatz</span>
                </button>
                <button id="manage-ea-btn" class="btn-secondary py-2 px-3 rounded-lg text-center">EA Verwalten</button>
                <button id="end-shift-btn" class="btn-secondary py-2 px-3 rounded-lg text-center">Bericht / Ende</button>
            </div>

            <!-- Search Bar -->
            <div class="px-4 pb-2">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <!-- Lucide: Search -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search text-gray-400"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    </div>
                    <input type="text" id="incident-search" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-fire-red focus:border-fire-red text-sm font-sans" placeholder="Suche Ort, Stichwort, EA...">
                </div>
            </div>

            <!-- Sort Options -->
            <div class="px-4 pb-3 pt-1">
                <div id="sort-bar" class="flex space-x-1 bg-gray-100 p-1 rounded-lg border border-gray-200">
                    <button type="button" data-sort="createdAt" class="sort-btn flex-1 py-1.5 text-[10px] font-bold uppercase rounded bg-soot-black text-white shadow-md transition-all text-center">Zeit</button>
                    <button type="button" data-sort="keyword" class="sort-btn flex-1 py-1.5 text-[10px] font-bold uppercase rounded text-gray-500 hover:bg-white hover:text-soot-black transition-all text-center">A-Z</button>
                    <button type="button" data-sort="status" class="sort-btn flex-1 py-1.5 text-[10px] font-bold uppercase rounded text-gray-500 hover:bg-white hover:text-soot-black transition-all text-center">Status</button>
                    <button type="button" data-sort="ea" class="sort-btn flex-1 py-1.5 text-[10px] font-bold uppercase rounded text-gray-500 hover:bg-white hover:text-soot-black transition-all text-center">EA</button>
                </div>
            </div>
        </div>

        <!-- 3. SCROLLABLE LIST CONTENT -->
        <div class="p-6 space-y-6">
            
            <!-- Active Incidents -->
            <div class="space-y-3">
                <button id="active-toggle-btn" class="w-full flex items-center justify-between text-xs font-bold text-soot-black hover:text-fire-red uppercase tracking-widest mb-2 group sticky top-[220px] z-10 bg-gray-50/80 backdrop-blur py-2">
                    <span>Aktive Einsätze</span>
                    <!-- Lucide: Chevron Down -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down text-gray-400 group-hover:text-fire-red transition-transform transform rotate-0"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div id="incident-list" class="space-y-4 min-h-[50px]">
                    <!-- Incidents injected here -->
                    <div class="text-center py-10 border-2 border-dashed border-gray-200 rounded-lg">
                        <p class="text-gray-400 text-sm font-medium">Keine aktiven Einsätze</p>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200 my-6"></div>

            <!-- Completed Incidents -->
            <div class="space-y-3">
                <button id="completed-toggle-btn" class="w-full flex items-center justify-between text-xs font-bold text-gray-400 hover:text-gray-600 uppercase tracking-widest group">
                    <span>Archiv</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right text-gray-300 transition-transform transform"><path d="m9 18 6-6-6-6"/></svg>
                </button>
                <div id="completed-incident-list" class="space-y-3 hidden">
                    <!-- Completed incidents -->
                </div>
            </div>

            <p class="text-[10px] text-gray-400 text-center pt-6 uppercase tracking-widest font-medium">Lokaler Speicher Aktiv</p>
        </div>
    </div>

    <!-- MAP AREA -->
    <div class="flex-1 relative h-full bg-gray-100">
        <div id="map" class="z-0"></div>
        
        <!-- Overlay Gradient -->
        <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-soot-black/10 to-transparent pointer-events-none z-[400]"></div>
    </div>

    <!-- FLOATING TOOLS PANELS -->
    <div class="fixed bottom-8 right-8 flex flex-col items-end space-y-4 z-[1000] pointer-events-none">
        
        <!-- EA Draw Panel -->
        <div id="section-draw-panel" class="pointer-events-auto bg-soot-black text-white p-5 rounded-lg shadow-2xl border-l-4 border-fire-red w-80 hidden animate-slide-in">
            <div class="flex justify-between items-start mb-3">
                <h3 class="font-hero text-lg tracking-wide">EA ZEICHNEN</h3>
                <span class="animate-pulse h-2 w-2 rounded-full bg-fire-red mt-2"></span>
            </div>
            <p class="text-xs text-gray-400 mb-4 font-sans">Punkte auf Karte setzen.<br>Startpunkt klicken zum Schließen.</p>
            <div class="grid grid-cols-2 gap-3">
                <button id="finish-draw-btn" class="bg-fire-red hover:bg-fire-red-hover text-white text-xs font-bold uppercase py-2 px-3 rounded">Fertig</button>
                <button id="cancel-draw-btn" class="bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs font-bold uppercase py-2 px-3 rounded">Abbruch</button>
            </div>
        </div>

        <!-- Add Incident Panel -->
        <div id="incident-add-panel" class="pointer-events-auto bg-soot-black text-white p-5 rounded-lg shadow-2xl border-l-4 border-fire-red w-80 hidden animate-slide-in">
            <div class="flex justify-between items-start mb-3">
                <h3 class="font-hero text-lg tracking-wide">ORT WÄHLEN</h3>
                <span class="animate-pulse h-2 w-2 rounded-full bg-fire-red mt-2"></span>
            </div>
            <p class="text-xs text-gray-400 mb-4 font-sans">Zielort auf der Karte anklicken.</p>
            <button id="cancel-add-incident-btn" class="w-full bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs font-bold uppercase py-2 px-3 rounded">Abbruch</button>
        </div>

        <!-- Edit Incident Panel -->
        <div id="incident-edit-panel" class="pointer-events-auto bg-soot-black text-white p-5 rounded-lg shadow-2xl border-l-4 border-police-blue w-80 hidden animate-slide-in">
            <div class="flex justify-between items-start mb-3">
                <h3 class="font-hero text-lg tracking-wide">EINSATZ VERSCHIEBEN</h3>
                <span class="animate-pulse h-2 w-2 rounded-full bg-police-blue mt-2"></span>
            </div>
            <p class="text-xs text-gray-400 mb-4 font-sans">Neuen Ort auf Karte wählen.</p>
            <button id="cancel-edit-incident-btn" class="w-full bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs font-bold uppercase py-2 px-3 rounded">Abbruch</button>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed top-8 right-8 z-[7000] w-full max-w-sm space-y-3 pointer-events-none"></div>

    <!-- MODALS -->

    <!-- Duplicate Warning Modal -->
    <div id="duplicate-warning-modal" class="modal-backdrop fixed inset-0 bg-soot-black/70 backdrop-blur-sm hidden flex items-center justify-center p-4 transition-opacity duration-300" style="z-index: 6000;">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md flex flex-col overflow-hidden animate-slide-in">
            <div class="p-6 bg-red-50 border-b border-red-100 flex items-start space-x-4">
                <div class="bg-red-100 p-2 rounded-full text-fire-red">
                    <!-- Lucide: Alert Triangle -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-triangle"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                </div>
                <div>
                    <h3 class="font-hero text-xl text-soot-black">DUPLIKAT WARNUNG</h3>
                    <p class="text-sm text-red-700 mt-1 font-sans">Aktiver Einsatz im Umkreis von 15m erkannt.</p>
                </div>
            </div>
            <div class="p-6 bg-white">
                <p class="text-sm text-gray-600 mb-6 font-sans font-medium">Möchten Sie diesen Einsatz trotzdem erstellen?</p>
                <div class="flex space-x-3">
                    <button id="cancel-duplicate-btn" class="flex-1 btn-secondary py-3 rounded-lg">Abbrechen</button>
                    <button id="confirm-duplicate-btn" class="flex-1 btn-hero py-3 rounded-lg">Trotzdem Erstellen</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Incident Modal -->
    <div id="incident-creation-modal" class="modal-backdrop fixed inset-0 bg-soot-black/70 backdrop-blur-sm hidden flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden animate-slide-in">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-white">
                <h2 class="font-hero text-xl text-soot-black">NEUER EINSATZ</h2>
                <button id="close-incident-modal-btn" class="text-gray-400 hover:text-fire-red p-1 rounded transition-colors">
                    <!-- FIXED Lucide: X (Path was incorrect in previous version causing render issues) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>
                </button>
            </div>
            
            <div class="p-8 overflow-y-auto bg-gray-50">
                <form id="dispatch-form" class="space-y-5">
                    <!-- Map Button -->
                    <button type="button" id="add-incident-map-btn" class="w-full flex items-center justify-center space-x-2 bg-white hover:bg-gray-50 text-soot-black border-2 border-gray-200 font-bold uppercase text-xs tracking-wider py-3 px-4 rounded-lg transition-all hover:border-gray-400">
                        <!-- Lucide: Map Pin -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin text-fire-red"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                        <span>Auf Karte Wählen</span>
                    </button>

                    <div class="relative">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">Adresse</label>
                        <input type="text" id="address" class="w-full bg-white border border-gray-300 text-soot-black text-sm font-medium rounded-lg focus:ring-2 focus:ring-fire-red focus:border-fire-red block p-3 transition-shadow shadow-sm" placeholder="Straße, Hausnummer, Ort..." autocomplete="off">
                        <input type="hidden" id="lat-input"><input type="hidden" id="lon-input">
                        <input type="hidden" id="location-name-input"> 
                        <div id="address-suggestions" class="absolute z-20 w-full bg-white border border-gray-200 mt-1 rounded-lg shadow-xl hidden max-h-60 overflow-y-auto text-sm"></div>
                    </div>

                    <div class="relative">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">Alarmstichwort</label>
                        <input type="text" id="keyword" class="w-full bg-white border border-gray-300 text-soot-black text-sm font-medium rounded-lg focus:ring-2 focus:ring-fire-red focus:border-fire-red block p-3 transition-shadow shadow-sm" placeholder="z.B. B 3 - Zimmerbrand" required autocomplete="off">
                        <div id="keyword-suggestions" class="absolute z-20 w-full bg-white border border-gray-200 mt-1 rounded-lg shadow-xl hidden max-h-60 overflow-y-auto text-sm"></div>
                    </div>

                    <div class="p-4 bg-white rounded-lg border border-gray-200 flex items-center justify-between shadow-sm">
                        <span class="text-xs font-bold text-gray-500 uppercase">Auto-EA</span>
                        <span id="auto-section-display" class="text-sm font-bold text-soot-black">Warte auf Adresse...</span>
                        <input type="hidden" id="final-section-assignment">
                    </div>

                    <button type="submit" id="submit-btn" class="w-full btn-hero py-4 rounded-lg text-sm" disabled>
                        Einheit Alarmieren
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Incident Modal -->
    <div id="incident-edit-modal" class="modal-backdrop fixed inset-0 bg-soot-black/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-white">
                <h2 class="font-hero text-xl text-soot-black">EINSATZ BEARBEITEN</h2>
                <button id="close-incident-edit-modal-btn" class="text-gray-400 hover:text-fire-red p-1 rounded-full">
                    <!-- Lucide: X -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>
                </button>
            </div>
            <div class="p-8 overflow-y-auto bg-gray-50">
                <form id="incident-edit-form" class="space-y-5">
                    <button type="button" id="edit-incident-map-btn" class="w-full flex items-center justify-center space-x-2 bg-white hover:bg-gray-50 text-soot-black border-2 border-gray-200 font-bold uppercase text-xs tracking-wider py-3 px-4 rounded-lg transition-all hover:border-gray-400">
                        <span>Marker Verschieben</span>
                    </button>

                    <div class="relative">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">Adresse</label>
                        <input type="text" id="edit-address" class="w-full bg-white border border-gray-300 text-soot-black text-sm font-medium rounded-lg p-3 shadow-sm" autocomplete="off">
                        <input type="hidden" id="edit-lat-input"><input type="hidden" id="edit-lon-input">
                        <input type="hidden" id="edit-location-name-input">
                        <div id="edit-address-suggestions" class="absolute z-20 w-full bg-white border border-gray-200 mt-1 rounded-lg shadow-xl hidden max-h-60 overflow-y-auto text-sm"></div>
                    </div>
                    <div class="relative">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">Stichwort</label>
                        <input type="text" id="edit-keyword" class="w-full bg-white border border-gray-300 text-soot-black text-sm font-medium rounded-lg p-3 shadow-sm" required autocomplete="off">
                        <div id="edit-keyword-suggestions" class="absolute z-20 w-full bg-white border border-gray-200 mt-1 rounded-lg shadow-xl hidden max-h-60 overflow-y-auto text-sm"></div>
                    </div>
                    
                    <!-- Manual EA Selection -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">EA Zuordnung</label>
                        <select id="edit-ea-select" class="w-full bg-white border border-gray-300 text-soot-black text-sm font-medium rounded-lg focus:ring-fire-red focus:border-fire-red block p-3 shadow-sm">
                            <option value="">Auto (Geo-basiert)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">Status</label>
                        <input type="hidden" id="edit-status-hidden">
                        <!-- VISUAL FEEDBACK: Added colors for active states -->
                        <div class="flex rounded-lg shadow-sm isolate">
                            <button type="button" id="edit-status-btn-open" data-status="open" class="edit-status-btn flex-1 py-3 text-xs font-bold uppercase border border-gray-300 rounded-l-lg focus:z-10 transition-colors bg-white text-gray-600 hover:bg-gray-50">Offen</button>
                            <button type="button" id="edit-status-btn-dispatched" data-status="dispatched" class="edit-status-btn flex-1 py-3 text-xs font-bold uppercase border-t border-b border-r border-gray-300 focus:z-10 transition-colors bg-white text-gray-600 hover:bg-gray-50">Disponiert</button>
                            <button type="button" id="edit-status-btn-completed" data-status="completed" class="edit-status-btn flex-1 py-3 text-xs font-bold uppercase border-t border-b border-r border-gray-300 rounded-r-lg focus:z-10 transition-colors bg-white text-gray-600 hover:bg-gray-50">Fertig</button>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-white rounded-lg border border-gray-200 text-center shadow-sm">
                        <span id="edit-auto-section-display" class="text-xs font-bold text-gray-500">EA Prüfung...</span>
                    </div>

                    <div class="flex space-x-3 pt-4">
                        <button type="button" id="delete-incident-btn" class="flex-1 bg-white border border-red-200 text-red-600 hover:bg-red-50 font-bold uppercase text-xs py-3 px-4 rounded-lg">Löschen</button>
                        <button type="submit" id="save-incident-btn" class="flex-[2] btn-hero py-3 px-4 rounded-lg text-xs">Speichern</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- EA Management Modal -->
    <div id="ea-management-modal" class="modal-backdrop fixed inset-0 bg-soot-black/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="font-hero text-xl text-soot-black">EINSATZABSCHNITTE (EA)</h2>
                <button id="close-ea-modal-btn" class="text-gray-400 hover:text-soot-black p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div id="ea-modal-content" class="p-8 overflow-y-auto space-y-8">
                <form id="section-form" class="bg-gray-50 p-6 rounded-lg border border-gray-200 space-y-4 shadow-sm">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Neuen EA erstellen</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="section-name" class="bg-white border border-gray-300 text-soot-black text-sm font-medium rounded-lg p-3" placeholder="Name (z.B. Nord)" required>
                        <input type="text" id="section-responsible" class="bg-white border border-gray-300 text-soot-black text-sm font-medium rounded-lg p-3" placeholder="Leitung" required>
                    </div>
                    <div class="flex items-center space-x-3">
                        <input type="color" id="section-color" class="h-10 w-14 p-0 border-0 rounded cursor-pointer" value="#cc0000">
                        <button type="submit" class="flex-1 btn-hero py-2.5 px-4 rounded-lg text-sm">Erstellen</button>
                    </div>
                </form>
                <div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Aktive Abschnitte</h3>
                    <div id="section-list" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- End Shift Modal -->
    <div id="end-shift-modal" class="modal-backdrop fixed inset-0 bg-soot-black/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md">
            <div class="p-8">
                <div class="flex items-center justify-center w-14 h-14 mx-auto bg-gray-100 text-soot-black rounded-full mb-6">
                    <!-- Lucide: File Text -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                </div>
                <h2 class="font-hero text-2xl text-soot-black text-center mb-2">BERICHT ERSTELLEN</h2>
                <p class="text-sm text-gray-500 text-center mb-8 font-medium">Protokoll abschließen und exportieren.</p>
                
                <div class="bg-gray-50 rounded-lg p-5 mb-6 text-sm border border-gray-200">
                    <div class="flex justify-between mb-2"><span class="text-gray-500 font-medium">Datum:</span> <span id="report-stats-date" class="font-bold text-soot-black"></span></div>
                    <div class="flex justify-between mb-2"><span class="text-gray-500 font-medium">Einsätze:</span> <span id="report-stats-incidents" class="font-bold text-soot-black"></span></div>
                    <div class="flex justify-between"><span class="text-gray-500 font-medium">Abschnitte:</span> <span id="report-stats-eas" class="font-bold text-soot-black"></span></div>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">Protokollführer / Lagezeichner</label>
                    <input type="text" id="lagezeichner-input" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-fire-red focus:ring-fire-red p-3 text-sm font-medium" placeholder="Name eingeben...">
                </div>

                <div class="flex space-x-3">
                    <button id="cancel-report-btn" class="flex-1 btn-secondary py-3 rounded-lg">Zurück</button>
                    <button id="create-report-btn" class="flex-[2] btn-hero py-3 rounded-lg text-sm shadow-lg">Bericht Herunterladen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Offline Overlay -->
    <div id="offline-overlay" class="fixed inset-0 bg-soot-black flex flex-col items-center justify-center p-4 hidden">
        <div class="bg-white p-10 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col border-t-8 border-fire-red">
            <div class="text-center mb-8">
                <h2 class="font-hero text-4xl font-extrabold text-soot-black">SYSTEM OFFLINE</h2>
                <p class="text-fire-red font-bold mt-2 uppercase tracking-widest text-sm">Notfall-Protokoll: Lesezugriff</p>
            </div>
            <div class="flex-grow overflow-y-auto bg-gray-50 p-8 rounded-lg border border-gray-200 space-y-10">
                <div>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 border-b border-gray-300 pb-2">Aktive Abschnitte</h3>
                    <div id="offline-ea-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                </div>
                <div>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 border-b border-gray-300 pb-2">Einsatzprotokoll</h3>
                    <div id="offline-incident-report" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>


    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- AAO KEYWORDS ---
        const AAO_KEYWORD_CATEGORIES = {
            "B 1": ["B - Fläche klein (< 10m x 10m)", "B - Gasgeruch im Freien", "B - Kleinfeuer", "B - Müllcontainer / -tonne", "B - PKW / Kleinbus innerorts", "B - Rauch- / Brandgeruch Fahrzeug", "B - Rauch- / Brandgeruch im Freien", "B - Unklare Feuer- / Rauchentwicklung im Freien", "B - Zweirad"],
            "B 2": ["B - Alarmstufenerhöhung auf B 2", "B - Bus", "B - Campingplatz", "B - Explosion im Freien", "B - Fahrzeug sonstiges", "B - Garage / Carport / Gartenhaus", "B - Gasaustritt im Freien klein", "B - Lagerplatz klein", "B - Land- / Forst- / Baumaschine", "B - LKW / Kleintransporter", "B - Maschine", "B - mehrere PKW / Kleinbusse", "B - Person im Freien", "B - PKW / Kleinbus außerorts", "B - Spielplatz", "B - Wald klein (< 10m x 10m)", "B - Wohnmobil / Wohnanhänger"],
            "B 3": ["B - Alarmstufenerhöhung auf B 3", "B - Baustelle", "B - Bordell / Laufhaus", "B - Büro- / Bankgebäude", "B - Bus im / am Gebäude", "B - Dehnfuge", "B - Explosion Kleinobjekt im / am Gebäude", "B - Garage / Carport / Gartenhaus im / am Gebäude", "B - Gasgeruch im / am Gebäude", "B - Gaststätte / Restaurant", "B - Gewässer sonstiges", "B - Hafenanlage / Terminal / Schiffsanlegestelle", "B - Hallenbad / Freibad / Pool", "B - Industrieanlage / -betrieg - Sonstige", "B - Kamin / Heizung / Ofen", "B - Kanalisation", "B - Keller", "B - Kleinfeuer im / am Gebäude", "B - Lagerhalle / Container klein", "B - Lagerplatz groß", "B - Land- / Forst- / Baumaschine im / am Gebäude", "B - LKW / Kleintransporter im / am Gebäude", "B - mehrer PKW / Kleinbusse im / am Gebäude", "B - Müllcontainer / -tonne im / am Gebäude", "B - Öffentliches Gebäude / Objekt geschlossen", "B - Öffentliches Objekt / Gebäude sontiges", "B - Person droht sich zu verbrennen", "B - Person im Gebäude", "B - PKW / Kleinbus im / am Gebäude", "B - privates Gebäude sonstiges", "B - Rauch- / Brandgeruch im Gebäude", "B - Scheune / Stall", "B - Schleuse", "B - Terrasse / Balkon", "B - Unklare Feuer- Rauchentwicklung im / am Gebäude", "B - Volksfest / Bierzelt", "B - Werkstatt", "B - Wohn- / Baucontainer", "B -  Wohnmobiel / Wohnanhänger im / am Gebäude", "B - Wohnung", "B - Zimmer", "B - Zweirad im / am Gebäude"],
			"B 4": ["B - Alarmstufenerhöhung auf B 4", "B - Apotheke / Labor / Arztpraxis", "B - Asylheim / Wohnheim", "B - Bahnhof / Flughafen", "B - Brandausweitung", "B - Dachstuhl / Dachboden", "B - Diskothek / Spielhalle", "B - Freizeit- / Vergnügungspark", "B - Hotel / Jugendherberge", "B - Industrieanlage", "B - Kaserne / Militärische Einrichtung", "B - Kaufhaus / Ladengeschäft", "B - Kindergarten / Schule / Universität", "B - Kino / Theater / Oper", "B - Kirche / Glaubensstätte", "B - Lagerhalle / Container groß", "B - Menschenleben konkret in Gefahr", "B - Museum / Galerie", "B - Sportstation / Sporthalle", "B - Versammlungsstätte"],
			"B 5": ["B - Alarmstufenerhöhung auf B 5", "B - Alten- / Pflegeheim / Krankenhaus", "B - Gefängnis / Haftanstalt / Polizei", "B - Heizkraftwerk", "B - Hochhaus", "B - Parkhaus / Tiefgarage", "B - Sägewerk"],
			"B 6": ["B - Alarmstufenerhöhung auf B 6"],
			"B - Atom": ["B - Fahrzeug - Atom", "B - Industrieanlage / -betrieb - Atom", "B - Luftfahrzeug - Atom", "B - Öffentliches Gebäude / Objekt - Atom", "B - Schienenfahrzeug - Atom", "B - Wasserfahrzeug - Atom", "B - Kernkraftwerk"],
			"B - Bio": ["B - Bio"],
			"B - BMA": ["B - Auslösung BMA", "B - Auslösung Löschanlage","B - Private BMA", "B - Privater Rauchmelder", "B - Private Gaswarnanlage"],
			"B - Boot": ["B - Motorboot / Sportboot", "B - Rauch- / Brandgeruch Wasserfahrzeug"],
			"B - Chemie": [" B - Fahrzeug - Chemie", "B - Luftfahrzeug - Chemie", "B - Schienenfahrzeug - Chemie", "B - Industrieanlage / -betrieb - Chemie", "B - Öffentliches Gebäude / Objekt - Chemie", "B - Wasserfahrzeug - Chemie"],
			"B - Elektroanlage": ["B - Elektrizitätswerk / Trafohaus", "B - Photovoltaik / Solaranlage", "B - Strommast / Leitung"],
			"B - Explosion": ["B - Explosion Fahrzeug", "B - Explosionim / am Gebäude"],
			"B - Flüssigkeit/Gas": ["B - Biogasanlage", "B - Gasaustritt im / am Gebäude", "B - Gasaustritt im Freien groß", "B - Gasflasche", "B - Gastank / Gaslager", "B - Pipeline", "B - Raffinerie / Ölförderanlage", "B - Tanklaster", "B - Tankstelle / Tanklager"],
			"B - Metall": ["B - Metall"],
			"B - Schienentunnel": ["B - Bahnhof / Haltestelle im Untergrund", "B - Schienentunnel / Unterführung"],
			"B - Schiff": ["B - Explosion Wasserfahrzeug", "B - Fahrgastschiff / Hafenfähre", "B - Luftfahrzeug im Wasser", "B - Transportschiff", "B - Wasserfahrzeug sonstiges"],
			"B - Straßentunnel": ["B - Tunnel / Unterführung"],
			"B - Wald": ["B - Fläche groß (> 10m x 10m)", "B - Wald groß (> 10m x 10m)"],
			"B - Zug": ["B - Explosion Schienenfahrzeug", "B - Güterzug / Tankzug", "B - S-Bahn / Personenzug", "B - Schienenfahrzeug sonstiges", "B - Straßenbahn", "B - U-Bahn"],
			"S - Erkundung": ["S - Bomben- / Kampfmittelfund", "S - Nachschau", "TH - Leichenbergung", "TH - Person vermisst / Personensuche"],
			"S - First Responder": ["S - First Responder"],
            "S - Sonstiges": ["S - Ausfall Notruf / Alarmierung", "S - Bedrohungslage", "S - Bereitstellungsraum besetzen", "S - Bombendrohung", "S - Drohendes Attentat", "S - Einsatzalarm überörtlich (ca. 12h)", "S - Einsatzalarm überregional (ca. 24h)", "S - Einsatzbereitschaft herstellen", "S - Führungshaus besetzen", "S - Große Polizeilage (Amok / Terror)", "S - Grundschutz sicherstellen", "S - Maßnahmenstufe 1", "S - Maßnahmenstufe 2", "S - Maßnahmenstufe 3", "S - Stabseinsatz", "S - Vorabinformation / Einsatzanfrage", "S - Voralarm überörtlich (ca. 12h)", "S - Voralarm überregional (ca. 24h)", "S - Wachbesetzung", "S - Überlandhilfe Feuerwehr (außerhalb SK & LK KA)"],
			"TH 1": ["TH - Ast / Baum droht zu fallen", "TH - Ast / Baum entfernen", "TH - Fahrbahn reinigen / aufräumen", "TH - Insekten (Bienen / Hornissen / Hummeln / Wespen)", "TH - Sicherungsarbeiten", "TH - Sonstige Hilfeleistung", "TH - Tierrettung klein", "TH - Tür / Fenster verschließen", "TH - Unfallstelle absichern / ausleuchten", "TH - Verkehrszeichen entfernen", "TH - Wasserschaden"],
			"TH 2": ["TH - Fahrzeug Sicherung / Bergung klein", "TH - Kleineinklemmung", "TH - Person eingeschlossen", "TH - Person eingeschlossen - Aufzug", "TH - Person eingeschlossen - Aufzug + NA", "TH - Person eingeschlossen - Fahrzeug", "TH - Person eingeschlossen - Fahrzeug + NA", "TH - Strom- / Elektrounfall klein", "TH - Unterstützung Rettungsdienst", "TH - Verkehrsunfall (RD - VU mit SoSi)", "TH - Verkehrsunfall ( RD - VU Stufe 1", "TH - Verkehrsunfall (RD - VU Stufe 2)", "TH - Verkehrsunfall (RD - VU Stufe 3)", "TH - Verkehrsunfall (RD - VU Stufe 4)", "TH - VU eCall (Situation unklar)"],
			"TH 3": ["TH - Notfalltüröffnung", "TH - Notfalltüröffnung + NA", "TH - Türöffnung"],
			"TH 4": ["B - Fahrzeug - Menschenleben konkret in Gefahr", "TH - Fahrzeug Sicherung / Bergung groß", "TH - Person eingeklemmt", "TH - Person eingeklemmt - Ast / Baum", "TH - Person eingeklemmt - PKW / Kleinbus", "TH - Person eingeklemmt - Tor / Gerüst / Gestänge", "TH - Person gepfählt", "TH - Strom- / Elektrounfall groß", "TH - Tierrettung groß", "TH - Verkehrsunfall (RD - VU Stufe 5)", "TH - Verkehrsunfall ( RD - VU Stufe 6)", "TH - VU PKW - Person eingeklemmt"],
			"TH 5": ["TH - Baukran droht umzustürzen", "TH - Fahrzeug in Menschenmenge", "TH - Person eingeklemmt - Gebäude", "TH - TH - Person eingeklemmt - Kraftfahrzeug / Maschine", "TH - Person eingeklemmt - LKW / Kleintransporter", "TH - Person eingeklemmt - Maschine / Gerät", "TH - VU LKW - Person eingeklemmt", "TH - TH VU PKW - Personen eingeklemmt (2 bis 5)"],
			"TH 6": ["TH - VU Bus - Person eingeklemmt", "TH - VU LKW - Person eingeklemmt", "TH - VU Massenkarambolage", "TH - VU PKW - Personen eingeklemmt (mehr als 5)"],
			"TH 7": ["B - Gebäude eingestürzt", "TH - Baukran umgestürzt", "TH - Einsturz Gerüst / Gebäude / Verkehrsweg", "TH - Gebäude / Fahrzeug verschüttet", "TH - Person verschüttet"],
			"TH - Beleuchtung": ["TH - Einsatzstelle ausleuchten", "TH - Hubschrauberlandung ausleuchten"],
			"TH - Höhenrettung": ["B - Windkraftwerk / -rad", "TH - Höhlen / Grubenrettung", "TH - Person auf Windkraftanlage", "TH - Person droht zu springen / abzustürzen über 23m", "TH - Person im Seil über 23m", "TH - SRHT über 23m"],
			"TH - Person im Rhein": ["TH - Person im Rhein"],
			"TH - Person im Wasser": ["TH - Eisrettung", "TH - Ertrinkungsunfall / Person im Wasser", "TH - Tauchunfall", "TH - VU Fahrzeug im Wasser (Person in Gefahr)", "TH - Wassersportler / -fahrzeug in Not"],
			"TH - Rettungskorb schwer": ["TH - Unterstützung Rettungsdienst mit Drehleiter (über 130kg)"],
			"TH - Schiene 1": ["TH - Person unter güterzug / Tankzug", "TH - Person unter S-Bahn / Personenzug", "TH - Person unter sonstigem Schienenfahrzeug", "TH - Person unter Straßenbahn", "TH - Person unter U-Bahn", "TH - Sicherung / Bergung Schienenfahrzeug"],
			"TH - Schiene 2": ["TH - Person eingeklemmt - Schienenfahrzeug", "TH - VU Güterzug / Tankzug", "TH - VU S-Bahn / Personenzug", "TH - VU Schienenfahrzeug sonstiges", "TH - VU Straßenbahn", "TH - VU U-Bahn"],
			"TH - Schlüsseldienst": ["TH - Türöffnung (Amtshilfe)"],
			"TH U - Atom": ["TH U - Austretender Gefahrstoff - Atom", "TH U - Fahrzeug - Atom", "TH U - Luftfahrzeug - Atom", "TH U - Schienenfahrzeug - Atom", "TH U - Wasserfahrzeug - Atom"],
			"TH U - Auslaufen von Kraftstoffen groß": ["TH U - Austretende Betriebsstoffe Gewässer", "TH U - Austretende Betriebsstoffe groß", "TH U - Austretender Gefahrstoff klein"],
			"TH U - Auslaufen von Kraftstoffen klein": ["TH U - Austretende Betriebsstoffe klein"],
			"TH U - Bio": ["TH U - Bio"],
			"TH U - Chemie": ["TH U - Austretender Gefahrstoff Gewässer", "TH U - Austretender Gefahrstoff groß", "TH U - Fahrzeug - Chemie", "TH U - Luftfahrzeug - Chemie", "TH U - Schienenfahrzeug - Chemie", "TH U - Wasserfahrzeug - Chemie"],
			"TH U - Messeinsatz groß": ["TH U - Messeinsatz groß"],
			"TH U - Messeinsatz klein": ["TH U - Geruch (Messeinsatz)", "TH U - Gewässerverunreinigung"],
			"TH VU - Boot": ["TH - Sicherung / Bergung Wasserfahrzeug", "TH - VU Motorboot / Sportboot"],
			"TH VU - Flugzeug 1": ["B - Kleinflugzeug / Hubschrauber", "B - Zeppelin / Ballon", "TH - Sicherung / Bergung Luftfahrzeug", "TH - VU Kleinflugzeug / Hubschrauber", "TH - VU Zeppelin / Ballon"],
			"TH VU - Flugzeug 2": ["B - Explosion Luftfahrzeug", "B - Luftfahrzeug sonstiges", "B - Passagier- / Verkehrsflugzeug", "B - Transport- / Militärflugzeug", "TH - VU Luftfahrzeug sonstiges", "TH - VU Passagier- / Verkehrsflugzeug", "TH - VU Transport- / Militärflugzeug"],
			"TH VU - Schiff": ["TH - VU Fahrgastschiff / Hafenfähre", "TH - VU Luftfahrzeug im Wasser", "TH - VU Transportschiff", "TH - VU Wasserfahrzeug sonstiges"],
        };

        // --- UTILITIES ---
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function getCategoryColors(categoryName) {
            if (categoryName.startsWith("TH")) return { header: 'text-blue-800 bg-blue-50 border-blue-200', hover: 'hover:bg-blue-50' };
            if (categoryName.startsWith("B")) return { header: 'text-red-800 bg-red-50 border-red-200', hover: 'hover:bg-red-50' };
            return { header: 'text-gray-800 bg-gray-100 border-gray-200', hover: 'hover:bg-gray-200' };
        }

        function hexToRgba(hex, alpha) {
            let r = 0, g = 0, b = 0;
            if (hex.length == 7) {
                r = parseInt(hex.slice(1, 3), 16);
                g = parseInt(hex.slice(3, 5), 16);
                b = parseInt(hex.slice(5, 7), 16);
            }
            return `rgba(${r},${g},${b},${alpha})`;
        }
        
        function formatGermanAddress(address) {
            const parts = [];
            const street = address.road || '';
            const houseNumber = address.house_number || '';
            const postcode = address.postcode || '';
            const city = address.city || address.town || address.village || '';
            if (street) parts.push(`${street} ${houseNumber}`.trim());
            if (postcode && city) parts.push(`${postcode} ${city}`);
            else if (city && !parts.includes(city)) parts.push(city);
            const finalAddress = parts.join(', ');
            return finalAddress || address.display_name;
        }

        function getPoiName(address) {
            const keys = ['amenity', 'leisure', 'shop', 'tourism', 'historic', 'building', 'office', 'emergency', 'craft'];
            for (const key of keys) {
                if (address[key]) return address[key];
            }
            return null;
        }

        // --- DATA STATE ---
        const incidents = new Map();
        const sections = new Map();
        const markers = new Map();
        const sectionPolygons = new Map();
        let statusHistory = [];
        
        let selectedIncidentId = null;
        let editingIncidentId = null;
        let drawingSectionId = null;
        let currentDrawPoints = [];
        const currentDrawLayer = new L.LayerGroup();
        let currentVertexMarkers = [];
        let currentPolyline = null;
        let currentSnapMarkers = []; 
        
        let isIncidentAddMode = false;
        let isIncidentEditMode = false;
        let currentSortCriteria = 'createdAt';
        let currentSearchTerm = '';
        let isCompletedSectionOpen = false;
        let isActiveSectionOpen = true;
        let debounceTimer;
        let pendingIncident = null;

        // --- MAP SETUP ---
        const map = L.map('map', { zoomControl: false }).setView([49.123, 8.404], 14);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 19
        }).addTo(map);

        currentDrawLayer.addTo(map);

        // --- DOM ELEMENTS ---
        const els = {
            sidebar: document.getElementById('sidebar-container'),
            incidentList: document.getElementById('incident-list'),
            completedIncidentList: document.getElementById('completed-incident-list'),
            toastContainer: document.getElementById('toast-container'),
            incidentAddPanel: document.getElementById('incident-add-panel'),
            incidentEditPanel: document.getElementById('incident-edit-panel'),
            sectionDrawPanel: document.getElementById('section-draw-panel'),
            searchInput: document.getElementById('incident-search'),
            modals: {
                create: document.getElementById('incident-creation-modal'),
                edit: document.getElementById('incident-edit-modal'),
                ea: document.getElementById('ea-management-modal'),
                end: document.getElementById('end-shift-modal'),
                offline: document.getElementById('offline-overlay'),
                duplicate: document.getElementById('duplicate-warning-modal')
            },
            inputs: {
                address: document.getElementById('address'),
                keyword: document.getElementById('keyword'),
                lat: document.getElementById('lat-input'),
                lon: document.getElementById('lon-input'),
                locName: document.getElementById('location-name-input'),
                editAddress: document.getElementById('edit-address'),
                editKeyword: document.getElementById('edit-keyword'),
                editLat: document.getElementById('edit-lat-input'),
                editLon: document.getElementById('edit-lon-input'),
                editLocName: document.getElementById('edit-location-name-input'),
                suggestions: document.getElementById('address-suggestions'),
                editSuggestions: document.getElementById('edit-address-suggestions'),
                keywordSuggestions: document.getElementById('keyword-suggestions'),
                editKeywordSuggestions: document.getElementById('edit-keyword-suggestions'),
                editEaSelect: document.getElementById('edit-ea-select')
            }
        };
        
        const toggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebar = document.getElementById('sidebar-container');
        const icon = document.getElementById('sidebar-toggle-icon');

        toggleBtn.addEventListener('click', () => {
            // Toggle the sidebar width and padding classes
            if (sidebar.classList.contains('md:w-0')) {
                // Expand
                sidebar.classList.remove('md:w-0', 'w-0', 'overflow-hidden', 'p-0');
                sidebar.classList.add('md:w-[480px]'); 
                toggleBtn.classList.remove('md:left-0');
                toggleBtn.classList.add('md:left-[480px]');
                icon.innerHTML = '<path d="m15 18-6-6 6-6"/>'; // Left chevron
            } else {
                // Collapse
                sidebar.classList.add('md:w-0', 'w-0', 'overflow-hidden', 'p-0');
                sidebar.classList.remove('md:w-[480px]');
                toggleBtn.classList.remove('md:left-[480px]');
                toggleBtn.classList.add('md:left-0');
                icon.innerHTML = '<path d="m9 18 6-6-6-6"/>'; // Right chevron
            }
            setTimeout(() => map.invalidateSize(), 300);
        });


        // --- GEO & LOGIC FUNCTIONS ---
        async function geocodeAddress(query) {
            if (!query || !navigator.onLine) return [];
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=de&addressdetails=1&limit=10&viewbox=8.3,49.0,8.5,49.25`);
                const data = await response.json();
                const validData = data.filter(place => place.address);
                validData.sort((a, b) => {
                    const postA = a.address.postcode || '';
                    const postB = b.address.postcode || '';
                    const aIsLiHo = postA === '76351';
                    const bIsLiHo = postB === '76351';
                    if (aIsLiHo && !bIsLiHo) return -1;
                    if (!aIsLiHo && bIsLiHo) return 1;
                    return 0;
                });
                return validData;
            } catch (error) { return []; }
        }

        async function reverseGeocode(lat, lon) {
            if (!navigator.onLine) return null;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`);
                const data = await response.json();
                if (data && data.address) {
                    return { 
                        formattedAddress: formatGermanAddress(data.address), 
                        lat: lat, 
                        lon: lon,
                        poiName: getPoiName(data.address)
                    };
                }
                return null;
            } catch (e) { return null; }
        }

        function isPointInPolygon(point, polygon) {
            const x = point[0], y = point[1];
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                let xi = polygon[i][0], yi = polygon[i][1];
                let xj = polygon[j][0], yj = polygon[j][1];
                let intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        function findContainingSection(lat, lon) {
            let foundId = null;
            sections.forEach(section => {
                if (section.boundary && section.boundary.length >= 3) {
                    if (isPointInPolygon([lat, lon], section.boundary)) foundId = section.id;
                }
            });
            return foundId;
        }

        function orientation(p, q, r) {
            const val = (q[0] - p[0]) * (r[1] - q[1]) - (q[1] - p[1]) * (r[0] - q[0]);
            if (Math.abs(val) < 1e-9) return 0;
            return (val > 0) ? 1 : 2;
        }
        function onSegment(p, q, r) {
            return (q[0] <= Math.max(p[0], r[0]) && q[0] >= Math.min(p[0], r[0]) &&
                    q[1] <= Math.max(p[1], r[1]) && q[1] >= Math.min(p[1], r[1]));
        }
        function segmentsIntersect(p1, q1, p2, q2) {
            if ((p1[0]===p2[0] && p1[1]===p2[1]) || (p1[0]===q2[0] && p1[1]===q2[1]) || 
                (q1[0]===p2[0] && q1[1]===p2[1]) || (q1[0]===q2[0] && q1[1]===q2[1])) return false;
            const o1 = orientation(p1, q1, p2);
            const o2 = orientation(p1, q1, q2);
            const o3 = orientation(p2, q2, p1);
            const o4 = orientation(p2, q2, q1);
            if (o1 !== 0 && o2 !== 0 && o3 !== 0 && o4 !== 0 && o1 !== o2 && o3 !== o4) return true;
            return false;
        }
        
        function checkExistingEAOverlaps(newBoundary, excludeSectionId) {
            let intersectionFound = false;
            sections.forEach(section => {
                if (section.id === excludeSectionId || !section.boundary || section.boundary.length < 3) return;
                const existingBoundary = section.boundary;
                for (let i = 0; i < newBoundary.length; i++) {
                    const p1 = newBoundary[i];
                    const q1 = newBoundary[(i + 1) % newBoundary.length];
                    for (let j = 0; j < existingBoundary.length; j++) {
                        const p2 = existingBoundary[j];
                        const q2 = existingBoundary[(j + 1) % existingBoundary.length];
                        if (segmentsIntersect(p1, q1, p2, q2)) { intersectionFound = true; break; }
                    }
                    if (intersectionFound) break;
                }
            });
            return intersectionFound;
        }
        
        function recalculateSectionAssignments() {
            incidents.forEach(inc => {
                if (inc.status !== 'completed' && !inc.isManualSection) {
                    const secId = findContainingSection(inc.lat, inc.lon);
                    if (secId !== inc.sectionId) {
                        inc.sectionId = secId;
                        incidents.set(inc.id, inc);
                    }
                }
            });
            renderIncidents();
        }

        function showMessage(msg, isError = false, duration = 4000) {
            const toast = document.createElement('div');
            // Styled for Modern Heroism Theme
            const colorClass = isError ? 'bg-white border-l-4 border-fire-red text-gray-800' : 'bg-white border-l-4 border-green-600 text-gray-800';
            const icon = isError ? 
                `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-circle mr-3 text-fire-red"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>` :
                `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle mr-3 text-green-600"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`;
            toast.className = `toast-notification pointer-events-auto flex items-center p-4 rounded shadow-hero mb-3 text-sm font-bold font-sans ${colorClass}`;
            toast.innerHTML = `${icon} <span>${msg}</span>`;
            const closeBtn = document.createElement('button');
            closeBtn.className = "ml-auto text-gray-400 hover:text-gray-600";
            closeBtn.innerHTML = `&times;`;
            closeBtn.onclick = () => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); };
            toast.appendChild(closeBtn);
            els.toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            if (duration > 0) setTimeout(() => closeBtn.click(), duration);
        }

        function saveState() {
            localStorage.setItem('v4_incidents', JSON.stringify(Array.from(incidents.values())));
            localStorage.setItem('v4_sections', JSON.stringify(Array.from(sections.values())));
            localStorage.setItem('v4_history', JSON.stringify(statusHistory));
            updateUndoButton();
        }

        function loadState() {
            try {
                const rawInc = localStorage.getItem('v4_incidents');
                if (rawInc) JSON.parse(rawInc).forEach(i => incidents.set(i.id, i));
                const rawSec = localStorage.getItem('v4_sections');
                if (rawSec) JSON.parse(rawSec).forEach(s => sections.set(s.id, s));
                const rawHist = localStorage.getItem('v4_history');
                if (rawHist) statusHistory = JSON.parse(rawHist);
            } catch(e) { console.error("Load error", e); }
            renderAll();
        }

        // --- RENDERING ---
        function renderIncidents() {
            els.incidentList.innerHTML = '';
            els.completedIncidentList.innerHTML = '';
            markers.forEach(m => map.removeLayer(m));
            markers.clear();

            let activeArray = Array.from(incidents.values()).filter(i => i.status !== 'completed');
            let completedArray = Array.from(incidents.values()).filter(i => i.status === 'completed');

            if (currentSearchTerm) {
                const lower = currentSearchTerm.toLowerCase();
                const filterFn = (i) => {
                    const sec = sections.get(i.sectionId);
                    const secName = sec ? sec.name.toLowerCase() : '';
                    return i.keyword.toLowerCase().includes(lower) || 
                           i.formattedAddress.toLowerCase().includes(lower) ||
                           (i.locationName && i.locationName.toLowerCase().includes(lower)) ||
                           (i.notes && i.notes.toLowerCase().includes(lower)) ||
                           secName.includes(lower);
                };
                activeArray = activeArray.filter(filterFn);
                completedArray = completedArray.filter(filterFn);
            }

            const sortFn = (a, b) => {
                if (currentSortCriteria === 'createdAt') return new Date(b.createdAt) - new Date(a.createdAt);
                if (currentSortCriteria === 'status') return a.status.localeCompare(b.status);
                if (currentSortCriteria === 'keyword') return a.keyword.localeCompare(b.keyword);
                return 0;
            };
            activeArray.sort(sortFn);
            completedArray.sort(sortFn);

            let hasActive = false;
            
            const renderItem = (inc, container) => {
                const isCompleted = inc.status === 'completed';
                const section = sections.get(inc.sectionId);
                // UPDATED PIN COLORS
                const color = isCompleted ? '#d97706' : (inc.status === 'dispatched' ? '#2563eb' : '#cc0000');
                
                if (inc.lat) {
                    const isSelected = selectedIncidentId === inc.id;
                    const iconHtml = `<div style="background:${color}; width:16px; height:16px; border:2px solid ${isSelected ? '#fff' : '#fff'}; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.4); transform: scale(${isSelected ? 1.5 : 1}); transition: all 0.2s;"></div>`;
                    const marker = L.marker([inc.lat, inc.lon], {
                        icon: L.divIcon({ html: iconHtml, className: 'bg-transparent', iconSize: [24,24] }),
                        zIndexOffset: isSelected ? 1000 : 0
                    }).addTo(map);
                    
                    marker.bindTooltip(inc.keyword, { direction: 'top', offset: [0, -10], className: 'bg-white text-soot-black border-0 shadow-lg font-bold font-sans' });
                    
                    marker.on('click', () => {
                        selectedIncidentId = inc.id;
                        renderIncidents();
                        map.flyTo([inc.lat, inc.lon], 15);
                    });
                    
                    // REMOVED DOUBLE CLICK EVENT

                    markers.set(inc.id, marker);
                }

                const el = document.createElement('div');
                const isSelected = selectedIncidentId === inc.id;
                const statusBorder = inc.status === 'open' ? 'border-fire-red' : (inc.status === 'dispatched' ? 'border-police-blue' : 'border-alert-amber');
                const bgClass = isSelected ? 'incident-selected' : 'bg-white border-gray-100 hover:bg-gray-50 shadow-sm';
                
                el.className = `p-4 rounded-lg border-l-[6px] transition-all cursor-pointer ${statusBorder} ${bgClass}`;
                
                const locNameHtml = inc.locationName ? `<div class="text-xs font-bold text-fire-red mb-1 uppercase tracking-wider flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin mr-1"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>${inc.locationName}</div>` : '';

                el.innerHTML = `
                    ${locNameHtml}
                    <div class="flex justify-between items-start">
                        <h4 class="font-hero text-lg text-soot-black leading-tight">${inc.keyword}</h4>
                        <span class="text-[10px] font-mono text-gray-400 mt-1">${new Date(inc.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                    <p class="text-gray-600 text-sm mt-1 font-medium">${inc.formattedAddress}</p>
                    <div class="flex items-center justify-between mt-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded ${inc.status === 'open' ? 'status-badge-open' : (inc.status === 'dispatched' ? 'status-badge-dispatched' : 'status-badge-completed')}">
                                ${inc.status === 'open' ? 'Offen' : (inc.status === 'dispatched' ? 'Disponiert' : 'Abgeschlossen')}
                            </span>
                            ${section ? `<span class="text-[10px] px-2 py-0.5 rounded bg-gray-100 text-gray-600 border border-gray-200 font-bold uppercase" style="border-left-color:${section.color}; border-left-width:4px;">${section.name}</span>` : ''}
                            ${inc.isManualSection ? `<span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 font-bold" title="Manual Override">M</span>` : ''}
                        </div>
                        <button class="edit-inc-btn text-gray-300 hover:text-fire-red transition-colors" data-id="${inc.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                    </div>
                    ${isSelected ? `
                        <div class="mt-4 pt-4 border-t border-gray-200 animate-slide-in">
                            <label class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-2 block">Notizen & Maßnahmen</label>
                            <textarea class="w-full text-sm bg-gray-50 border border-gray-200 text-soot-black rounded p-3 mb-3 focus:ring-1 focus:ring-fire-red focus:border-fire-red transition-shadow" rows="3" onchange="updateNote('${inc.id}', this.value)" placeholder="Details eingeben...">${inc.notes || ''}</textarea>
                            <div class="flex space-x-2">
                                ${inc.status === 'open' ? `<button onclick="updateStatus('${inc.id}', 'dispatched')" class="flex-1 bg-soot-black text-white py-2 rounded text-xs font-bold uppercase tracking-wide hover:bg-black transition-colors">Disponieren</button>` : ''}
                                ${inc.status !== 'completed' ? `<button onclick="updateStatus('${inc.id}', 'completed')" class="flex-1 bg-gray-200 text-gray-600 py-2 rounded text-xs font-bold uppercase tracking-wide hover:bg-gray-300 transition-colors">Abschließen</button>` : ''}
                            </div>
                        </div>
                    ` : ''}
                `;
                
                el.onclick = (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'TEXTAREA' || e.target.closest('.edit-inc-btn')) return;
                    selectedIncidentId = isSelected ? null : inc.id;
                    renderIncidents();
                    if(selectedIncidentId && inc.lat) map.setView([inc.lat, inc.lon], 15);
                };

                const editBtn = el.querySelector('.edit-inc-btn');
                if(editBtn) editBtn.onclick = () => loadEditModal(inc.id);
                
                container.appendChild(el);
            };

            activeArray.forEach(i => renderItem(i, els.incidentList));
            if(activeArray.length > 0) hasActive = true;

            if (isCompletedSectionOpen) {
                completedArray.forEach(i => renderItem(i, els.completedIncidentList));
            }

            if (!hasActive) els.incidentList.innerHTML = '<div class="text-center py-12 border-2 border-dashed border-gray-200 rounded-lg"><p class="text-gray-400 text-sm font-medium uppercase tracking-wide">Keine Aktiven Einsätze</p></div>';
        }

        function renderPolygons() {
            sectionPolygons.forEach(l => map.removeLayer(l));
            sectionPolygons.clear();
            sections.forEach(sec => {
                if (sec.boundary && sec.boundary.length >= 3) {
                    const poly = L.polygon(sec.boundary, { color: sec.color, fillColor: sec.color, fillOpacity: 0.15, weight: 3 }).addTo(map);
                    poly.bindTooltip(`<span style="color:${sec.color}">${sec.name}</span>`, {permanent:true, direction:'center', className:'ea-label'});
                    sectionPolygons.set(sec.id, poly);
                }
            });
        }

        function renderEAControl() {
            const list = document.getElementById('section-list');
            list.innerHTML = '';
            sections.forEach(sec => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-white border border-gray-200 rounded-lg shadow-sm';
                div.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="w-4 h-4 rounded-full ring-2 ring-offset-2 ring-gray-100" style="background:${sec.color};"></div>
                        <div>
                            <p class="text-sm font-bold text-soot-black font-hero">${sec.name}</p>
                            <p class="text-xs text-gray-500 font-medium">${sec.responsible}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="setDrawMode(true, '${sec.id}')" class="p-2 text-gray-400 hover:text-police-blue hover:bg-blue-50 rounded transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                        <button onclick="deleteSection('${sec.id}')" class="p-2 text-gray-400 hover:text-fire-red hover:bg-red-50 rounded transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button>
                    </div>`;
                list.appendChild(div);
            });
        }

        function renderAll() {
            renderIncidents();
            renderPolygons();
            renderEAControl();
            document.querySelectorAll('.sort-btn').forEach(b => {
                if (b.dataset.sort === currentSortCriteria) {
                    b.classList.remove('text-gray-500', 'hover:bg-white', 'hover:text-soot-black');
                    b.classList.add('bg-soot-black', 'text-white', 'shadow-md');
                } else {
                    b.classList.remove('bg-soot-black', 'text-white', 'shadow-md');
                    b.classList.add('text-gray-500', 'hover:bg-white', 'hover:text-soot-black');
                }
            });
        }

        // --- AUTOCOMPLETE LOGIC ---
        function renderKeywordAutocomplete(query, container, inputElement, callback) {
            container.innerHTML = '';
            if (query.length < 2) { container.classList.add('hidden'); return; }
            
            let hasMatches = false;
            for (const category in AAO_KEYWORD_CATEGORIES) {
                const keywords = AAO_KEYWORD_CATEGORIES[category];
                const catMatch = category.toLowerCase().includes(query);
                let matches = catMatch ? keywords : keywords.filter(k => k.toLowerCase().includes(query));
                
                if (matches.length > 0) {
                    hasMatches = true;
                    const colors = getCategoryColors(category);
                    const header = document.createElement('div');
                    header.textContent = category;
                    header.className = `p-3 mt-1 font-bold text-xs uppercase border-t border-gray-100 ${colors.header}`;
                    container.appendChild(header);
                    
                    matches.forEach(kw => {
                        const item = document.createElement('div');
                        item.textContent = kw;
                        item.className = `p-3 cursor-pointer ${colors.hover} text-sm text-gray-700 pl-5 transition-colors font-medium`;
                        item.onclick = () => {
                            inputElement.value = kw;
                            container.classList.add('hidden');
                            if (callback) callback();
                        };
                        container.appendChild(item);
                    });
                }
            }
            if (hasMatches) container.classList.remove('hidden');
            else container.classList.add('hidden');
        }

        function setupAddressAutocomplete(inputId, suggestionId, latId, lonId, displayId, locNameId) {
            const inp = document.getElementById(inputId);
            const sug = document.getElementById(suggestionId);
            
            inp.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                const query = inp.value;
                if (query.length < 3) { sug.classList.add('hidden'); return; }
                
                debounceTimer = setTimeout(async () => {
                    const data = await geocodeAddress(query);
                    sug.innerHTML = '';
                    if (data.length > 0) {
                        sug.classList.remove('hidden');
                        data.forEach(d => {
                            const item = document.createElement('div');
                            const fmt = formatGermanAddress(d.address);
                            const isLiHo = d.address.postcode === '76351';
                            item.textContent = fmt;
                            item.className = `p-3 cursor-pointer hover:bg-gray-50 text-sm ${isLiHo ? 'text-fire-red font-bold' : 'text-gray-700'} border-b border-gray-100 last:border-0`;
                            item.onclick = () => {
                                inp.value = fmt;
                                document.getElementById(latId).value = d.lat;
                                document.getElementById(lonId).value = d.lon;
                                const poi = getPoiName(d.address);
                                if(locNameId) document.getElementById(locNameId).value = poi || '';
                                sug.classList.add('hidden');
                                updateSectionDisplay(displayId, parseFloat(d.lat), parseFloat(d.lon));
                                if (inputId === 'address') validateCreateForm();
                            };
                            sug.appendChild(item);
                        });
                    } else { sug.classList.add('hidden'); }
                }, 300);
            });
        }

        function updateSectionDisplay(elId, lat, lon) {
            const el = document.getElementById(elId);
            const secId = findContainingSection(lat, lon);
            if (secId) {
                const sec = sections.get(secId);
                el.innerHTML = `<span style="color:${sec.color}" class="uppercase tracking-wide">${sec.name}</span> <span class="text-gray-400 font-normal ml-1">(${sec.responsible})</span>`;
            } else {
                el.innerHTML = `<span class="text-gray-400 italic font-normal">Keinem EA zugeordnet</span>`;
            }
        }

        // --- DRAWING LOGIC ---
        function setDrawMode(active, id) {
            drawingSectionId = active ? id : null;
            currentSnapMarkers.forEach(m => map.removeLayer(m));
            currentSnapMarkers = [];
            if (active) {
                document.body.classList.add('cursor-crosshair');
                map.getContainer().classList.add('map-draw-mode');
                els.sectionDrawPanel.classList.remove('hidden');
                els.modals.ea.classList.add('hidden');
                
                sections.forEach(sec => {
                    if (sec.id !== id && sec.boundary) {
                        sec.boundary.forEach(pt => {
                            const sm = L.divIcon({ className: 'leaflet-snap-icon' });
                            const m = L.marker(pt, { icon: sm, interactive: false }).addTo(map);
                            currentSnapMarkers.push(m);
                        });
                    }
                });

                currentDrawPoints = sections.get(id).boundary ? [...sections.get(id).boundary] : [];
                redrawDrawLayer();
            } else {
                document.body.classList.remove('cursor-crosshair');
                map.getContainer().classList.remove('map-draw-mode');
                els.sectionDrawPanel.classList.add('hidden');
                currentDrawLayer.clearLayers();
                renderAll();
                openModal('ea');
            }
        }

        function redrawDrawLayer() {
            currentDrawLayer.clearLayers();
            if (currentDrawPoints.length > 0) {
                if (currentDrawPoints.length >= 3) {
                    const sec = sections.get(drawingSectionId);
                    L.polygon(currentDrawPoints, { color: sec.color, fillColor: sec.color, fillOpacity: 0.3, weight: 3, dashArray: '10, 10' }).addTo(currentDrawLayer);
                } else {
                    L.polyline(currentDrawPoints, { color: '#cc0000', weight: 3, dashArray: '10, 10' }).addTo(currentDrawLayer);
                }
                currentDrawPoints.forEach((p, idx) => {
                    const m = L.marker(p, { icon: L.divIcon({ className: 'leaflet-drawing-icon' }), draggable: true }).addTo(currentDrawLayer);
                    m.on('drag', e => { 
                        currentDrawPoints[idx] = [e.target.getLatLng().lat, e.target.getLatLng().lng]; 
                        // Visual update logic
                        const layers = currentDrawLayer.getLayers();
                         layers.forEach(l => {
                            if (l instanceof L.Polyline) l.setLatLngs(currentDrawPoints);
                        });
                    }); 
                    m.on('click', (e) => { L.DomEvent.stopPropagation(e); if(idx===0 && currentDrawPoints.length>=3) finishDrawing(); else { currentDrawPoints.splice(idx, 1); redrawDrawLayer(); } });
                });
            }
        }

        function finishDrawing() {
            if (currentDrawPoints.length < 3) return showMessage("Min. 3 Punkte erforderlich", true);
            if (checkExistingEAOverlaps(currentDrawPoints, drawingSectionId)) return showMessage("Überlappung mit anderem EA erkannt!", true);
            const s = sections.get(drawingSectionId);
            s.boundary = [...currentDrawPoints];
            sections.set(drawingSectionId, s);
            saveState(); 
            setDrawMode(false); 
            recalculateSectionAssignments(); 
            showMessage("Abschnitt gespeichert", false);
        }

        map.on('click', async (e) => {
            if (isIncidentAddMode) { handleGeoSelect(e.latlng, 'create'); } 
            else if (isIncidentEditMode) { handleGeoSelect(e.latlng, 'edit'); } 
            else if (drawingSectionId) {
                let lat = e.latlng.lat, lng = e.latlng.lng;
                const clickPt = map.latLngToContainerPoint(e.latlng);
                let snapped = false;
                if (currentDrawPoints.length >= 3 && clickPt.distanceTo(map.latLngToContainerPoint(currentDrawPoints[0])) < 20) { finishDrawing(); return; }
                sections.forEach(sec => {
                    if (sec.id !== drawingSectionId && sec.boundary) {
                        sec.boundary.forEach(pt => {
                            if (clickPt.distanceTo(map.latLngToContainerPoint(pt)) < 20) { lat = pt[0]; lng = pt[1]; snapped = true; }
                        });
                    }
                });
                if (snapped) showMessage("An Eckpunkt angedockt", false, 1000);
                currentDrawPoints.push([lat, lng]);
                redrawDrawLayer();
            } else { selectedIncidentId = null; renderIncidents(); }
        });

        async function handleGeoSelect(latlng, mode) {
            const panel = mode === 'create' ? els.incidentAddPanel : els.incidentEditPanel;
            panel.querySelector('p').textContent = "Lade Adresse...";
            const data = await reverseGeocode(latlng.lat, latlng.lng);
            if (data) {
                if (mode === 'create') {
                    els.inputs.address.value = data.formattedAddress;
                    els.inputs.lat.value = data.lat;
                    els.inputs.lon.value = data.lon;
                    els.inputs.locName.value = data.poiName || '';
                    updateSectionDisplay('auto-section-display', parseFloat(data.lat), parseFloat(data.lon));
                    setIncidentAddMode(false);
                    openModal('create');
                    validateCreateForm();
                } else {
                    els.inputs.editAddress.value = data.formattedAddress;
                    els.inputs.editLat.value = data.lat;
                    els.inputs.editLon.value = data.lon;
                    updateSectionDisplay('edit-auto-section-display', parseFloat(data.lat), parseFloat(data.lon));
                    setIncidentEditMode(false);
                    openModal('edit');
                }
                showMessage("Ort übernommen", false);
            } else { showMessage("Adresse nicht gefunden", true); }
            panel.querySelector('p').textContent = "Auf Karte klicken.";
        }

        // --- INTERACTION HANDLERS ---
        window.updateStatus = (id, status) => {
            const inc = incidents.get(id);
            statusHistory.push({ id, oldStatus: inc.status, newStatus: status });
            inc.status = status;
            incidents.set(id, inc);
            saveState(); renderAll(); updateUndoButton();
        };
        window.updateNote = (id, val) => {
            const inc = incidents.get(id);
            inc.notes = val;
            incidents.set(id, inc);
            saveState();
        };
        window.deleteSection = (id) => {
            if(confirm("Diesen Abschnitt löschen?")) { 
                sections.delete(id); 
                saveState(); 
                recalculateSectionAssignments(); 
                renderAll(); 
            }
        };
        function updateUndoButton() { document.getElementById('undo-btn').disabled = statusHistory.length === 0; }
        
        document.getElementById('undo-btn').onclick = () => {
            const last = statusHistory.pop();
            if (last) {
                const inc = incidents.get(last.id);
                if (inc) { inc.status = last.oldStatus; incidents.set(last.id, inc); saveState(); renderAll(); updateUndoButton(); showMessage("Rückgängig erfolgreich"); }
            }
        };

        // --- FORMS & MODALS ---
        function openModal(name) {
            els.modals[name].classList.remove('hidden');
            if(name === 'ea') renderEAControl();
            if(name === 'end') {
                document.getElementById('report-stats-date').textContent = new Date().toLocaleDateString();
                document.getElementById('report-stats-incidents').textContent = incidents.size;
                document.getElementById('report-stats-eas').textContent = sections.size;
            }
        }
        function closeModal(name) { els.modals[name].classList.add('hidden'); }

        function validateCreateForm() {
            const btn = document.getElementById('submit-btn');
            if (els.inputs.address.value && els.inputs.keyword.value && els.inputs.lat.value) btn.disabled = false;
            else btn.disabled = true;
        }

        document.getElementById('dispatch-form').onsubmit = (e) => {
            e.preventDefault();
            const lat = parseFloat(els.inputs.lat.value);
            const lon = parseFloat(els.inputs.lon.value);
            if(!lat) return showMessage("Keine Koordinaten gewählt!", true);

            const duplicates = Array.from(incidents.values()).filter(i => 
                (i.status !== 'completed') && 
                (map.distance(L.latLng(i.lat, i.lon), L.latLng(lat, lon)) < 15)
            );

            if (duplicates.length > 0) {
                pendingIncident = {
                    formattedAddress: els.inputs.address.value, 
                    keyword: els.inputs.keyword.value, 
                    lat, lon, 
                    locName: els.inputs.locName.value
                };
                closeModal('create');
                openModal('duplicate');
                return;
            }

            commitIncident({
                formattedAddress: els.inputs.address.value, 
                keyword: els.inputs.keyword.value, 
                lat, lon, 
                locName: els.inputs.locName.value
            });
        };

        function commitIncident(data) {
            const id = generateUUID();
            const secId = findContainingSection(data.lat, data.lon);
            incidents.set(id, {
                id, 
                formattedAddress: data.formattedAddress, 
                keyword: data.keyword, 
                lat: data.lat, 
                lon: data.lon,
                locationName: data.locName, 
                status: 'open', 
                notes: '', 
                sectionId: secId, 
                createdAt: new Date().toISOString(),
                isManualSection: false
            });
            saveState(); 
            closeModal('create'); 
            closeModal('duplicate');
            renderAll(); 
            document.getElementById('dispatch-form').reset();
            showMessage("EINSATZ ALARMIERT", false);
            pendingIncident = null;
        }

        document.getElementById('confirm-duplicate-btn').onclick = () => {
            if(pendingIncident) commitIncident(pendingIncident);
        };
        document.getElementById('cancel-duplicate-btn').onclick = () => {
            closeModal('duplicate');
            openModal('create'); 
            pendingIncident = null;
        };

        document.getElementById('incident-edit-form').onsubmit = (e) => {
            e.preventDefault();
            const inc = incidents.get(editingIncidentId);
            inc.formattedAddress = els.inputs.editAddress.value;
            inc.keyword = els.inputs.editKeyword.value;
            inc.lat = parseFloat(els.inputs.editLat.value);
            inc.lon = parseFloat(els.inputs.editLon.value);
            const stat = document.getElementById('edit-status-hidden').value;
            if(stat) inc.status = stat;

            const manualEaId = els.inputs.editEaSelect.value;
            if (manualEaId) {
                inc.sectionId = manualEaId;
                inc.isManualSection = true;
            } else {
                inc.sectionId = findContainingSection(inc.lat, inc.lon);
                inc.isManualSection = false;
            }

            incidents.set(editingIncidentId, inc);
            saveState(); closeModal('edit'); renderAll();
            showMessage("Änderungen gespeichert");
        };

        function loadEditModal(id) {
            editingIncidentId = id;
            const inc = incidents.get(id);
            els.inputs.editAddress.value = inc.formattedAddress;
            els.inputs.editKeyword.value = inc.keyword;
            els.inputs.editLat.value = inc.lat;
            els.inputs.editLon.value = inc.lon;
            updateSectionDisplay('edit-auto-section-display', inc.lat, inc.lon);
            
            // Populate EA list...
            const eaSelect = els.inputs.editEaSelect;
            eaSelect.innerHTML = '<option value="">Auto (Geo-basiert)</option>';
            sections.forEach(sec => {
                const opt = document.createElement('option');
                opt.value = sec.id;
                opt.textContent = `${sec.name} (${sec.responsible})`;
                eaSelect.appendChild(opt);
            });
            if (inc.isManualSection && inc.sectionId) eaSelect.value = inc.sectionId;
            else eaSelect.value = "";
            
            // UPDATE STATUS BUTTONS
            const status = inc.status;
            document.getElementById('edit-status-hidden').value = status;
            document.querySelectorAll('.edit-status-btn').forEach(btn => {
                // Reset classes
                btn.className = "edit-status-btn flex-1 py-3 text-xs font-bold uppercase border-t border-b border-r border-gray-300 hover:bg-gray-50 focus:z-10 transition-colors bg-white text-gray-600";
                
                // First button needs border-l, rounded-l
                if(btn.id === 'edit-status-btn-open') {
                    btn.className = "edit-status-btn flex-1 py-3 text-xs font-bold uppercase border border-gray-300 rounded-l-lg hover:bg-gray-50 focus:z-10 transition-colors bg-white text-gray-600";
                }
                // Last button needs rounded-r
                if(btn.id === 'edit-status-btn-completed') {
                    btn.className = "edit-status-btn flex-1 py-3 text-xs font-bold uppercase border-t border-b border-r border-gray-300 rounded-r-lg hover:bg-gray-50 focus:z-10 transition-colors bg-white text-gray-600";
                }

                // Apply Active Style
                if(btn.dataset.status === status) {
                    if(status === 'open') btn.className = "edit-status-btn flex-1 py-3 text-xs font-bold uppercase border border-fire-red rounded-l-lg focus:z-10 transition-colors bg-fire-red text-white shadow-inner";
                    if(status === 'dispatched') btn.className = "edit-status-btn flex-1 py-3 text-xs font-bold uppercase border-t border-b border-r border-police-blue focus:z-10 transition-colors bg-police-blue text-white shadow-inner";
                    if(status === 'completed') btn.className = "edit-status-btn flex-1 py-3 text-xs font-bold uppercase border-t border-b border-r border-alert-amber rounded-r-lg focus:z-10 transition-colors bg-alert-amber text-white shadow-inner";
                }
            });

            openModal('edit');
        }

        // Setup Status Button Click Handlers (Global, runs once)
        document.querySelectorAll('.edit-status-btn').forEach(btn => {
            btn.onclick = () => {
                const status = btn.dataset.status;
                document.getElementById('edit-status-hidden').value = status;
                
                // Re-run the styling logic for all buttons in the group
                document.querySelectorAll('.edit-status-btn').forEach(b => {
                    // Reset basic
                    b.className = "edit-status-btn flex-1 py-3 text-xs font-bold uppercase border-t border-b border-r border-gray-300 hover:bg-gray-50 focus:z-10 transition-colors bg-white text-gray-600";
                    if(b.id === 'edit-status-btn-open') b.classList.add('border', 'rounded-l-lg'); // fix left
                    if(b.id === 'edit-status-btn-completed') b.classList.add('rounded-r-lg');   // fix right
                    
                    // Apply active
                    if(b.dataset.status === status) {
                         if(status === 'open') b.className = "edit-status-btn flex-1 py-3 text-xs font-bold uppercase border border-fire-red rounded-l-lg focus:z-10 transition-colors bg-fire-red text-white shadow-inner";
                         if(status === 'dispatched') b.className = "edit-status-btn flex-1 py-3 text-xs font-bold uppercase border-t border-b border-r border-police-blue focus:z-10 transition-colors bg-police-blue text-white shadow-inner";
                         if(status === 'completed') b.className = "edit-status-btn flex-1 py-3 text-xs font-bold uppercase border-t border-b border-r border-alert-amber rounded-r-lg focus:z-10 transition-colors bg-alert-amber text-white shadow-inner";
                    }
                });
            }
        });

        els.searchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value;
            renderAll();
        });

        document.getElementById('finish-draw-btn').onclick = () => finishDrawing();
        document.getElementById('cancel-draw-btn').onclick = () => setDrawMode(false);

        document.getElementById('section-form').onsubmit = (e) => {
            e.preventDefault();
            const id = generateUUID();
            sections.set(id, {
                id, name: document.getElementById('section-name').value,
                responsible: document.getElementById('section-responsible').value,
                color: document.getElementById('section-color').value,
                boundary: []
            });
            saveState(); renderEAControl(); e.target.reset();
            showMessage("EA erstellt. Bitte Grenze zeichnen.", false);
        };

        window.onload = () => {
            loadState();
            setupAddressAutocomplete('address', 'address-suggestions', 'lat-input', 'lon-input', 'auto-section-display', 'location-name-input');
            setupAddressAutocomplete('edit-address', 'edit-address-suggestions', 'edit-lat-input', 'edit-lon-input', 'edit-auto-section-display', 'edit-location-name-input');
            
            els.inputs.keyword.addEventListener('input', () => {
                renderKeywordAutocomplete(els.inputs.keyword.value.toLowerCase(), els.inputs.keywordSuggestions, els.inputs.keyword, validateCreateForm);
                validateCreateForm();
            });
            els.inputs.editKeyword.addEventListener('input', () => 
                renderKeywordAutocomplete(els.inputs.editKeyword.value.toLowerCase(), els.inputs.editKeywordSuggestions, els.inputs.editKeyword)
            );
            document.addEventListener('click', e => { if (!e.target.closest('input')) document.querySelectorAll('[id$="-suggestions"]').forEach(el => el.classList.add('hidden')); });
        };

        document.getElementById('open-create-incident-modal-btn').onclick = () => openModal('create');
        document.getElementById('close-incident-modal-btn').onclick = () => closeModal('create');
        document.getElementById('manage-ea-btn').onclick = () => openModal('ea');
        document.getElementById('close-ea-modal-btn').onclick = () => closeModal('ea');
        document.getElementById('end-shift-btn').onclick = () => openModal('end');
        document.getElementById('cancel-report-btn').onclick = () => closeModal('end');
        document.getElementById('close-incident-edit-modal-btn').onclick = () => closeModal('edit');
        document.getElementById('cancel-edit-incident-btn').onclick = () => closeModal('edit');
        
        function setIncidentAddMode(v) { isIncidentAddMode=v; v ? (closeModal('create'), els.incidentAddPanel.classList.remove('hidden')) : els.incidentAddPanel.classList.add('hidden'); }
        function setIncidentEditMode(v) { isIncidentEditMode=v; v ? (closeModal('edit'), els.incidentEditPanel.classList.remove('hidden')) : els.incidentEditPanel.classList.add('hidden'); }
        
        document.getElementById('add-incident-map-btn').onclick = () => setIncidentAddMode(true);
        document.getElementById('cancel-add-incident-btn').onclick = () => { setIncidentAddMode(false); openModal('create'); };
        document.getElementById('edit-incident-map-btn').onclick = () => setIncidentEditMode(true);
        document.getElementById('cancel-edit-incident-btn').onclick = () => { setIncidentEditMode(false); openModal('edit'); };
        document.getElementById('delete-incident-btn').onclick = () => { if(confirm("Diesen Einsatz wirklich löschen?")) { incidents.delete(editingIncidentId); saveState(); closeModal('edit'); renderAll(); }};

        document.getElementById('sort-bar').onclick = e => { if (e.target.classList.contains('sort-btn')) { currentSortCriteria = e.target.dataset.sort; renderAll(); } };
        document.getElementById('active-toggle-btn').onclick = () => els.incidentList.classList.toggle('hidden');
        document.getElementById('completed-toggle-btn').onclick = () => { isCompletedSectionOpen=!isCompletedSectionOpen; els.completedIncidentList.classList.toggle('hidden'); renderAll(); };

        document.getElementById('create-report-btn').onclick = () => {
            const name = document.getElementById('lagezeichner-input').value;
            if (!name) return showMessage("Bitte Name des Protokollführers eingeben", true);
            
            // Safe data export for the report (escape special chars)
            const safeIncidents = JSON.stringify(Array.from(incidents.values())).replace(/`/g, '\\`').replace(/\${/g, '\\${').replace(/<\//g, '<\\/');
            const safeSections = JSON.stringify(Array.from(sections.values())).replace(/`/g, '\\`').replace(/\${/g, '\\${').replace(/<\//g, '<\\/');

            const reportHTML = `<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Einsatzbericht - ${new Date().toLocaleDateString()}</title>
<script src="https://cdn.tailwindcss.com"><\/script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Roboto+Slab:wght@700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
    h1, h2, h3, .font-hero { font-family: 'Roboto Slab', serif; font-weight: 700; }
    
    /* Report Specific Styles */
    .report-card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
    }
    
    .incident-row {
        border-left: 4px solid #e5e7eb;
    }
    .status-open { border-left-color: #cc0000; }
    .status-dispatched { border-left-color: #2563eb; }
    .status-completed { border-left-color: #d97706; }
    
    @media print { .no-print { display: none; } }
</style>
</head>
<body class="text-gray-800 p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header (Matches App Header Style) -->
        <div class="bg-[#1a1a1a] rounded-lg shadow-lg p-6 mb-8 flex justify-between items-center text-white">
            <div class="flex items-center space-x-4">
                <div class="bg-[#cc0000] p-3 rounded shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
                </div>
                <div>
                    <h1 class="text-3xl tracking-wide font-hero">EINSATZ<span class="text-[#cc0000]">PROTOKOLL</span></h1>
                    <p class="text-xs text-gray-400 uppercase tracking-widest mt-1">Erstellt von: <span class="font-bold text-white">${name}</span> | Datum: ${new Date().toLocaleString()}</p>
                </div>
            </div>
            <button onclick="window.print()" class="no-print bg-white text-[#1a1a1a] hover:bg-gray-200 font-bold uppercase tracking-wider text-sm py-3 px-6 rounded transition-colors">
                Drucken / PDF
            </button>
        </div>

        <!-- Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="report-card p-6 border-t-4 border-gray-800">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Gesamt</h3>
                <p class="text-4xl font-bold text-gray-900 mt-2" id="stat-total">0</p>
            </div>
            <div class="report-card p-6 border-t-4 border-[#cc0000]">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Offen</h3>
                <p class="text-4xl font-bold text-[#cc0000] mt-2" id="stat-open">0</p>
            </div>
            <div class="report-card p-6 border-t-4 border-[#2563eb]">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Disponiert</h3>
                <p class="text-4xl font-bold text-[#2563eb] mt-2" id="stat-dispatched">0</p>
            </div>
            <div class="report-card p-6 border-t-4 border-[#d97706]">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Abgeschlossen</h3>
                <p class="text-4xl font-bold text-[#d97706] mt-2" id="stat-completed">0</p>
            </div>
        </div>

        <!-- Map & EAs -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Map Container -->
            <div class="lg:col-span-2 report-card overflow-hidden h-[500px] relative">
                 <div id="report-map" class="w-full h-full bg-gray-100"></div>
            </div>

            <!-- Active EAs List -->
            <div class="report-card p-6 overflow-y-auto h-[500px]">
                <h3 class="font-hero text-xl mb-6 border-b border-gray-100 pb-3 text-[#1a1a1a]">EINSATZABSCHNITTE</h3>
                <div id="ea-list-container" class="space-y-4"></div>
            </div>
        </div>

        <!-- Detailed Log -->
        <div class="report-card overflow-hidden">
            <div class="p-6 bg-gray-50 border-b border-gray-200">
                <h3 class="font-hero text-xl text-[#1a1a1a]">EINSATZHISTORIE</h3>
            </div>
            <div id="log-container" class="divide-y divide-gray-100"></div>
        </div>
    </div>

    <script>
        const incidents = ${safeIncidents};
        const sections = ${safeSections};
        const sectionsMap = new Map(sections.map(s => [s.id, s]));

        // Calc Stats
        const stats = { total: incidents.length, open: 0, dispatched: 0, completed: 0 };
        incidents.forEach(i => stats[i.status]++);
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-open').textContent = stats.open;
        document.getElementById('stat-dispatched').textContent = stats.dispatched;
        document.getElementById('stat-completed').textContent = stats.completed;

        // Render EA List
        const eaContainer = document.getElementById('ea-list-container');
        if(sections.length === 0) eaContainer.innerHTML = '<p class="text-gray-400 text-sm italic">Keine Abschnitte definiert.</p>';
        else {
            sections.forEach(sec => {
                const activeCount = incidents.filter(i => i.sectionId === sec.id && i.status !== 'completed').length;
                const div = document.createElement('div');
                div.className = 'p-4 rounded bg-gray-50 border-l-4 shadow-sm';
                div.style.borderLeftColor = sec.color;
                div.innerHTML = \`
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-900 uppercase tracking-tight">\${sec.name}</p>
                            <p class="text-xs text-gray-500 mt-1">Leitung: \${sec.responsible}</p>
                        </div>
                        <span class="text-xs font-bold px-3 py-1 rounded bg-white border border-gray-200 text-gray-700">\${activeCount} Aktiv</span>
                    </div>\`;
                eaContainer.appendChild(div);
            });
        }

        // Render Log
        const logContainer = document.getElementById('log-container');
        incidents.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
        incidents.forEach(inc => {
            const date = new Date(inc.createdAt).toLocaleString();
            const statusLabels = { open: 'Offen', dispatched: 'Disponiert', completed: 'Abgeschlossen' };
            const statusColors = { open: 'bg-[#cc0000] text-white', dispatched: 'bg-[#2563eb] text-white', completed: 'bg-[#d97706] text-white' };
            const rowClass = { open: 'status-open', dispatched: 'status-dispatched', completed: 'status-completed' };
            
            const sec = sectionsMap.get(inc.sectionId);
            const secName = sec ? sec.name : (inc.status === 'completed' ? 'N/A' : 'Nicht zugewiesen');

            const row = document.createElement('div');
            row.className = 'p-6 hover:bg-gray-50 transition incident-row ' + rowClass[inc.status];
            
            // Location Name Badge logic
            const locBadge = inc.locationName ? \`<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800 mb-2 mr-2">\${inc.locationName}</span>\` : '';

            row.innerHTML = \`
                <div class="flex justify-between items-start mb-2">
                    <div>
                        \${locBadge}
                        <span class="text-xs text-gray-400 font-mono block sm:inline">\${date}</span>
                    </div>
                    <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded \${statusColors[inc.status]}">\${statusLabels[inc.status]}</span>
                </div>
                <div class="flex justify-between items-center mb-1">
                    <h4 class="font-bold text-gray-900 text-lg leading-tight">\${inc.keyword}</h4>
                </div>
                <p class="text-sm text-gray-600 font-medium">\${inc.formattedAddress}</p>
                <div class="mt-2 text-xs">
                    <span class="font-bold text-gray-500 uppercase">EA:</span> \${secName}
                </div>
                \${inc.notes ? \`<div class="mt-4 text-sm text-gray-700 bg-yellow-50 border-l-4 border-yellow-400 p-3 italic">"\${inc.notes}"</div>\` : ''}
            \`;
            logContainer.appendChild(row);
        });

        // Init Map
        const map = L.map('report-map').setView([49.123, 8.404], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; OpenStreetMap contributors'
        }).addTo(map);

        // Add Layers
        const group = new L.FeatureGroup();
        
        sections.forEach(sec => {
            if(sec.boundary && sec.boundary.length >= 3) {
                const poly = L.polygon(sec.boundary, { color: sec.color, fillColor: sec.color, fillOpacity: 0.1, weight: 3 }).addTo(group);
                poly.bindTooltip(sec.name, {permanent:true, direction:'center', className:'font-bold text-gray-800'});
            }
        });

        incidents.forEach(inc => {
            if(inc.lat) {
                // Matching Colors to Main App
                const color = inc.status === 'completed' ? '#d97706' : (inc.status === 'dispatched' ? '#2563eb' : '#cc0000');
                
                // Custom Icon using DivIcon to match Main App Look
                const iconHtml = \`<div style="background:\${color}; width:16px; height:16px; border:2px solid white; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>\`;
                
                const marker = L.marker([inc.lat, inc.lon], {
                    icon: L.divIcon({ html: iconHtml, className: 'bg-transparent', iconSize: [24,24] })
                }).addTo(group);
                
                marker.bindPopup(\`<b>\${inc.keyword}</b><br>\${inc.formattedAddress}\`);
            }
        });
        
        group.addTo(map); // Ensure group is added to map

        if(group.getLayers().length > 0) map.fitBounds(group.getBounds().pad(0.1));
        
        // Invalidate size to ensure full render
        setTimeout(() => { map.invalidateSize(); }, 200);
        
    <\/script>
</body>
</html>`;

            const blob = new Blob([reportHTML], {type:'text/html'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`Einsatzbericht_${Date.now()}.html`; a.click();
        };

        window.addEventListener('online', () => els.modals.offline.classList.add('hidden'));
        window.addEventListener('offline', () => {
            els.modals.offline.classList.remove('hidden');
            
            // 1. POPULATE INCIDENTS
            document.getElementById('offline-incident-report').innerHTML = Array.from(incidents.values())
                .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)) // Sort by time desc
                .map(i => {
                    // Status translation
                    const statusMap = { 'open': 'Offen', 'dispatched': 'Disponiert', 'completed': 'Abgeschlossen' };
                    const colorMap = { 'open': 'text-fire-red', 'dispatched': 'text-police-blue', 'completed': 'text-alert-amber' };
                    
                    return `
                    <div class="p-4 border-b border-gray-200 hover:bg-gray-50 flex justify-between">
                        <div>
                            <div class="font-bold text-soot-black text-lg">${i.keyword}</div>
                            <div class="text-gray-600 text-sm mt-1">${i.formattedAddress}</div>
                            ${i.locationName ? `<div class="text-xs font-bold text-gray-500 mt-1 uppercase tracking-wide">📍 ${i.locationName}</div>` : ''}
                        </div>
                        <div class="flex flex-col items-end">
                             <span class="text-[10px] font-bold uppercase tracking-wider mb-1 ${colorMap[i.status] || 'text-gray-500'}">
                                ${statusMap[i.status] || i.status}
                            </span>
                            <span class="text-xs text-gray-400 font-mono">${new Date(i.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>
                    </div>`;
                }).join('');

            // 2. POPULATE SECTIONS
            const offlineEaList = document.getElementById('offline-ea-list');
             if(offlineEaList) {
                 offlineEaList.innerHTML = '';
                 if(sections.size === 0) offlineEaList.innerHTML = '<p class="text-gray-400 italic text-sm col-span-2">Keine aktiven Abschnitte.</p>';
                 sections.forEach(sec => {
                     const activeCount = Array.from(incidents.values()).filter(i => i.sectionId === sec.id && i.status !== 'completed').length;
                     offlineEaList.innerHTML += `
                        <div class="bg-gray-50 border-l-4 p-3 rounded shadow-sm" style="border-left-color: ${sec.color}">
                            <div class="font-bold text-gray-900 text-sm">${sec.name}</div>
                            <div class="text-xs text-gray-500">${sec.responsible}</div>
                            <div class="mt-2 text-xs font-bold text-gray-700">${activeCount} Aktive Einsätze</div>
                        </div>
                     `;
                 });
             }
        });

    </script>
</body>
</html>
