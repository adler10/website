<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Einsatzleitsystem | Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; background-color: #e5e7eb; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Map Cursors */
        .map-draw-mode, .map-pin-mode { cursor: crosshair !important; }
        
        /* Leaflet Draw Markers */
        .leaflet-drawing-icon {
            background-color: #fbbf24; /* amber-400 */
            border: 2px solid #d97706; /* amber-600 */
            width: 14px; height: 14px;
            border-radius: 50%;
            margin-top: -7px; margin-left: -7px;
            position: absolute;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3);
            cursor: pointer !important;
            transition: transform 0.1s;
            z-index: 1000;
        }
        .leaflet-drawing-icon:hover { transform: scale(1.2); }
        
        /* Snap Guide Markers */
        .leaflet-snap-icon {
            background-color: rgba(156, 163, 175, 0.5); /* gray-400 transparent */
            border: 1px solid #4b5563; /* gray-600 */
            width: 10px; height: 10px;
            border-radius: 50%;
            margin-top: -5px; margin-left: -5px;
            position: absolute;
            pointer-events: none; /* Let clicks pass through to map for snapping logic */
            z-index: 500;
        }

        /* Incident Selection Styling */
        .incident-selected {
            border-color: #6366f1 !important; /* indigo-500 */
            background-color: #eef2ff !important; /* indigo-50 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }

        /* Toasts */
        .toast-notification {
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0; transform: translateX(100%);
        }
        .toast-notification.show { opacity: 1; transform: translateX(0); }
        .toast-notification.fade-out { opacity: 0; transform: translateX(100%); }

        /* Z-Indices */
        #offline-overlay { z-index: 9999 !important; }
        .modal-backdrop { z-index: 5000 !important; }
        
        /* Status Badges */
        .status-badge-open { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .status-badge-dispatched { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .status-badge-completed { background-color: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }

        .ea-label {
            background: transparent;
            border: none;
            box-shadow: none;
            color: #374151 !important; /* Gray-700 */
            text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff,
                         1px 1px #fff, -1px -1px #fff, 1px -1px #fff, -1px 1px #fff;
            font-weight: 800;
        }
        
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen overflow-hidden flex flex-col md:flex-row">

    <!-- LEFT SIDEBAR -->
    <div id="sidebar-container" class="w-full md:w-[450px] bg-white border-r border-gray-200 flex flex-col h-full shadow-xl z-20 relative transition-all duration-300">
        
        <!-- Header Section -->
        <div class="p-5 border-b border-gray-100 bg-white flex-shrink-0">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center space-x-2">
                    <div class="bg-red-600 text-white p-1.5 rounded-lg shadow-md shadow-red-100">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 0 0-1.071-.136 9.742 9.742 0 0 0-3.539 6.176 7.547 7.547 0 0 1-1.705-1.715.75.75 0 0 0-1.152-.082A9.725 9.725 0 0 0 2.29 9.654a.75.75 0 0 0 .136 1.071A9.947 9.947 0 0 1 8.604 14.26a6.654 6.654 0 0 1 1.184 5.314.75.75 0 0 0 1.023.823 9.724 9.724 0 0 0 6.53-5.256.75.75 0 0 0-.083-1.152 7.544 7.544 0 0 1-1.715-1.705 9.74 9.74 0 0 0 6.176-3.539.75.75 0 0 0-.136-1.071 9.725 9.725 0 0 0-8.62-3.388Z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900 tracking-tight">Einsatzleit<span class="text-red-600">System</span></h1>
                </div>
                
                <button id="undo-btn" class="text-xs font-medium px-3 py-1.5 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center transition-colors border border-gray-200" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3 mr-1">
                        <path fill-rule="evenodd" d="M7.793 2.232a.75.75 0 0 1-.025 1.06L3.622 7.25h10.003a5.375 5.375 0 0 1 0 10.75H10.75a.75.75 0 0 1 0-1.5h2.875a3.875 3.875 0 0 0 0-7.75H3.622l4.146 3.957a.75.75 0 0 1-1.036 1.085l-5.5-5.25a.75.75 0 0 1 0-1.085l5.5-5.25a.75.75 0 0 1 1.06.025Z" clip-rule="evenodd" />
                    </svg>
                    Rückgängig
                </button>
            </div>

            <div id="status-indicator" class="flex items-center justify-center space-x-2 text-xs font-semibold py-1.5 px-3 rounded-md bg-emerald-50 text-emerald-700 border border-emerald-100">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                </span>
                <span>System Online & Bereit</span>
            </div>
        </div>

        <!-- Main Actions -->
        <div class="p-4 grid grid-cols-2 gap-3 bg-gray-50/50 border-b border-gray-200 flex-shrink-0">
            <button id="open-create-incident-modal-btn" class="col-span-2 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-2.5 px-4 rounded-lg shadow-sm flex items-center justify-center space-x-2 transition-all active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                    <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                </svg>
                <span>Neuer Einsatz</span>
            </button>
            <button id="manage-ea-btn" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 text-sm font-medium py-2 px-3 rounded-lg shadow-sm transition-colors">
                EA Verwalten
            </button>
            <button id="end-shift-btn" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 text-sm font-medium py-2 px-3 rounded-lg shadow-sm transition-colors">
                Bericht / Ende
            </button>
        </div>

        <!-- Incident List Area -->
        <div class="flex-1 overflow-y-auto bg-gray-50/30 p-4 space-y-4">
            
            <!-- Search Bar -->
            <div class="mb-1">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <input type="text" id="incident-search" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-xs transition duration-150 ease-in-out" placeholder="Suche nach Ort, Stichwort, EA...">
                </div>
            </div>

            <!-- Sort & Filter -->
            <div class="flex items-center justify-between mb-2">
                <label class="text-xs font-medium text-gray-500 uppercase tracking-wider">Ansicht</label>
                <div id="sort-bar" class="flex bg-gray-200/80 p-0.5 rounded-lg">
                    <button type="button" data-sort="createdAt" class="sort-btn px-2 py-1 text-[10px] font-medium rounded-md bg-white text-gray-800 shadow-sm transition-all">Zeit</button>
                    <button type="button" data-sort="keyword" class="sort-btn px-2 py-1 text-[10px] font-medium rounded-md text-gray-500 hover:text-gray-700 transition-all">A-Z</button>
                    <button type="button" data-sort="status" class="sort-btn px-2 py-1 text-[10px] font-medium rounded-md text-gray-500 hover:text-gray-700 transition-all">Status</button>
                    <button type="button" data-sort="ea" class="sort-btn px-2 py-1 text-[10px] font-medium rounded-md text-gray-500 hover:text-gray-700 transition-all">EA</button>
                </div>
            </div>

            <!-- Active Incidents -->
            <div class="space-y-2">
                <button id="active-toggle-btn" class="w-full flex items-center justify-between text-xs font-bold text-gray-700 hover:text-gray-900 uppercase tracking-wide mb-2 group">
                    <span>Aktive Einsätze</span>
                    <svg class="w-4 h-4 text-gray-400 group-hover:text-gray-600 transition-transform transform rotate-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="incident-list" class="space-y-3 min-h-[50px]">
                    <!-- Incidents injected here -->
                    <div class="text-center py-8 text-gray-400 text-sm italic">Keine aktiven Einsätze</div>
                </div>
            </div>

            <div class="border-t border-gray-200 my-4"></div>

            <!-- Completed Incidents -->
            <div class="space-y-2">
                <button id="completed-toggle-btn" class="w-full flex items-center justify-between text-xs font-bold text-gray-500 hover:text-gray-700 uppercase tracking-wide group">
                    <span>Archiv</span>
                    <svg class="w-4 h-4 text-gray-400 transition-transform transform -rotate-90" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="completed-incident-list" class="space-y-3 hidden">
                    <!-- Completed incidents -->
                </div>
            </div>

            <p class="text-[10px] text-gray-400 text-center pt-4">Daten werden lokal im Browser gespeichert.</p>
        </div>
    </div>

    <!-- MAP AREA -->
    <div class="flex-1 relative h-full">
        <div id="map" class="bg-gray-200"></div>
        
        <!-- Overlay Gradients for aesthetics -->
        <div class="absolute top-0 left-0 w-full h-6 bg-gradient-to-b from-gray-500/10 to-transparent pointer-events-none z-[400]"></div>
    </div>

    <!-- FLOATING TOOLS PANELS (Bottom Right) -->
    <div class="fixed bottom-6 right-6 flex flex-col items-end space-y-3 z-[1000] pointer-events-none">
        
        <!-- EA Draw Panel -->
        <div id="section-draw-panel" class="pointer-events-auto bg-white p-4 rounded-xl shadow-2xl border-l-4 border-amber-500 w-80 hidden animate-slide-in ring-1 ring-black/5">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-gray-900 text-sm">EA Zeichnen</h3>
                <span class="animate-pulse h-2 w-2 rounded-full bg-amber-500 mt-1.5"></span>
            </div>
            <p class="text-xs text-gray-500 mb-3">Klicken Sie auf die Karte für Eckpunkte.<br>Klick auf Startpunkt schließt Polygon.</p>
            <div class="grid grid-cols-2 gap-2">
                <button id="finish-draw-btn" class="bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold py-2 px-3 rounded-lg shadow-sm">Fertig</button>
                <button id="cancel-draw-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-bold py-2 px-3 rounded-lg">Abbrechen</button>
            </div>
        </div>

        <!-- Add Incident Panel -->
        <div id="incident-add-panel" class="pointer-events-auto bg-white p-4 rounded-xl shadow-2xl border-l-4 border-red-500 w-80 hidden animate-slide-in ring-1 ring-black/5">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-gray-900 text-sm">Position Wählen</h3>
                <span class="animate-pulse h-2 w-2 rounded-full bg-red-500 mt-1.5"></span>
            </div>
            <p class="text-xs text-gray-500 mb-3">Klicken Sie auf den Einsatzort auf der Karte.</p>
            <button id="cancel-add-incident-btn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-bold py-2 px-3 rounded-lg">Abbrechen</button>
        </div>

        <!-- Edit Incident Panel -->
        <div id="incident-edit-panel" class="pointer-events-auto bg-white p-4 rounded-xl shadow-2xl border-l-4 border-indigo-500 w-80 hidden animate-slide-in ring-1 ring-black/5">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-gray-900 text-sm">Position Verschieben</h3>
                <span class="animate-pulse h-2 w-2 rounded-full bg-indigo-500 mt-1.5"></span>
            </div>
            <p class="text-xs text-gray-500 mb-3">Klicken Sie auf die neue Position.</p>
            <button id="cancel-edit-incident-btn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-bold py-2 px-3 rounded-lg">Abbrechen</button>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed top-6 right-6 z-[7000] w-full max-w-sm space-y-2 pointer-events-none">
        <!-- Toasts injected here -->
    </div>

    <!-- MODALS -->

    <!-- Duplicate Warning Modal -->
    <div id="duplicate-warning-modal" class="modal-backdrop fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4 transition-opacity duration-300" style="z-index: 6000;">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col overflow-hidden animate-slide-in border border-red-100">
            <div class="p-5 bg-red-50 border-b border-red-100 flex items-start space-x-3">
                <div class="bg-red-100 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-red-800">Mögliches Duplikat</h3>
                    <p class="text-sm text-red-600 mt-1">An dieser Adresse läuft bereits ein aktiver Einsatz.</p>
                </div>
            </div>
            <div class="p-5">
                <p class="text-sm text-gray-600 mb-4">Möchten Sie diesen Einsatz trotzdem erstellen?</p>
                <div class="flex space-x-3">
                    <button id="cancel-duplicate-btn" class="flex-1 bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-50 transition">Abbrechen</button>
                    <button id="confirm-duplicate-btn" class="flex-1 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition shadow-sm">Trotzdem erstellen</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Incident Modal -->
    <div id="incident-creation-modal" class="modal-backdrop fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden animate-slide-in">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h2 class="text-lg font-bold text-gray-900">Neuen Einsatz anlegen</h2>
                <button id="close-incident-modal-btn" class="text-gray-400 hover:text-gray-600 hover:bg-gray-200 p-1 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto">
                <form id="dispatch-form" class="space-y-4">
                    <!-- Map Button -->
                    <button type="button" id="add-incident-map-btn" class="w-full flex items-center justify-center space-x-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 border border-indigo-200 font-semibold py-2.5 px-4 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <span>Ort auf Karte wählen</span>
                    </button>

                    <div class="relative">
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Adresse</label>
                        <input type="text" id="address" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block p-2.5 transition-colors placeholder-gray-400" placeholder="Straße, Hausnummer, Ort..." autocomplete="off">
                        <input type="hidden" id="lat-input"><input type="hidden" id="lon-input">
                        <input type="hidden" id="location-name-input"> 
                        <div id="address-suggestions" class="absolute z-20 w-full bg-white border border-gray-200 mt-1 rounded-lg shadow-xl hidden max-h-60 overflow-y-auto text-sm"></div>
                    </div>

                    <div class="relative">
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Alarmstichwort</label>
                        <input type="text" id="keyword" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block p-2.5 transition-colors placeholder-gray-400" placeholder="z.B. B 3 - Zimmerbrand" required autocomplete="off">
                        <div id="keyword-suggestions" class="absolute z-20 w-full bg-white border border-gray-200 mt-1 rounded-lg shadow-xl hidden max-h-60 overflow-y-auto text-sm"></div>
                    </div>

                    <div class="p-3 bg-gray-50 rounded-lg border border-dashed border-gray-300 flex items-center justify-between">
                        <span class="text-xs font-medium text-gray-500">Autom. EA-Zuordnung:</span>
                        <span id="auto-section-display" class="text-sm font-bold text-gray-700">Warte auf Adresse...</span>
                        <input type="hidden" id="final-section-assignment">
                    </div>

                    <button type="submit" id="submit-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-all transform active:scale-[0.98]" disabled>
                        Einsatz Alarmieren
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Incident Modal -->
    <div id="incident-edit-modal" class="modal-backdrop fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h2 class="text-lg font-bold text-gray-900">Einsatz Bearbeiten</h2>
                <button id="close-incident-edit-modal-btn" class="text-gray-400 hover:text-gray-600 hover:bg-gray-200 p-1 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto">
                <form id="incident-edit-form" class="space-y-4">
                    <button type="button" id="edit-incident-map-btn" class="w-full flex items-center justify-center space-x-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 border border-indigo-200 font-semibold py-2 px-4 rounded-lg text-sm">
                        <span>Position auf Karte ändern</span>
                    </button>

                    <div class="relative">
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Adresse</label>
                        <input type="text" id="edit-address" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" autocomplete="off">
                        <input type="hidden" id="edit-lat-input"><input type="hidden" id="edit-lon-input">
                        <input type="hidden" id="edit-location-name-input">
                        <div id="edit-address-suggestions" class="absolute z-20 w-full bg-white border border-gray-200 mt-1 rounded-lg shadow-xl hidden max-h-60 overflow-y-auto text-sm"></div>
                    </div>
                    <div class="relative">
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Stichwort</label>
                        <input type="text" id="edit-keyword" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" required autocomplete="off">
                        <div id="edit-keyword-suggestions" class="absolute z-20 w-full bg-white border border-gray-200 mt-1 rounded-lg shadow-xl hidden max-h-60 overflow-y-auto text-sm"></div>
                    </div>
                    
                    <!-- Manual EA Selection -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">EA Zuordnung</label>
                        <select id="edit-ea-select" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                            <option value="">Automatisch (Geo-basiert)</option>
                            <!-- Options populated dynamically -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Status ändern</label>
                        <input type="hidden" id="edit-status-hidden">
                        <div class="flex rounded-lg shadow-sm isolate">
                            <button type="button" id="edit-status-btn-open" data-status="open" class="edit-status-btn flex-1 py-2 text-sm font-medium bg-white border border-gray-300 rounded-l-lg hover:bg-gray-50 focus:z-10 text-gray-700">Offen</button>
                            <button type="button" id="edit-status-btn-dispatched" data-status="dispatched" class="edit-status-btn flex-1 py-2 text-sm font-medium bg-white border-t border-b border-r border-gray-300 hover:bg-gray-50 focus:z-10 text-gray-700">Entsandt</button>
                            <button type="button" id="edit-status-btn-completed" data-status="completed" class="edit-status-btn flex-1 py-2 text-sm font-medium bg-white border-t border-b border-r border-gray-300 rounded-r-lg hover:bg-gray-50 focus:z-10 text-gray-700">Fertig</button>
                        </div>
                    </div>
                    
                    <div class="p-2 bg-gray-50 rounded border border-dashed border-gray-300 text-center">
                        <span id="edit-auto-section-display" class="text-xs font-bold text-gray-500">EA Check...</span>
                    </div>

                    <div class="flex space-x-3 pt-2">
                        <button type="button" id="delete-incident-btn" class="flex-1 bg-white border border-red-200 text-red-600 hover:bg-red-50 font-semibold py-2 px-4 rounded-lg text-sm">Löschen</button>
                        <button type="submit" id="save-incident-btn" class="flex-[2] bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow text-sm">Speichern</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- EA Management Modal -->
    <div id="ea-management-modal" class="modal-backdrop fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-lg font-bold text-gray-900">Einsatzabschnitte (EA)</h2>
                <button id="close-ea-modal-btn" class="text-gray-400 hover:text-gray-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div id="ea-modal-content" class="p-6 overflow-y-auto space-y-6">
                <form id="section-form" class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-3">
                    <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide">Neuen EA anlegen</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="section-name" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg p-2" placeholder="Name (z.B. Nord)" required>
                        <input type="text" id="section-responsible" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg p-2" placeholder="Leitung (z.B. Müller)" required>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="color" id="section-color" class="h-9 w-12 p-0 border-0 rounded cursor-pointer" value="#6366f1">
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Erstellen</button>
                    </div>
                </form>
                <div>
                    <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide mb-3">Aktive Abschnitte</h3>
                    <div id="section-list" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- End Shift Modal -->
    <div id="end-shift-modal" class="modal-backdrop fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-center w-12 h-12 mx-auto bg-indigo-100 text-indigo-600 rounded-full mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                </div>
                <h2 class="text-xl font-bold text-gray-900 text-center mb-2">Bericht erstellen</h2>
                <p class="text-sm text-gray-500 text-center mb-6">Einsatzprotokoll generieren und Schicht abschließen.</p>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-4 text-sm border border-gray-100">
                    <div class="flex justify-between mb-1"><span class="text-gray-500">Datum:</span> <span id="report-stats-date" class="font-semibold text-gray-900"></span></div>
                    <div class="flex justify-between mb-1"><span class="text-gray-500">Einsätze:</span> <span id="report-stats-incidents" class="font-semibold text-gray-900"></span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Abschnitte:</span> <span id="report-stats-eas" class="font-semibold text-gray-900"></span></div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Protokollführer / Lagezeichner</label>
                    <input type="text" id="lagezeichner-input" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Name eingeben...">
                </div>

                <div class="flex space-x-3">
                    <button id="cancel-report-btn" class="flex-1 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-semibold py-2 px-4 rounded-lg text-sm">Zurück</button>
                    <button id="create-report-btn" class="flex-[2] bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-sm">Download HTML</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Offline Overlay -->
    <div id="offline-overlay" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col border-t-8 border-red-600">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-extrabold text-gray-900">SYSTEM OFFLINE</h2>
                <p class="text-red-600 font-medium mt-1 uppercase tracking-widest">Notfall-Modus: Read-Only</p>
            </div>
            <div class="flex-grow overflow-y-auto bg-gray-50 p-6 rounded-xl border border-gray-200 space-y-8">
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-3 border-b border-gray-300 pb-1">Aktuelle Abschnitte</h3>
                    <div id="offline-ea-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-3 border-b border-gray-300 pb-1">Einsatzliste</h3>
                    <div id="offline-incident-report" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>


    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- AAO KEYWORDS ---
        const AAO_KEYWORD_CATEGORIES = {
            "B 1": ["B - Fläche klein (< 10m x 10m)", "B - Gasgeruch im Freien", "B - Kleinfeuer", "B - Müllcontainer / -tonne", "B - PKW / Kleinbus innerorts", "B - Rauch- / Brandgeruch Fahrzeug", "B - Rauch- / Brandgeruch im Freien", "B - Unklare Feuer- / Rauchentwicklung im Freien", "B - Zweirad"],
            "B 2": ["B - Alarmstufenerhöhung auf B 2", "B - Bus", "B - Campingplatz", "B - Explosion im Freien", "B - Fahrzeug sonstiges", "B - Garage / Carport / Gartenhaus", "B - Gasaustritt im Freien klein", "B - Lagerplatz klein", "B - Land- / Forst- / Baumaschine", "B - LKW / Kleintransporter", "B - Maschine", "B - mehrere PKW / Kleinbusse", "B - Person im Freien", "B - PKW / Kleinbus außerorts", "B - Spielplatz", "B - Wald klein (< 10m x 10m)", "B - Wohnmobil / Wohnanhänger"],
            "B 3": ["B - Alarmstufenerhöhung auf B 3", "B - Baustelle", "B - Bordell / Laufhaus", "B - Büro- / Bankgebäude", "B - Bus im / am Gebäude", "B - Dehnfuge", "B - Explosion Kleinobjekt im / am Gebäude", "B - Garage / Carport / Gartenhaus im / am Gebäude", "B - Gasgeruch im / am Gebäude", "B - Gaststätte / Restaurant", "B - Gewässer sonstiges", "B - Hafenanlage / Terminal / Schiffsanlegestelle", "B - Hallenbad / Freibad / Pool", "B - Industrieanlage / -betrieg - Sonstige", "B - Kamin / Heizung / Ofen", "B - Kanalisation", "B - Keller", "B - Kleinfeuer im / am Gebäude", "B - Lagerhalle / Container klein", "B - Lagerplatz groß", "B - Land- / Forst- / Baumaschine im / am Gebäude", "B - LKW / Kleintransporter im / am Gebäude", "B - mehrer PKW / Kleinbusse im / am Gebäude", "B - Müllcontainer / -tonne im / am Gebäude", "B - Öffentliches Gebäude / Objekt geschlossen", "B - Öffentliches Objekt / Gebäude sontiges", "B - Person droht sich zu verbrennen", "B - Person im Gebäude", "B - PKW / Kleinbus im / am Gebäude", "B - privates Gebäude sonstiges", "B - Rauch- / Brandgeruch im Gebäude", "B - Scheune / Stall", "B - Schleuse", "B - Terrasse / Balkon", "B - Unklare Feuer- Rauchentwicklung im / am Gebäude", "B - Volksfest / Bierzelt", "B - Werkstatt", "B - Wohn- / Baucontainer", "B -  Wohnmobiel / Wohnanhänger im / am Gebäude", "B - Wohnung", "B - Zimmer", "B - Zweirad im / am Gebäude"],
			"B 4": ["B - Alarmstufenerhöhung auf B 4", "B - Apotheke / Labor / Arztpraxis", "B - Asylheim / Wohnheim", "B - Bahnhof / Flughafen", "B - Brandausweitung", "B - Dachstuhl / Dachboden", "B - Diskothek / Spielhalle", "B - Freizeit- / Vergnügungspark", "B - Hotel / Jugendherberge", "B - Industrieanlage", "B - Kaserne / Militärische Einrichtung", "B - Kaufhaus / Ladengeschäft", "B - Kindergarten / Schule / Universität", "B - Kino / Theater / Oper", "B - Kirche / Glaubensstätte", "B - Lagerhalle / Container groß", "B - Menschenleben konkret in Gefahr", "B - Museum / Galerie", "B - Sportstation / Sporthalle", "B - Versammlungsstätte"],
			"B 5": ["B - Alarmstufenerhöhung auf B 5", "B - Alten- / Pflegeheim / Krankenhaus", "B - Gefängnis / Haftanstalt / Polizei", "B - Heizkraftwerk", "B - Hochhaus", "B - Parkhaus / Tiefgarage", "B - Sägewerk"],
			"B 6": ["B - Alarmstufenerhöhung auf B 6"],
			"B - Atom": ["B - Fahrzeug - Atom", "B - Industrieanlage / -betrieb - Atom", "B - Luftfahrzeug - Atom", "B - Öffentliches Gebäude / Objekt - Atom", "B - Schienenfahrzeug - Atom", "B - Wasserfahrzeug - Atom", "B - Kernkraftwerk"],
			"B - Bio": ["B - Bio"],
			"B - BMA": ["B - Auslösung BMA", "B - Auslösung Löschanlage","B - Private BMA", "B - Privater Rauchmelder", "B - Private Gaswarnanlage"],
			"B - Boot": ["B - Motorboot / Sportboot", "B - Rauch- / Brandgeruch Wasserfahrzeug"],
			"B - Chemie": [" B - Fahrzeug - Chemie", "B - Luftfahrzeug - Chemie", "B - Schienenfahrzeug - Chemie", "B - Industrieanlage / -betrieb - Chemie", "B - Öffentliches Gebäude / Objekt - Chemie", "B - Wasserfahrzeug - Chemie"],
			"B - Elektroanlage": ["B - Elektrizitätswerk / Trafohaus", "B - Photovoltaik / Solaranlage", "B - Strommast / Leitung"],
			"B - Explosion": ["B - Explosion Fahrzeug", "B - Explosionim / am Gebäude"],
			"B - Flüssigkeit/Gas": ["B - Biogasanlage", "B - Gasaustritt im / am Gebäude", "B - Gasaustritt im Freien groß", "B - Gasflasche", "B - Gastank / Gaslager", "B - Pipeline", "B - Raffinerie / Ölförderanlage", "B - Tanklaster", "B - Tankstelle / Tanklager"],
			"B - Metall": ["B - Metall"],
			"B - Schienentunnel": ["B - Bahnhof / Haltestelle im Untergrund", "B - Schienentunnel / Unterführung"],
			"B - Schiff": ["B - Explosion Wasserfahrzeug", "B - Fahrgastschiff / Hafenfähre", "B - Luftfahrzeug im Wasser", "B - Transportschiff", "B - Wasserfahrzeug sonstiges"],
			"B - Straßentunnel": ["B - Tunnel / Unterführung"],
			"B - Wald": ["B - Fläche groß (> 10m x 10m)", "B - Wald groß (> 10m x 10m)"],
			"B - Zug": ["B - Explosion Schienenfahrzeug", "B - Güterzug / Tankzug", "B - S-Bahn / Personenzug", "B - Schienenfahrzeug sonstiges", "B - Straßenbahn", "B - U-Bahn"],
			"S - Erkundung": ["S - Bomben- / Kampfmittelfund", "S - Nachschau", "TH - Leichenbergung", "TH - Person vermisst / Personensuche"],
			"S - First Responder": ["S - First Responder"],
            "S - Sonstiges": ["S - Ausfall Notruf / Alarmierung", "S - Bedrohungslage", "S - Bereitstellungsraum besetzen", "S - Bombendrohung", "S - Drohendes Attentat", "S - Einsatzalarm überörtlich (ca. 12h)", "S - Einsatzalarm überregional (ca. 24h)", "S - Einsatzbereitschaft herstellen", "S - Führungshaus besetzen", "S - Große Polizeilage (Amok / Terror)", "S - Grundschutz sicherstellen", "S - Maßnahmenstufe 1", "S - Maßnahmenstufe 2", "S - Maßnahmenstufe 3", "S - Stabseinsatz", "S - Vorabinformation / Einsatzanfrage", "S - Voralarm überörtlich (ca. 12h)", "S - Voralarm überregional (ca. 24h)", "S - Wachbesetzung", "S - Überlandhilfe Feuerwehr (außerhalb SK & LK KA)"],
			"TH 1": ["TH - Ast / Baum droht zu fallen", "TH - Ast / Baum entfernen", "TH - Fahrbahn reinigen / aufräumen", "TH - Insekten (Bienen / Hornissen / Hummeln / Wespen)", "TH - Sicherungsarbeiten", "TH - Sonstige Hilfeleistung", "TH - Tierrettung klein", "TH - Tür / Fenster verschließen", "TH - Unfallstelle absichern / ausleuchten", "TH - Verkehrszeichen entfernen", "TH - Wasserschaden"],
			"TH 2": ["TH - Fahrzeug Sicherung / Bergung klein", "TH - Kleineinklemmung", "TH - Person eingeschlossen", "TH - Person eingeschlossen - Aufzug", "TH - Person eingeschlossen - Aufzug + NA", "TH - Person eingeschlossen - Fahrzeug", "TH - Person eingeschlossen - Fahrzeug + NA", "TH - Strom- / Elektrounfall klein", "TH - Unterstützung Rettungsdienst", "TH - Verkehrsunfall (RD - VU mit SoSi)", "TH - Verkehrsunfall ( RD - VU Stufe 1", "TH - Verkehrsunfall (RD - VU Stufe 2)", "TH - Verkehrsunfall (RD - VU Stufe 3)", "TH - Verkehrsunfall (RD - VU Stufe 4)", "TH - VU eCall (Situation unklar)"],
			"TH 3": ["TH - Notfalltüröffnung", "TH - Notfalltüröffnung + NA", "TH - Türöffnung"],
			"TH 4": ["B - Fahrzeug - Menschenleben konkret in Gefahr", "TH - Fahrzeug Sicherung / Bergung groß", "TH - Person eingeklemmt", "TH - Person eingeklemmt - Ast / Baum", "TH - Person eingeklemmt - PKW / Kleinbus", "TH - Person eingeklemmt - Tor / Gerüst / Gestänge", "TH - Person gepfählt", "TH - Strom- / Elektrounfall groß", "TH - Tierrettung groß", "TH - Verkehrsunfall (RD - VU Stufe 5)", "TH - Verkehrsunfall ( RD - VU Stufe 6)", "TH - VU PKW - Person eingeklemmt"],
			"TH 5": ["TH - Baukran droht umzustürzen", "TH - Fahrzeug in Menschenmenge", "TH - Person eingeklemmt - Gebäude", "TH - TH - Person eingeklemmt - Kraftfahrzeug / Maschine", "TH - Person eingeklemmt - LKW / Kleintransporter", "TH - Person eingeklemmt - Maschine / Gerät", "TH - VU LKW - Person eingeklemmt", "TH - TH VU PKW - Personen eingeklemmt (2 bis 5)"],
			"TH 6": ["TH - VU Bus - Person eingeklemmt", "TH - VU LKW - Person eingeklemmt", "TH - VU Massenkarambolage", "TH - VU PKW - Personen eingeklemmt (mehr als 5)"],
			"TH 7": ["B - Gebäude eingestürzt", "TH - Baukran umgestürzt", "TH - Einsturz Gerüst / Gebäude / Verkehrsweg", "TH - Gebäude / Fahrzeug verschüttet", "TH - Person verschüttet"],
			"TH - Beleuchtung": ["TH - Einsatzstelle ausleuchten", "TH - Hubschrauberlandung ausleuchten"],
			"TH - Höhenrettung": ["B - Windkraftwerk / -rad", "TH - Höhlen / Grubenrettung", "TH - Person auf Windkraftanlage", "TH - Person droht zu springen / abzustürzen über 23m", "TH - Person im Seil über 23m", "TH - SRHT über 23m"],
			"TH - Person im Rhein": ["TH - Person im Rhein"],
			"TH - Person im Wasser": ["TH - Eisrettung", "TH - Ertrinkungsunfall / Person im Wasser", "TH - Tauchunfall", "TH - VU Fahrzeug im Wasser (Person in Gefahr)", "TH - Wassersportler / -fahrzeug in Not"],
			"TH - Rettungskorb schwer": ["TH - Unterstützung Rettungsdienst mit Drehleiter (über 130kg)"],
			"TH - Schiene 1": ["TH - Person unter güterzug / Tankzug", "TH - Person unter S-Bahn / Personenzug", "TH - Person unter sonstigem Schienenfahrzeug", "TH - Person unter Straßenbahn", "TH - Person unter U-Bahn", "TH - Sicherung / Bergung Schienenfahrzeug"],
			"TH - Schiene 2": ["TH - Person eingeklemmt - Schienenfahrzeug", "TH - VU Güterzug / Tankzug", "TH - VU S-Bahn / Personenzug", "TH - VU Schienenfahrzeug sonstiges", "TH - VU Straßenbahn", "TH - VU U-Bahn"],
			"TH - Schlüsseldienst": ["TH - Türöffnung (Amtshilfe)"],
			"TH U - Atom": ["TH U - Austretender Gefahrstoff - Atom", "TH U - Fahrzeug - Atom", "TH U - Luftfahrzeug - Atom", "TH U - Schienenfahrzeug - Atom", "TH U - Wasserfahrzeug - Atom"],
			"TH U - Auslaufen von Kraftstoffen groß": ["TH U - Austretende Betriebsstoffe Gewässer", "TH U - Austretende Betriebsstoffe groß", "TH U - Austretender Gefahrstoff klein"],
			"TH U - Auslaufen von Kraftstoffen klein": ["TH U - Austretende Betriebsstoffe klein"],
			"TH U - Bio": ["TH U - Bio"],
			"TH U - Chemie": ["TH U - Austretender Gefahrstoff Gewässer", "TH U - Austretender Gefahrstoff groß", "TH U - Fahrzeug - Chemie", "TH U - Luftfahrzeug - Chemie", "TH U - Schienenfahrzeug - Chemie", "TH U - Wasserfahrzeug - Chemie"],
			"TH U - Messeinsatz groß": ["TH U - Messeinsatz groß"],
			"TH U - Messeinsatz klein": ["TH U - Geruch (Messeinsatz)", "TH U - Gewässerverunreinigung"],
			"TH VU - Boot": ["TH - Sicherung / Bergung Wasserfahrzeug", "TH - VU Motorboot / Sportboot"],
			"TH VU - Flugzeug 1": ["B - Kleinflugzeug / Hubschrauber", "B - Zeppelin / Ballon", "TH - Sicherung / Bergung Luftfahrzeug", "TH - VU Kleinflugzeug / Hubschrauber", "TH - VU Zeppelin / Ballon"],
			"TH VU - Flugzeug 2": ["B - Explosion Luftfahrzeug", "B - Luftfahrzeug sonstiges", "B - Passagier- / Verkehrsflugzeug", "B - Transport- / Militärflugzeug", "TH - VU Luftfahrzeug sonstiges", "TH - VU Passagier- / Verkehrsflugzeug", "TH - VU Transport- / Militärflugzeug"],
			"TH VU - Schiff": ["TH - VU Fahrgastschiff / Hafenfähre", "TH - VU Luftfahrzeug im Wasser", "TH - VU Transportschiff", "TH - VU Wasserfahrzeug sonstiges"],
        };

        // --- UTILITIES ---
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function getCategoryColors(categoryName) {
            if (categoryName.startsWith("TH")) return { header: 'text-blue-700 bg-blue-50 border-blue-200', hover: 'hover:bg-blue-50' };
            if (categoryName.startsWith("B")) return { header: 'text-red-700 bg-red-50 border-red-200', hover: 'hover:bg-red-50' };
            return { header: 'text-gray-700 bg-gray-50 border-gray-200', hover: 'hover:bg-gray-50' };
        }

        function hexToRgba(hex, alpha) {
            let r = 0, g = 0, b = 0;
            if (hex.length == 7) {
                r = parseInt(hex.slice(1, 3), 16);
                g = parseInt(hex.slice(3, 5), 16);
                b = parseInt(hex.slice(5, 7), 16);
            }
            return `rgba(${r},${g},${b},${alpha})`;
        }
        
        function formatGermanAddress(address) {
            const parts = [];
            const street = address.road || '';
            const houseNumber = address.house_number || '';
            const postcode = address.postcode || '';
            const city = address.city || address.town || address.village || '';
            if (street) parts.push(`${street} ${houseNumber}`.trim());
            if (postcode && city) parts.push(`${postcode} ${city}`);
            else if (city && !parts.includes(city)) parts.push(city);
            const finalAddress = parts.join(', ');
            return finalAddress || address.display_name;
        }

        function getPoiName(address) {
            const keys = ['amenity', 'leisure', 'shop', 'tourism', 'historic', 'building', 'office', 'emergency', 'craft'];
            for (const key of keys) {
                if (address[key]) return address[key];
            }
            return null;
        }

        // --- DATA STATE ---
        const incidents = new Map();
        const sections = new Map();
        const markers = new Map();
        const sectionPolygons = new Map();
        let statusHistory = [];
        
        let selectedIncidentId = null;
        let editingIncidentId = null;
        let drawingSectionId = null;
        let currentDrawPoints = [];
        const currentDrawLayer = new L.LayerGroup();
        let currentVertexMarkers = [];
        let currentPolyline = null;
        let currentSnapMarkers = []; 
        
        let isIncidentAddMode = false;
        let isIncidentEditMode = false;
        let currentSortCriteria = 'createdAt';
        let currentSearchTerm = '';
        let isCompletedSectionOpen = false;
        let isActiveSectionOpen = true;
        let debounceTimer;
        let pendingIncident = null;

        // --- MAP SETUP ---
        const map = L.map('map', { zoomControl: false }).setView([49.123, 8.404], 14);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 19
        }).addTo(map);

        currentDrawLayer.addTo(map);

        // --- DOM ELEMENTS ---
        const els = {
            sidebar: document.getElementById('sidebar-container'),
            incidentList: document.getElementById('incident-list'),
            completedIncidentList: document.getElementById('completed-incident-list'),
            toastContainer: document.getElementById('toast-container'),
            incidentAddPanel: document.getElementById('incident-add-panel'),
            incidentEditPanel: document.getElementById('incident-edit-panel'),
            sectionDrawPanel: document.getElementById('section-draw-panel'),
            searchInput: document.getElementById('incident-search'),
            modals: {
                create: document.getElementById('incident-creation-modal'),
                edit: document.getElementById('incident-edit-modal'),
                ea: document.getElementById('ea-management-modal'),
                end: document.getElementById('end-shift-modal'),
                offline: document.getElementById('offline-overlay'),
                duplicate: document.getElementById('duplicate-warning-modal')
            },
            inputs: {
                address: document.getElementById('address'),
                keyword: document.getElementById('keyword'),
                lat: document.getElementById('lat-input'),
                lon: document.getElementById('lon-input'),
                locName: document.getElementById('location-name-input'),
                editAddress: document.getElementById('edit-address'),
                editKeyword: document.getElementById('edit-keyword'),
                editLat: document.getElementById('edit-lat-input'),
                editLon: document.getElementById('edit-lon-input'),
                editLocName: document.getElementById('edit-location-name-input'),
                suggestions: document.getElementById('address-suggestions'),
                editSuggestions: document.getElementById('edit-address-suggestions'),
                keywordSuggestions: document.getElementById('keyword-suggestions'),
                editKeywordSuggestions: document.getElementById('edit-keyword-suggestions'),
                editEaSelect: document.getElementById('edit-ea-select')
            }
        };

        // --- GEO & LOGIC FUNCTIONS ---
        async function geocodeAddress(query) {
            if (!query || !navigator.onLine) return [];
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=de&addressdetails=1&limit=10&viewbox=8.3,49.0,8.5,49.25`);
                const data = await response.json();
                const validData = data.filter(place => place.address);
                validData.sort((a, b) => {
                    const postA = a.address.postcode || '';
                    const postB = b.address.postcode || '';
                    const aIsLiHo = postA === '76351';
                    const bIsLiHo = postB === '76351';
                    if (aIsLiHo && !bIsLiHo) return -1;
                    if (!aIsLiHo && bIsLiHo) return 1;
                    return 0;
                });
                return validData;
            } catch (error) { return []; }
        }

        async function reverseGeocode(lat, lon) {
            if (!navigator.onLine) return null;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`);
                const data = await response.json();
                if (data && data.address) {
                    return { 
                        formattedAddress: formatGermanAddress(data.address), 
                        lat: lat, 
                        lon: lon,
                        poiName: getPoiName(data.address)
                    };
                }
                return null;
            } catch (e) { return null; }
        }

        function isPointInPolygon(point, polygon) {
            const x = point[0], y = point[1];
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                let xi = polygon[i][0], yi = polygon[i][1];
                let xj = polygon[j][0], yj = polygon[j][1];
                let intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        function findContainingSection(lat, lon) {
            let foundId = null;
            sections.forEach(section => {
                if (section.boundary && section.boundary.length >= 3) {
                    if (isPointInPolygon([lat, lon], section.boundary)) foundId = section.id;
                }
            });
            return foundId;
        }

        function orientation(p, q, r) {
            const val = (q[0] - p[0]) * (r[1] - q[1]) - (q[1] - p[1]) * (r[0] - q[0]);
            if (Math.abs(val) < 1e-9) return 0;
            return (val > 0) ? 1 : 2;
        }
        function onSegment(p, q, r) {
            return (q[0] <= Math.max(p[0], r[0]) && q[0] >= Math.min(p[0], r[0]) &&
                    q[1] <= Math.max(p[1], r[1]) && q[1] >= Math.min(p[1], r[1]));
        }
        function segmentsIntersect(p1, q1, p2, q2) {
            if ((p1[0]===p2[0] && p1[1]===p2[1]) || (p1[0]===q2[0] && p1[1]===q2[1]) || 
                (q1[0]===p2[0] && q1[1]===p2[1]) || (q1[0]===q2[0] && q1[1]===q2[1])) return false;
            const o1 = orientation(p1, q1, p2);
            const o2 = orientation(p1, q1, q2);
            const o3 = orientation(p2, q2, p1);
            const o4 = orientation(p2, q2, q1);
            if (o1 !== 0 && o2 !== 0 && o3 !== 0 && o4 !== 0 && o1 !== o2 && o3 !== o4) return true;
            return false;
        }
        
        function checkExistingEAOverlaps(newBoundary, excludeSectionId) {
            let intersectionFound = false;
            sections.forEach(section => {
                if (section.id === excludeSectionId || !section.boundary || section.boundary.length < 3) return;
                const existingBoundary = section.boundary;
                for (let i = 0; i < newBoundary.length; i++) {
                    const p1 = newBoundary[i];
                    const q1 = newBoundary[(i + 1) % newBoundary.length];
                    for (let j = 0; j < existingBoundary.length; j++) {
                        const p2 = existingBoundary[j];
                        const q2 = existingBoundary[(j + 1) % existingBoundary.length];
                        if (segmentsIntersect(p1, q1, p2, q2)) { intersectionFound = true; break; }
                    }
                    if (intersectionFound) break;
                }
            });
            return intersectionFound;
        }
        
        function recalculateSectionAssignments() {
            incidents.forEach(inc => {
                if (inc.status !== 'completed' && !inc.isManualSection) {
                    const secId = findContainingSection(inc.lat, inc.lon);
                    if (secId !== inc.sectionId) {
                        inc.sectionId = secId;
                        incidents.set(inc.id, inc);
                    }
                }
            });
            renderIncidents();
        }

        function showMessage(msg, isError = false, duration = 4000) {
            const toast = document.createElement('div');
            const colorClass = isError ? 'bg-red-50 text-red-800 border-l-4 border-red-500' : 'bg-emerald-50 text-emerald-800 border-l-4 border-emerald-500';
            const icon = isError ? 
                `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` :
                `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            toast.className = `toast-notification pointer-events-auto flex items-center p-4 rounded-lg shadow-lg mb-3 text-sm font-medium ${colorClass} backdrop-blur-md`;
            toast.innerHTML = `${icon} <span>${msg}</span>`;
            const closeBtn = document.createElement('button');
            closeBtn.className = "ml-auto text-gray-400 hover:text-gray-600";
            closeBtn.innerHTML = "&times;";
            closeBtn.onclick = () => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); };
            toast.appendChild(closeBtn);
            els.toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            if (duration > 0) setTimeout(() => closeBtn.click(), duration);
        }

        function saveState() {
            localStorage.setItem('v4_incidents', JSON.stringify(Array.from(incidents.values())));
            localStorage.setItem('v4_sections', JSON.stringify(Array.from(sections.values())));
            localStorage.setItem('v4_history', JSON.stringify(statusHistory));
            updateUndoButton();
        }

        function loadState() {
            try {
                const rawInc = localStorage.getItem('v4_incidents');
                if (rawInc) JSON.parse(rawInc).forEach(i => incidents.set(i.id, i));
                const rawSec = localStorage.getItem('v4_sections');
                if (rawSec) JSON.parse(rawSec).forEach(s => sections.set(s.id, s));
                const rawHist = localStorage.getItem('v4_history');
                if (rawHist) statusHistory = JSON.parse(rawHist);
            } catch(e) { console.error("Load error", e); }
            renderAll();
        }

        // --- RENDERING ---
        function renderIncidents() {
            els.incidentList.innerHTML = '';
            els.completedIncidentList.innerHTML = '';
            markers.forEach(m => map.removeLayer(m));
            markers.clear();

            let activeArray = Array.from(incidents.values()).filter(i => i.status !== 'completed');
            let completedArray = Array.from(incidents.values()).filter(i => i.status === 'completed');

            if (currentSearchTerm) {
                const lower = currentSearchTerm.toLowerCase();
                const filterFn = (i) => {
                    const sec = sections.get(i.sectionId);
                    const secName = sec ? sec.name.toLowerCase() : '';
                    return i.keyword.toLowerCase().includes(lower) || 
                           i.formattedAddress.toLowerCase().includes(lower) ||
                           (i.locationName && i.locationName.toLowerCase().includes(lower)) ||
                           (i.notes && i.notes.toLowerCase().includes(lower)) ||
                           secName.includes(lower);
                };
                activeArray = activeArray.filter(filterFn);
                completedArray = completedArray.filter(filterFn);
            }

            const sortFn = (a, b) => {
                if (currentSortCriteria === 'createdAt') return new Date(b.createdAt) - new Date(a.createdAt);
                if (currentSortCriteria === 'status') return a.status.localeCompare(b.status);
                if (currentSortCriteria === 'keyword') return a.keyword.localeCompare(b.keyword);
                return 0;
            };
            activeArray.sort(sortFn);
            completedArray.sort(sortFn);

            let hasActive = false;
            
            const renderItem = (inc, container) => {
                const isCompleted = inc.status === 'completed';
                const section = sections.get(inc.sectionId);
                const color = isCompleted ? '#6b7280' : (inc.status === 'dispatched' ? '#3b82f6' : '#ef4444');
                
                if (inc.lat) {
                    const isSelected = selectedIncidentId === inc.id;
                    const iconHtml = `<div style="background:${color}; width:14px; height:14px; border:2px solid ${isSelected ? '#1e293b' : '#fff'}; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.3); transform: scale(${isSelected ? 1.5 : 1}); transition: all 0.2s;"></div>`;
                    const marker = L.marker([inc.lat, inc.lon], {
                        icon: L.divIcon({ html: iconHtml, className: 'bg-transparent', iconSize: [20,20] }),
                        zIndexOffset: isSelected ? 1000 : 0
                    }).addTo(map);
                    
                    marker.bindTooltip(inc.keyword, { direction: 'top', offset: [0, -10], className: 'bg-white text-gray-800 border-0 shadow-xl font-semibold' });
                    
                    marker.on('click', () => {
                        selectedIncidentId = inc.id;
                        renderIncidents();
                        map.flyTo([inc.lat, inc.lon], 15);
                    });
                    

                    markers.set(inc.id, marker);
                }

                const el = document.createElement('div');
                const isSelected = selectedIncidentId === inc.id;
                const statusBorder = inc.status === 'open' ? 'border-red-500' : (inc.status === 'dispatched' ? 'border-blue-500' : 'border-gray-400');
                const bgClass = isSelected ? 'bg-white border-indigo-500 shadow-lg ring-1 ring-indigo-500' : 'bg-white border-gray-100 hover:bg-gray-50 shadow-sm';
                
                el.className = `p-3 rounded-r-lg border-l-4 transition-all cursor-pointer ${statusBorder} ${bgClass}`;
                
                const locNameHtml = inc.locationName ? `<div class="text-xs font-bold text-indigo-600 mb-0.5 uppercase tracking-wider flex items-center"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"/></svg>${inc.locationName}</div>` : '';

                el.innerHTML = `
                    ${locNameHtml}
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-gray-900">${inc.keyword}</h4>
                        <span class="text-[10px] font-mono text-gray-400">${new Date(inc.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                    <p class="text-gray-600 text-sm truncate mt-0.5">${inc.formattedAddress}</p>
                    <div class="flex items-center justify-between mt-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-[10px] font-bold uppercase tracking-wider px-1.5 py-0.5 rounded ${inc.status === 'open' ? 'status-badge-open' : (inc.status === 'dispatched' ? 'status-badge-dispatched' : 'status-badge-completed')}">
                                ${inc.status === 'open' ? 'Offen' : (inc.status === 'dispatched' ? 'Entsandt' : 'Erledigt')}
                            </span>
                            ${section ? `<span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-600 border border-gray-200" style="border-left-color:${section.color}; border-left-width:3px;">${section.name}</span>` : ''}
                            ${inc.isManualSection ? `<span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-500" title="Manuell">M</span>` : ''}
                        </div>
                        <button class="edit-inc-btn text-gray-400 hover:text-indigo-600" data-id="${inc.id}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                    </div>
                    ${isSelected ? `
                        <div class="mt-3 pt-3 border-t border-gray-100 animate-slide-in">
                            <label class="text-xs text-gray-500 font-bold mb-1 block">Notizen</label>
                            <textarea class="w-full text-xs bg-gray-50 border border-gray-200 text-gray-800 rounded p-2 mb-2 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2" onchange="updateNote('${inc.id}', this.value)">${inc.notes || ''}</textarea>
                            <div class="flex space-x-2">
                                ${inc.status === 'open' ? `<button onclick="updateStatus('${inc.id}', 'dispatched')" class="flex-1 bg-blue-600 text-white py-1.5 rounded text-xs font-bold shadow hover:bg-blue-700">Disponieren</button>` : ''}
                                ${inc.status !== 'completed' ? `<button onclick="updateStatus('${inc.id}', 'completed')" class="flex-1 bg-gray-600 text-white py-1.5 rounded text-xs font-bold shadow hover:bg-gray-700">Abschließen</button>` : ''}
                            </div>
                        </div>
                    ` : ''}
                `;
                
                el.onclick = (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'TEXTAREA' || e.target.closest('.edit-inc-btn')) return;
                    selectedIncidentId = isSelected ? null : inc.id;
                    renderIncidents();
                    if(selectedIncidentId && inc.lat) map.setView([inc.lat, inc.lon], 15);
                };

                const editBtn = el.querySelector('.edit-inc-btn');
                if(editBtn) editBtn.onclick = () => loadEditModal(inc.id);
                
                container.appendChild(el);
            };

            activeArray.forEach(i => renderItem(i, els.incidentList));
            if(activeArray.length > 0) hasActive = true;

            if (isCompletedSectionOpen) {
                completedArray.forEach(i => renderItem(i, els.completedIncidentList));
            }

            if (!hasActive) els.incidentList.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm italic">Keine Einsätze gefunden</div>';
        }

        function renderPolygons() {
            sectionPolygons.forEach(l => map.removeLayer(l));
            sectionPolygons.clear();
            sections.forEach(sec => {
                if (sec.boundary && sec.boundary.length >= 3) {
                    const poly = L.polygon(sec.boundary, { color: sec.color, fillColor: sec.color, fillOpacity: 0.15, weight: 2 }).addTo(map);
                    poly.bindTooltip(`<span style="color:${sec.color}">${sec.name}</span>`, {permanent:true, direction:'center', className:'ea-label'});
                    sectionPolygons.set(sec.id, poly);
                }
            });
        }

        function renderEAControl() {
            const list = document.getElementById('section-list');
            list.innerHTML = '';
            sections.forEach(sec => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg shadow-sm';
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 rounded-full" style="background:${sec.color}; box-shadow: 0 0 8px ${sec.color}40"></div>
                        <div>
                            <p class="text-sm font-bold text-gray-800">${sec.name}</p>
                            <p class="text-xs text-gray-500">${sec.responsible}</p>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="setDrawMode(true, '${sec.id}')" class="p-1.5 text-gray-400 hover:text-amber-600 hover:bg-amber-50 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                        <button onclick="deleteSection('${sec.id}')" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>`;
                list.appendChild(div);
            });
        }

        function renderAll() {
            renderIncidents();
            renderPolygons();
            renderEAControl();
            document.querySelectorAll('.sort-btn').forEach(b => {
                if (b.dataset.sort === currentSortCriteria) {
                    b.classList.remove('bg-white', 'text-gray-800');
                    b.classList.add('bg-indigo-600', 'text-white');
                } else {
                    b.classList.add('bg-white', 'text-gray-800');
                    b.classList.remove('bg-indigo-600', 'text-white');
                }
            });
        }

        // --- AUTOCOMPLETE LOGIC ---
        function renderKeywordAutocomplete(query, container, inputElement, callback) {
            container.innerHTML = '';
            if (query.length < 2) { container.classList.add('hidden'); return; }
            
            let hasMatches = false;
            for (const category in AAO_KEYWORD_CATEGORIES) {
                const keywords = AAO_KEYWORD_CATEGORIES[category];
                const catMatch = category.toLowerCase().includes(query);
                let matches = catMatch ? keywords : keywords.filter(k => k.toLowerCase().includes(query));
                
                if (matches.length > 0) {
                    hasMatches = true;
                    const colors = getCategoryColors(category);
                    const header = document.createElement('div');
                    header.textContent = category;
                    header.className = `p-2 mt-1 font-bold text-xs uppercase border-t ${colors.header}`;
                    container.appendChild(header);
                    
                    matches.forEach(kw => {
                        const item = document.createElement('div');
                        item.textContent = kw;
                        item.className = `p-2 cursor-pointer ${colors.hover} text-sm text-gray-700 pl-4 transition-colors`;
                        item.onclick = () => {
                            inputElement.value = kw;
                            container.classList.add('hidden');
                            if (callback) callback();
                        };
                        container.appendChild(item);
                    });
                }
            }
            if (hasMatches) container.classList.remove('hidden');
            else container.classList.add('hidden');
        }

        function setupAddressAutocomplete(inputId, suggestionId, latId, lonId, displayId, locNameId) {
            const inp = document.getElementById(inputId);
            const sug = document.getElementById(suggestionId);
            
            inp.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                const query = inp.value;
                if (query.length < 3) { sug.classList.add('hidden'); return; }
                
                debounceTimer = setTimeout(async () => {
                    const data = await geocodeAddress(query);
                    sug.innerHTML = '';
                    if (data.length > 0) {
                        sug.classList.remove('hidden');
                        data.forEach(d => {
                            const item = document.createElement('div');
                            const fmt = formatGermanAddress(d.address);
                            const isLiHo = d.address.postcode === '76351';
                            item.textContent = fmt;
                            item.className = `p-2 cursor-pointer hover:bg-gray-100 text-sm ${isLiHo ? 'text-indigo-600 font-bold' : 'text-gray-700'}`;
                            item.onclick = () => {
                                inp.value = fmt;
                                document.getElementById(latId).value = d.lat;
                                document.getElementById(lonId).value = d.lon;
                                const poi = getPoiName(d.address);
                                if(locNameId) document.getElementById(locNameId).value = poi || '';
                                sug.classList.add('hidden');
                                updateSectionDisplay(displayId, parseFloat(d.lat), parseFloat(d.lon));
                                if (inputId === 'address') validateCreateForm();
                            };
                            sug.appendChild(item);
                        });
                    } else { sug.classList.add('hidden'); }
                }, 300);
            });
        }

        function updateSectionDisplay(elId, lat, lon) {
            const el = document.getElementById(elId);
            const secId = findContainingSection(lat, lon);
            if (secId) {
                const sec = sections.get(secId);
                el.innerHTML = `<span style="color:${sec.color}">${sec.name} (V: ${sec.responsible})</span>`;
            } else {
                el.innerHTML = `<span class="text-red-600 font-bold">Keinem EA zugeordnet</span>`;
            }
        }

        // --- DRAWING LOGIC ---
        function setDrawMode(active, id) {
            drawingSectionId = active ? id : null;
            currentSnapMarkers.forEach(m => map.removeLayer(m));
            currentSnapMarkers = [];
            if (active) {
                document.body.classList.add('cursor-crosshair');
                map.getContainer().classList.add('map-draw-mode');
                els.sectionDrawPanel.classList.remove('hidden');
                els.modals.ea.classList.add('hidden');
                
                sections.forEach(sec => {
                    if (sec.id !== id && sec.boundary) {
                        sec.boundary.forEach(pt => {
                            const sm = L.divIcon({ className: 'leaflet-snap-icon' });
                            const m = L.marker(pt, { icon: sm, interactive: false }).addTo(map);
                            currentSnapMarkers.push(m);
                        });
                    }
                });

                currentDrawPoints = sections.get(id).boundary ? [...sections.get(id).boundary] : [];
                redrawDrawLayer();
            } else {
                document.body.classList.remove('cursor-crosshair');
                map.getContainer().classList.remove('map-draw-mode');
                els.sectionDrawPanel.classList.add('hidden');
                currentDrawLayer.clearLayers();
                renderAll();
                openModal('ea');
            }
        }

        function redrawDrawLayer() {
            currentDrawLayer.clearLayers();
            if (currentDrawPoints.length > 0) {
                if (currentDrawPoints.length >= 3) {
                    const sec = sections.get(drawingSectionId);
                    L.polygon(currentDrawPoints, { color: sec.color, fillColor: sec.color, fillOpacity: 0.3, weight: 2, dashArray: '5, 5' }).addTo(currentDrawLayer);
                } else {
                    L.polyline(currentDrawPoints, { color: '#d97706', weight: 2, dashArray: '5, 5' }).addTo(currentDrawLayer);
                }
                currentDrawPoints.forEach((p, idx) => {
                    const m = L.marker(p, { icon: L.divIcon({ className: 'leaflet-drawing-icon' }), draggable: true }).addTo(currentDrawLayer);
                    m.on('drag', e => { 
                        currentDrawPoints[idx] = [e.target.getLatLng().lat, e.target.getLatLng().lng]; 
                        // Visual update only without re-creating markers to prevent drag interruption
                        const layers = currentDrawLayer.getLayers();
                        // Find the polyline layer and update it
                         layers.forEach(l => {
                            if (l instanceof L.Polyline && !(l instanceof L.Polygon)) l.setLatLngs(currentDrawPoints);
                            else if (l instanceof L.Polygon) l.setLatLngs(currentDrawPoints);
                        });
                    }); 
                    m.on('click', (e) => { L.DomEvent.stopPropagation(e); if(idx===0 && currentDrawPoints.length>=3) finishDrawing(); else { currentDrawPoints.splice(idx, 1); redrawDrawLayer(); } });
                });
            }
        }

        function finishDrawing() {
            if (currentDrawPoints.length < 3) return showMessage("Min. 3 Punkte", true);
            if (checkExistingEAOverlaps(currentDrawPoints, drawingSectionId)) return showMessage("Überlappung mit anderem EA erkannt!", true);
            const s = sections.get(drawingSectionId);
            s.boundary = [...currentDrawPoints];
            sections.set(drawingSectionId, s);
            saveState(); 
            setDrawMode(false); 
            recalculateSectionAssignments(); // Recalc assignments on draw finish
            showMessage("Grenze gespeichert", false);
        }

        map.on('click', async (e) => {
            if (isIncidentAddMode) { handleGeoSelect(e.latlng, 'create'); } 
            else if (isIncidentEditMode) { handleGeoSelect(e.latlng, 'edit'); } 
            else if (drawingSectionId) {
                let lat = e.latlng.lat, lng = e.latlng.lng;
                const clickPt = map.latLngToContainerPoint(e.latlng);
                let snapped = false;
                if (currentDrawPoints.length >= 3 && clickPt.distanceTo(map.latLngToContainerPoint(currentDrawPoints[0])) < 15) { finishDrawing(); return; }
                sections.forEach(sec => {
                    if (sec.id !== drawingSectionId && sec.boundary) {
                        sec.boundary.forEach(pt => {
                            if (clickPt.distanceTo(map.latLngToContainerPoint(pt)) < 15) { lat = pt[0]; lng = pt[1]; snapped = true; }
                        });
                    }
                });
                if (snapped) showMessage("An Punkt angedockt", false, 1000);
                currentDrawPoints.push([lat, lng]);
                redrawDrawLayer();
            } else { selectedIncidentId = null; renderIncidents(); }
        });

        async function handleGeoSelect(latlng, mode) {
            const panel = mode === 'create' ? els.incidentAddPanel : els.incidentEditPanel;
            panel.querySelector('p').textContent = "Adresse wird geladen...";
            const data = await reverseGeocode(latlng.lat, latlng.lng);
            if (data) {
                if (mode === 'create') {
                    els.inputs.address.value = data.formattedAddress;
                    els.inputs.lat.value = data.lat;
                    els.inputs.lon.value = data.lon;
                    els.inputs.locName.value = data.poiName || '';
                    updateSectionDisplay('auto-section-display', parseFloat(data.lat), parseFloat(data.lon));
                    setIncidentAddMode(false);
                    openModal('create');
                    validateCreateForm();
                } else {
                    els.inputs.editAddress.value = data.formattedAddress;
                    els.inputs.editLat.value = data.lat;
                    els.inputs.editLon.value = data.lon;
                    updateSectionDisplay('edit-auto-section-display', parseFloat(data.lat), parseFloat(data.lon));
                    setIncidentEditMode(false);
                    openModal('edit');
                }
                showMessage("Adresse übernommen", false);
            } else { showMessage("Fehler bei Geo-Suche", true); }
            panel.querySelector('p').textContent = "Klicken Sie auf die Karte.";
        }

        // --- INTERACTION HANDLERS ---
        window.updateStatus = (id, status) => {
            const inc = incidents.get(id);
            statusHistory.push({ id, oldStatus: inc.status, newStatus: status });
            inc.status = status;
            incidents.set(id, inc);
            saveState(); renderAll(); updateUndoButton();
        };
        window.updateNote = (id, val) => {
            const inc = incidents.get(id);
            inc.notes = val;
            incidents.set(id, inc);
            saveState();
        };
        window.deleteSection = (id) => {
            if(confirm("Abschnitt löschen?")) { 
                sections.delete(id); 
                saveState(); 
                recalculateSectionAssignments(); // Recalc assignments on delete
                renderAll(); 
            }
        };
        function updateUndoButton() { document.getElementById('undo-btn').disabled = statusHistory.length === 0; }
        
        document.getElementById('undo-btn').onclick = () => {
            const last = statusHistory.pop();
            if (last) {
                const inc = incidents.get(last.id);
                if (inc) { inc.status = last.oldStatus; incidents.set(last.id, inc); saveState(); renderAll(); updateUndoButton(); showMessage("Rückgängig gemacht"); }
            }
        };

        // --- FORMS & MODALS ---
        function openModal(name) {
            els.modals[name].classList.remove('hidden');
            if(name === 'ea') renderEAControl();
            if(name === 'end') {
                document.getElementById('report-stats-date').textContent = new Date().toLocaleDateString();
                document.getElementById('report-stats-incidents').textContent = incidents.size;
                document.getElementById('report-stats-eas').textContent = sections.size;
            }
        }
        function closeModal(name) { els.modals[name].classList.add('hidden'); }

        function validateCreateForm() {
            const btn = document.getElementById('submit-btn');
            if (els.inputs.address.value && els.inputs.keyword.value && els.inputs.lat.value) btn.disabled = false;
            else btn.disabled = true;
        }

        // Create Incident Logic (Collision Detection)
        document.getElementById('dispatch-form').onsubmit = (e) => {
            e.preventDefault();
            const lat = parseFloat(els.inputs.lat.value);
            const lon = parseFloat(els.inputs.lon.value);
            if(!lat) return showMessage("Keine Koordinaten!", true);

            // Check for duplicates
            const duplicates = Array.from(incidents.values()).filter(i => 
                (i.status !== 'completed') && 
                (map.distance(L.latLng(i.lat, i.lon), L.latLng(lat, lon)) < 15)
            );

            if (duplicates.length > 0) {
                pendingIncident = {
                    formattedAddress: els.inputs.address.value, 
                    keyword: els.inputs.keyword.value, 
                    lat, lon, 
                    locName: els.inputs.locName.value
                };
                closeModal('create');
                openModal('duplicate');
                return;
            }

            commitIncident({
                formattedAddress: els.inputs.address.value, 
                keyword: els.inputs.keyword.value, 
                lat, lon, 
                locName: els.inputs.locName.value
            });
        };

        function commitIncident(data) {
            const id = generateUUID();
            const secId = findContainingSection(data.lat, data.lon);
            incidents.set(id, {
                id, 
                formattedAddress: data.formattedAddress, 
                keyword: data.keyword, 
                lat: data.lat, 
                lon: data.lon,
                locationName: data.locName, 
                status: 'open', 
                notes: '', 
                sectionId: secId, 
                createdAt: new Date().toISOString(),
                isManualSection: false
            });
            saveState(); 
            closeModal('create'); 
            closeModal('duplicate');
            renderAll(); 
            document.getElementById('dispatch-form').reset();
            showMessage("Einsatz alarmiert", false);
            pendingIncident = null;
        }

        document.getElementById('confirm-duplicate-btn').onclick = () => {
            if(pendingIncident) commitIncident(pendingIncident);
        };
        document.getElementById('cancel-duplicate-btn').onclick = () => {
            closeModal('duplicate');
            openModal('create'); 
            pendingIncident = null;
        };

        document.getElementById('incident-edit-form').onsubmit = (e) => {
            e.preventDefault();
            const inc = incidents.get(editingIncidentId);
            inc.formattedAddress = els.inputs.editAddress.value;
            inc.keyword = els.inputs.editKeyword.value;
            inc.lat = parseFloat(els.inputs.editLat.value);
            inc.lon = parseFloat(els.inputs.editLon.value);
            const stat = document.getElementById('edit-status-hidden').value;
            if(stat) inc.status = stat;

            const manualEaId = els.inputs.editEaSelect.value;
            if (manualEaId) {
                inc.sectionId = manualEaId;
                inc.isManualSection = true;
            } else {
                inc.sectionId = findContainingSection(inc.lat, inc.lon);
                inc.isManualSection = false;
            }

            incidents.set(editingIncidentId, inc);
            saveState(); closeModal('edit'); renderAll();
            showMessage("Gespeichert");
        };

        function loadEditModal(id) {
            editingIncidentId = id;
            const inc = incidents.get(id);
            els.inputs.editAddress.value = inc.formattedAddress;
            els.inputs.editKeyword.value = inc.keyword;
            els.inputs.editLat.value = inc.lat;
            els.inputs.editLon.value = inc.lon;
            updateSectionDisplay('edit-auto-section-display', inc.lat, inc.lon);
            
            const eaSelect = els.inputs.editEaSelect;
            eaSelect.innerHTML = '<option value="">Automatisch (Geo-basiert)</option>';
            sections.forEach(sec => {
                const opt = document.createElement('option');
                opt.value = sec.id;
                opt.textContent = `${sec.name} (${sec.responsible})`;
                eaSelect.appendChild(opt);
            });
            if (inc.isManualSection && inc.sectionId) eaSelect.value = inc.sectionId;
            else eaSelect.value = "";

            openModal('edit');
        }

        els.searchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value;
            renderAll();
        });

        document.getElementById('finish-draw-btn').onclick = () => finishDrawing();
        document.getElementById('cancel-draw-btn').onclick = () => setDrawMode(false);

        document.getElementById('section-form').onsubmit = (e) => {
            e.preventDefault();
            const id = generateUUID();
            sections.set(id, {
                id, name: document.getElementById('section-name').value,
                responsible: document.getElementById('section-responsible').value,
                color: document.getElementById('section-color').value,
                boundary: []
            });
            saveState(); renderEAControl(); e.target.reset();
            showMessage("EA erstellt. Bitte zeichnen.", false);
        };

        window.onload = () => {
            loadState();
            setupAddressAutocomplete('address', 'address-suggestions', 'lat-input', 'lon-input', 'auto-section-display', 'location-name-input');
            setupAddressAutocomplete('edit-address', 'edit-address-suggestions', 'edit-lat-input', 'edit-lon-input', 'edit-auto-section-display', 'edit-location-name-input');
            
            els.inputs.keyword.addEventListener('input', () => {
                renderKeywordAutocomplete(els.inputs.keyword.value.toLowerCase(), els.inputs.keywordSuggestions, els.inputs.keyword, validateCreateForm);
                validateCreateForm();
            });
            els.inputs.editKeyword.addEventListener('input', () => 
                renderKeywordAutocomplete(els.inputs.editKeyword.value.toLowerCase(), els.inputs.editKeywordSuggestions, els.inputs.editKeyword)
            );
            document.addEventListener('click', e => { if (!e.target.closest('input')) document.querySelectorAll('[id$="-suggestions"]').forEach(el => el.classList.add('hidden')); });
            document.querySelectorAll('.edit-status-btn').forEach(btn => {
                btn.onclick = () => {
                    document.getElementById('edit-status-hidden').value = btn.dataset.status;
                    document.querySelectorAll('.edit-status-btn').forEach(b => b.classList.remove('bg-indigo-600', 'text-white'));
                    btn.classList.add('bg-indigo-600', 'text-white');
                }
            });
        };

        document.getElementById('open-create-incident-modal-btn').onclick = () => openModal('create');
        document.getElementById('close-incident-modal-btn').onclick = () => closeModal('create');
        document.getElementById('manage-ea-btn').onclick = () => openModal('ea');
        document.getElementById('close-ea-modal-btn').onclick = () => closeModal('ea');
        document.getElementById('end-shift-btn').onclick = () => openModal('end');
        document.getElementById('cancel-report-btn').onclick = () => closeModal('end');
        document.getElementById('close-incident-edit-modal-btn').onclick = () => closeModal('edit');
        document.getElementById('cancel-edit-incident-btn').onclick = () => closeModal('edit');
        
        function setIncidentAddMode(v) { isIncidentAddMode=v; v ? (closeModal('create'), els.incidentAddPanel.classList.remove('hidden')) : els.incidentAddPanel.classList.add('hidden'); }
        function setIncidentEditMode(v) { isIncidentEditMode=v; v ? (closeModal('edit'), els.incidentEditPanel.classList.remove('hidden')) : els.incidentEditPanel.classList.add('hidden'); }
        
        document.getElementById('add-incident-map-btn').onclick = () => setIncidentAddMode(true);
        document.getElementById('cancel-add-incident-btn').onclick = () => { setIncidentAddMode(false); openModal('create'); };
        document.getElementById('edit-incident-map-btn').onclick = () => setIncidentEditMode(true);
        document.getElementById('cancel-edit-incident-btn').onclick = () => { setIncidentEditMode(false); openModal('edit'); };
        document.getElementById('delete-incident-btn').onclick = () => { if(confirm("Löschen?")) { incidents.delete(editingIncidentId); saveState(); closeModal('edit'); renderAll(); }};

        document.getElementById('sort-bar').onclick = e => { if (e.target.classList.contains('sort-btn')) { currentSortCriteria = e.target.dataset.sort; renderAll(); } };
        document.getElementById('active-toggle-btn').onclick = () => els.incidentList.classList.toggle('hidden');
        document.getElementById('completed-toggle-btn').onclick = () => { isCompletedSectionOpen=!isCompletedSectionOpen; els.completedIncidentList.classList.toggle('hidden'); renderAll(); };

        document.getElementById('create-report-btn').onclick = () => {
            const name = document.getElementById('lagezeichner-input').value;
            if (!name) return showMessage("Name fehlt", true);
            
            const incidentData = JSON.stringify(Array.from(incidents.values()));
            const sectionsData = JSON.stringify(Array.from(sections.values()));

            const reportHTML = `<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Einsatzbericht - ${new Date().toLocaleDateString()}</title>
<script src="https://cdn.tailwindcss.com"><\/script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Inter', sans-serif; }
    @media print { .no-print { display: none; } }
</style>
</head>
<body class="bg-gray-50 text-gray-800 p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-200 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Einsatzprotokoll</h1>
                <p class="text-sm text-gray-500 mt-1">Erstellt von: <span class="font-medium text-gray-900">${name}</span> am ${new Date().toLocaleString()}</p>
            </div>
            <button onclick="window.print()" class="no-print bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors">
                Drucken / PDF
            </button>
        </div>

        <!-- Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-xl border-l-4 border-gray-800 shadow-sm">
                <h3 class="text-xs font-bold text-gray-500 uppercase">Gesamt</h3>
                <p class="text-2xl font-bold text-gray-900 mt-1" id="stat-total">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl border-l-4 border-red-500 shadow-sm">
                <h3 class="text-xs font-bold text-gray-500 uppercase">Offen</h3>
                <p class="text-2xl font-bold text-red-600 mt-1" id="stat-open">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl border-l-4 border-blue-500 shadow-sm">
                <h3 class="text-xs font-bold text-gray-500 uppercase">Entsandt</h3>
                <p class="text-2xl font-bold text-blue-600 mt-1" id="stat-dispatched">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl border-l-4 border-gray-400 shadow-sm">
                <h3 class="text-xs font-bold text-gray-500 uppercase">Abgeschlossen</h3>
                <p class="text-2xl font-bold text-gray-600 mt-1" id="stat-completed">0</p>
            </div>
        </div>

        <!-- Map & EAs -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Map Container -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-[500px] relative">
                 <div id="report-map" class="w-full h-full bg-gray-100"></div>
            </div>

            <!-- Active EAs List -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 overflow-y-auto h-[500px]">
                <h3 class="font-bold text-lg mb-4 border-b pb-2">Aktive Abschnitte</h3>
                <div id="ea-list-container" class="space-y-3"></div>
            </div>
        </div>

        <!-- Detailed Log -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <h3 class="font-bold text-lg">Einsatzhistorie (Chronologisch)</h3>
            </div>
            <div id="log-container" class="divide-y divide-gray-100"></div>
        </div>
    </div>

    <script>
        const incidents = ${incidentData};
        const sections = ${sectionsData};
        const sectionsMap = new Map(sections.map(s => [s.id, s]));

        // Calc Stats
        const stats = { total: incidents.length, open: 0, dispatched: 0, completed: 0 };
        incidents.forEach(i => stats[i.status]++);
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-open').textContent = stats.open;
        document.getElementById('stat-dispatched').textContent = stats.dispatched;
        document.getElementById('stat-completed').textContent = stats.completed;

        // Render EA List
        const eaContainer = document.getElementById('ea-list-container');
        if(sections.length === 0) eaContainer.innerHTML = '<p class="text-gray-400 text-sm italic">Keine Abschnitte definiert</p>';
        else {
            sections.forEach(sec => {
                const activeCount = incidents.filter(i => i.sectionId === sec.id && i.status !== 'completed').length;
                const div = document.createElement('div');
                div.className = 'p-3 rounded bg-gray-50 border-l-4';
                div.style.borderLeftColor = sec.color;
                div.innerHTML = \`
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-900">\${sec.name}</p>
                            <p class="text-xs text-gray-500">\${sec.responsible}</p>
                        </div>
                        <span class="text-xs font-bold px-2 py-1 rounded bg-white border">\${activeCount} Aktiv</span>
                    </div>\`;
                eaContainer.appendChild(div);
            });
        }

        // Render Log
        const logContainer = document.getElementById('log-container');
        incidents.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
        incidents.forEach(inc => {
            const date = new Date(inc.createdAt).toLocaleString();
            const statusLabels = { open: 'Offen', dispatched: 'Entsandt', completed: 'Erledigt' };
            const statusColors = { open: 'bg-red-100 text-red-800', dispatched: 'bg-blue-100 text-blue-800', completed: 'bg-gray-100 text-gray-800' };
            const sec = sectionsMap.get(inc.sectionId);
            const secName = sec ? sec.name : (inc.status === 'completed' ? 'N/A' : 'Kein EA');

            const row = document.createElement('div');
            row.className = 'p-4 hover:bg-gray-50 transition';
            row.innerHTML = \`
                <div class="flex justify-between items-start mb-1">
                    <span class="text-xs text-gray-400 font-mono">\${date}</span>
                    <span class="text-xs font-bold px-2 py-0.5 rounded \${statusColors[inc.status]}">\${statusLabels[inc.status]}</span>
                </div>
                <div class="flex justify-between">
                    <h4 class="font-bold text-gray-900">\${inc.keyword}</h4>
                    <span class="text-xs font-medium text-gray-500">\${secName}</span>
                </div>
                <p class="text-sm text-gray-600 mt-1">\${inc.formattedAddress}</p>
                \${inc.notes ? \`<div class="mt-2 text-xs text-gray-500 bg-gray-100 p-2 rounded">Note: \${inc.notes}</div>\` : ''}
            \`;
            logContainer.appendChild(row);
        });

        // Init Map
        const map = L.map('report-map').setView([49.123, 8.404], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; OpenStreetMap contributors'
        }).addTo(map);

        // Add Layers
        const group = new L.FeatureGroup();
        
        sections.forEach(sec => {
            if(sec.boundary && sec.boundary.length >= 3) {
                const poly = L.polygon(sec.boundary, { color: sec.color, fillColor: sec.color, fillOpacity: 0.2 }).addTo(group);
                poly.bindTooltip(sec.name, {permanent:true, direction:'center'});
            }
        });

        incidents.forEach(inc => {
            if(inc.lat) {
                const color = inc.status === 'completed' ? '#6b7280' : (inc.status === 'dispatched' ? '#3b82f6' : '#ef4444');
                const marker = L.circleMarker([inc.lat, inc.lon], {
                    radius: 6, fillColor: color, color: '#fff', weight: 2, opacity: 1, fillOpacity: 1
                }).addTo(group);
                marker.bindPopup(\`<b>\${inc.keyword}</b><br>\${inc.formattedAddress}\`);
            }
        });

        if(group.getLayers().length > 0) map.fitBounds(group.getBounds().pad(0.1));
    <\/script>
</body>
</html>`;

            const blob = new Blob([reportHTML], {type:'text/html'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`Einsatzbericht_${Date.now()}.html`; a.click();
        };

        window.addEventListener('online', () => els.modals.offline.classList.add('hidden'));
        window.addEventListener('offline', () => {
            els.modals.offline.classList.remove('hidden');
            document.getElementById('offline-incident-report').innerHTML = Array.from(incidents.values()).map(i => `<div class="p-2 border-b border-gray-200"><b class="text-gray-900">${i.keyword}</b><br><span class="text-gray-600">${i.formattedAddress}</span></div>`).join('');
        });

    </script>
</body>
</html>
