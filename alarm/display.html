<!DOCTYPE html>
<html lang="de" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alarm-Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100vh;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Scrollen auf Body-Ebene verhindern */
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            height: 100vh; /* Volle Viewport-Höhe */
            width: 100%;
            gap: 1.5rem; /* Abstand zwischen Spalten */
            padding: 1.5rem; /* Außenabstand */
        }
        .content-column {
            /* Jede Spalte scrollt NICHT MEHR */
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Abstand zwischen Boxen */
            min-height: 0; 
            height: 100%; /* Spalten füllen die Höhe */
        }
        .detail-box {
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            flex-shrink: 0; /* Verhindert das Schrumpfen der Boxen, außer bei flex-1 */
        }
        .detail-box h2 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* semibold */
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #374151; /* gray-700 */
            margin-bottom: 0.75rem;
        }

        /* Status-Farben (werden für die Status-Kreise verwendet) */
        .status-0 { background-color: #4b5563; color: #e5e7eb; } /* gray-600 */
        .status-1 { background-color: #16a34a; color: #ffffff; } /* green-600 */
        .status-2 { background-color: #15803d; color: #ffffff; } /* green-700 */
        .status-3 { background-color: #f97316; color: #ffffff; } /* orange-500 */
        .status-4 { background-color: #dc2626; color: #ffffff; } /* red-600 */
        .status-5 { background-color: #2563eb; color: #ffffff; } /* blue-600 */
        .status-6 { background-color: #6b7280; color: #ffffff; } /* gray-500 */
    </style>
</head>
<body class="h-full text-gray-200 antialiased">
    
    <!-- Bildschirmschoner / Uhrzeit -->
    <div id="screensaver" class="fixed inset-0 z-10 flex items-center justify-center bg-gray-900 transition-opacity duration-1000">
        <div id="clock" class="text-9xl font-black text-gray-700 select-none">
            00:00:00
        </div>
    </div>

    <!-- Haupt-Alarm-Ansicht -->
    <div id="alarm-view" class="fixed inset-0 z-20 transition-opacity duration-500 opacity-0 pointer-events-none" style="background: radial-gradient(circle, #2b0000 0%, #000000 100%);">
        
        <div class="grid-container">
            
            <!-- LINKE SPALTE: Infos -->
            <div class="content-column">
                
                <!-- Stichwort & Schlagwort -->
                <div class="detail-box">
                    <!-- Schriftgröße angepasst -->
                    <div id="alarm-stichwort-schlagwort" class="text-4xl font-bold text-red-500 break-words">
                        LADE EINSATZ...
                    </div>
                </div>

                <!-- Adresse -->
                <div class="detail-box">
                    <h2 class="text-red-400">Adresse</h2>
                    <!-- Schriftgröße angepasst -->
                    <div id="alarm-adresse" class="text-3xl font-medium text-white break-words">-</div>
                </div>

                <!-- Zeit-Infos -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="detail-box">
                        <h2 class="text-yellow-400">Alarmzeit</h2>
                        <!-- Schriftgröße angepasst -->
                        <div id="alarm-timestamp" class="text-2xl font-bold text-white">-</div>
                    </div>
                    <div class="detail-box">
                        <h2 class="text-yellow-400">Aktuelle Zeit</h2>
                        <!-- Schriftgröße angepasst -->
                        <div id="current-time" class="text-2xl font-bold text-white">-</div>
                    </div>
                </div>

                <!-- Sonderechte -->
                <div class="detail-box">
                    <h2 class="text-yellow-400">Sonderechte</h2>
                    <!-- Schriftgröße angepasst -->
                    <div id="alarm-sonderechte" class="text-2xl font-bold text-white">-</div>
                </div>

                <!-- Zusatz-Infos (Freitext) -->
                <!-- NEU: flex-1, flex, flex-col. Diese Box füllt den restlichen Platz -->
                <div id="freitext-box" class="detail-box hidden flex-1 flex flex-col">
                    <h2 class="text-gray-400">Zusatz-Infos</h2>
                    <!-- NEU: flex-1 und overflow-hidden. Text wird abgeschnitten, wenn er nicht passt -->
                    <div id="alarm-freitext" class="text-lg text-gray-200 italic break-words flex-1 overflow-hidden">-</div>
                </div>

            </div>
            
            <!-- RECHTE SPALTE: Fahrzeug-Status -->
            <div class="content-column">
                <!-- Alarmierte Fahrzeuge (HIER KOMMT DER STATUS REIN) -->
                <!-- NEU: flex-1 (füllt die Spalte), flex, flex-col -->
                <div class="detail-box flex-1 flex flex-col"> 
                    <h2 class="text-blue-400">Alarmierte Fahrzeuge & Status</h2>
                    <!-- NEU: overflow-hidden. Liste wird abgeschnitten, wenn sie nicht passt -->
                    <div id="alarm-fahrzeuge" class="flex flex-col space-y-3 overflow-hidden"> 
                        <span class="text-gray-400 italic">...</span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, onSnapshot, query, where, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ----- KONFIGURATION -----
        const firebaseConfig = {
          apiKey: "AIzaSyAUmkqte2nAP9XOPfKZvK54aYXIZXtwoQc",
          authDomain: "alert-display.firebaseapp.com",
          projectId: "alert-display",
          storageBucket: "alert-display.firebasestorage.app",
          messagingSenderId: "731953568741",
          appId: "1:731953568741:web:49be862b329dd4f71bad0c",
          measurementId: "G-3BX1HB9RXZ"
        };
        
        let app, auth, db, userId;
        let settingsDocRef, operationsCollectionRef, vehicleStatusCollectionRef;
        let homeAddress = "Feuerwehrhaus";
        
        let allVehicleStatuses = new Map(); 
        let currentAlarmData = null; 

        const screensaver = document.getElementById('screensaver');
        const clock = document.getElementById('clock');
        const alarmView = document.getElementById('alarm-view');
        
        const alarmStichwortSchlagwort = document.getElementById('alarm-stichwort-schlagwort');
        const alarmAdresse = document.getElementById('alarm-adresse');
        const alarmTimestamp = document.getElementById('alarm-timestamp');
        const currentTime = document.getElementById('current-time');
        const alarmSonderechte = document.getElementById('alarm-sonderechte');
        const alarmFahrzeuge = document.getElementById('alarm-fahrzeuge');
        const freitextBox = document.getElementById('freitext-box');
        const alarmFreitext = document.getElementById('alarm-freitext');

        // ----- Uhrzeit-Logik -----
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('de-DE');
            clock.textContent = timeString;
            currentTime.textContent = timeString;
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ----- App-Initialisierung & Auth -----
        async function authInit() {
            onAuthStateChanged(auth, async user => {
                if (user) {
                    userId = user.uid;
                    settingsDocRef = doc(db, "settings", "mainSettings");
                    operationsCollectionRef = collection(db, "operations");
                    vehicleStatusCollectionRef = collection(db, "vehicleStatus"); 

                    await loadSettings();
                    listenForActiveAlarms();
                    listenToAllVehicleStatuses(); 
                } else {
                    await signInAnonymously(auth);
                }
            });
        }

        async function loadSettings() {
            try {
                const snap = await getDoc(settingsDocRef);
                if (snap.exists() && snap.data().address) {
                    homeAddress = snap.data().address;
                }
            } catch (error) {
                console.error("Fehler beim Laden der Einstellungen:", error);
            }
        }

        // ----- DATENBANK-LISTENER -----

        function listenForActiveAlarms() {
            const q = query(operationsCollectionRef, where("isActive", "==", true));
            
            onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    const alarm = snapshot.docs[0];
                    currentAlarmData = alarm.data(); 
                    
                    updateAlarmDisplay(currentAlarmData); 
                    renderFahrzeuge(); 
                    showScreensaver(false);
                    
                } else {
                    currentAlarmData = null; 
                    showScreensaver(true);
                }
            }, (error) => {
                console.error("Fehler beim Abhören der Einsätze:", error);
                showScreensaver(true);
            });
        }

        function listenToAllVehicleStatuses() {
            onSnapshot(vehicleStatusCollectionRef, (snapshot) => {
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    allVehicleStatuses.set(doc.id, data.currentStatus || 0);
                });
                
                if (currentAlarmData) {
                    renderFahrzeuge();
                }
            }, (error) => {
                console.error("Fehler beim Abhören des Fahrzeugstatus:", error);
            });
        }


        // ----- UI-UPDATE FUNKTIONEN -----

        function renderFahrzeuge() {
            alarmFahrzeuge.innerHTML = ''; 
            
            if (!currentAlarmData || !currentAlarmData.fahrzeuge) {
                alarmFahrzeuge.innerHTML = '<span class="text-gray-400 italic">Keine Fahrzeuge alarmiert.</span>';
                return;
            }

            currentAlarmData.fahrzeuge.forEach(vehicleName => {
                const statusNum = allVehicleStatuses.get(vehicleName) || 0;
                
                const itemEl = document.createElement('div');
                // Schriftgröße angepasst
                itemEl.className = 'flex justify-between items-center text-xl font-semibold p-3 bg-gray-700 rounded-lg shadow-md';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = vehicleName;
                nameSpan.className = 'text-white';

                const statusSpan = document.createElement('span');
                // Größe angepasst
                statusSpan.className = `flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg status-${statusNum}`;
                statusSpan.textContent = statusNum; 
                
                itemEl.appendChild(nameSpan);
                itemEl.appendChild(statusSpan);
                alarmFahrzeuge.appendChild(itemEl);
            });
        }
        
        function updateAlarmDisplay(data) {
            alarmStichwortSchlagwort.textContent = `${data.stichwort} - ${data.schlagwort}`;
            alarmAdresse.textContent = data.adresse;
            
            if (data.timestamp && data.timestamp.seconds) {
                alarmTimestamp.textContent = new Date(data.timestamp.seconds * 1000).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) + " Uhr";
            } else {
                alarmTimestamp.textContent = '-';
            }

            alarmSonderechte.textContent = data.sonderechte ? "JA" : "NEIN";
            alarmSonderechte.classList.toggle('text-yellow-400', data.sonderechte);
            alarmSonderechte.classList.toggle('text-gray-500', !data.sonderechte);

            if (data.freitext) {
                alarmFreitext.textContent = `"${data.freitext}"`;
                freitextBox.classList.remove('hidden');
            } else {
                freitextBox.classList.add('hidden');
            }
        }

        function showScreensaver(show) {
            if (show) {
                screensaver.classList.remove('opacity-0');
                alarmView.classList.add('opacity-0', 'pointer-events-none');
            } else {
                screensaver.classList.add('opacity-0');
                alarmView.classList.remove('opacity-0', 'pointer-events-none');
            }
        }
        
        // ----- APP-START -----
        function initializeAppLogic() {
            setLogLevel('Debug');
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            authInit();
        }

        window.addEventListener('DOMContentLoaded', initializeAppLogic);

    </script>
</body>
</html>
