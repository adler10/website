<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alarm-Eingabe-Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { 
            border-bottom-color: #3b82f6; /* blue-600 */
            color: #3b82f6;
            font-weight: 600;
        }
        /* Style für ein sanftes Einblenden von Modals */
        .modal-hidden {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }
        .modal-visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* NEU: Styling für das Sprechwunsch-Popup */
        .sprechwunsch-popup {
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid #f87171; /* red-400 */
            background-color: #fef2f2; /* red-50 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-8">Alarm-Eingabe-Panel</h1>

        <!-- Tab-Navigation -->
        <div class="mb-6 border-b border-gray-300">
            <nav class="flex -mb-px space-x-8">
                <button class="tab-button active py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap focus:outline-none" data-tab="tab-manage">
                    Einsätze Verwalten
                </button>
                <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap focus:outline-none" data-tab="tab-create">
                    Einsatz Erstellen
                </button>
                <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap focus:outline-none" data-tab="tab-settings">
                    Einstellungen
                </button>
            </nav>
        </div>

        <!-- Tab 1: Einsätze Verwalten -->
        <div id="tab-manage" class="tab-content active space-y-8">
            <!-- Aktive Einsätze -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-900 mb-2 border-b-2 border-red-500 pb-2 inline-block">Aktive Einsätze</h2>
                <div id="activeOperationsContainer" class="space-y-4 mt-4">
                    <p class="text-gray-500">Keine aktiven Einsätze.</p>
                    <!-- Aktive Einsätze werden hier von JS eingefügt -->
                    <!-- 
                    Template (wird von JS genutzt):
                    <div class="border border-gray-300 bg-gray-50 rounded-lg p-4 shadow-sm">
                        <div class="flex flex-wrap justify-between items-center mb-3">
                            <h3 class="text-xl font-bold text-red-700">[B 3] Brand Wohnung</h3>
                            <span class="text-sm font-medium text-gray-600">[Uhrzeit]</span>
                        </div>
                        <p class="text-gray-700 mb-1"><span class="font-semibold">Ort:</span> [Adresse]</p>
                        <p class="text-gray-700 mb-4"><span class="font-semibold">Fahrzeuge:</span> [Fahrzeugliste]</p>
                        <div class="flex flex-wrap gap-3">
                            <button class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow transition duration-150">Bearbeiten</button>
                            <button class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg shadow transition duration-150">Protokoll</button>
                            <button class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg shadow transition duration-150">Beenden</button>
                        </div>
                    </div>
                    -->
                </div>
            </div>

            <!-- Vorbereitete Einsätze -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-900 mb-2 border-b-2 border-blue-500 pb-2 inline-block">Vorbereitete Einsätze</h2>
                <div id="preppedOperationsContainer" class="space-y-4 mt-4">
                    <p class="text-gray-500">Keine vorbereiteten Einsätze.</p>
                    <!-- Vorbereitete Einsätze werden hier von JS eingefügt -->
                </div>
            </div>
        </div>

        <!-- Tab 2: Einsatz Erstellen -->
        <div id="tab-create" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                <form id="createOperationForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="stichwort" class="block text-sm font-medium text-gray-700 mb-1">Stichwort</label>
                            <input type="text" id="stichwort" list="stichwort-list" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" autocomplete="off">
                            <datalist id="stichwort-list"></datalist>
                        </div>
                        <div>
                            <label for="schlagwort" class="block text-sm font-medium text-gray-700 mb-1">Schlagwort</label>
                            <input type="text" id="schlagwort" list="schlagwort-list" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" autocomplete="off">
                            <datalist id="schlagwort-list"></datalist>
                        </div>
                    </div>
                    <div>
                        <label for="adresse" class="block text-sm font-medium text-gray-700 mb-1">Adresse</label>
                        <input type="text" id="adresse" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-2">Alarmierte Fahrzeuge</span>
                        <div id="fahrzeug-checkboxes-create" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200 max-h-60 overflow-y-auto">
                            <!-- Checkboxen werden hier von JS eingefügt -->
                        </div>
                    </div>
                    
                    <div>
                        <span class="block text-sm font-medium text-gray-700">Sonderechte freigegeben?</span>
                        <div class="mt-2 flex items-center space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="sonderechte" value="ja" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="ml-2 text-gray-700">Ja</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="sonderechte" value="nein" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                                <span class="ml-2 text-gray-700">Nein</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label for="freitext" class="block text-sm font-medium text-gray-700 mb-1">Freitext / Zusatz-Infos</label>
                        <textarea id="freitext" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                    
                    <div class="flex flex-wrap gap-4 pt-4 border-t border-gray-200">
                        <button type="submit" data-action="alarm" class="px-6 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-150 transform hover:scale-105">
                            SOFORT ALARMIEREN
                        </button>
                        <button type="submit" data-action="prepare" class="px-6 py-3 font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 transform hover:scale-105">
                            Einsatz Vorbereiten
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab 3: Einstellungen -->
        <div id="tab-settings" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 space-y-8">
                <!-- Adresse FW-Haus -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-3">Adresse Feuerwehrhaus</h2>
                    <div class="flex gap-4">
                        <input type="text" id="homeAddress" placeholder="z.B. Musterstraße 1, 12345 Musterstadt" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button id="saveHomeAddress" class="px-5 py-2 font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow transition duration-150">Speichern</button>
                    </div>
                </div>

                <!-- Fahrzeuge verwalten -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-3">Fahrzeuge Verwalten</h2>
                    <div class="flex gap-4 mb-4">
                        <input type="text" id="newVehicleName" placeholder="z.B. LH 19-1" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button id="addVehicle" class="px-5 py-2 font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg shadow transition duration-150">Hinzufügen</button>
                    </div>
                    <div id="vehicleList" class="p-4 bg-gray-50 rounded-lg border border-gray-200 max-h-80 overflow-y-auto space-y-2">
                        <!-- Fahrzeug-Liste wird hier von JS eingefügt -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit-Modal (wird wiederverwendet) -->
    <div id="editModal" class="modal-hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">Einsatz Bearbeiten</h2>
                <button id="editModalClose" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto">
                <input type="hidden" id="editOperationId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="editStichwort" class="block text-sm font-medium text-gray-700 mb-1">Stichwort</label>
                        <input type="text" id="editStichwort" list="stichwort-list" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" autocomplete="off">
                    </div>
                    <div>
                        <label for="editSchlagwort" class="block text-sm font-medium text-gray-700 mb-1">Schlagwort</label>
                        <input type="text" id="editSchlagwort" list="schlagwort-list" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" autocomplete="off">
                    </div>
                </div>
                <div>
                    <label for="editAdresse" class="block text-sm font-medium text-gray-700 mb-1">Adresse</label>
                    <input type="text" id="editAdresse" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <span class="block text-sm font-medium text-gray-700 mb-2">Alarmierte Fahrzeuge</span>
                    <div id="fahrzeug-checkboxes-edit" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200 max-h-60 overflow-y-auto">
                        <!-- Checkboxen für Edit-Modal -->
                    </div>
                </div>
                <div>
                    <span class="block text-sm font-medium text-gray-700">Sonderechte freigegeben?</span>
                    <div class="mt-2 flex items-center space-x-6">
                        <label class="flex items-center">
                            <input type="radio" name="editSonderechte" value="ja" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-gray-700">Ja</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="editSonderechte" value="nein" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-gray-700">Nein</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="editFreitext" class="block text-sm font-medium text-gray-700 mb-1">Freitext / Zusatz-Infos</label>
                    <textarea id="editFreitext" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
            </div>
            <div class="flex justify-end p-6 bg-gray-50 border-t border-gray-200 rounded-b-2xl space-x-4">
                <button id="saveOperationChanges" class="px-6 py-3 font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150">
                    Änderungen Speichern
                </button>
            </div>
        </div>
    </div>
    
    <!-- NEU: Protokoll-Modal -->
    <div id="logModal" class="modal-hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 id="logModalTitle" class="text-2xl font-bold text-gray-900">Einsatz-Protokoll</h2>
                <button id="logModalClose" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="logContent" class="p-6 space-y-4 overflow-y-auto">
                <!-- Protokoll-Einträge werden hier von JS eingefügt -->
                <p class="text-gray-500">Protokoll wird geladen...</p>
            </div>
        </div>
    </div>

    <!-- NEU: Sprechwunsch-Popup (klein, unten rechts) -->
    <div id="sprechwunschModal" class="modal-hidden fixed bottom-6 right-6 z-50 w-full max-w-sm">
        <div class="sprechwunsch-popup rounded-lg p-5">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <!-- Rotes Funk-Icon -->
                    <svg class="h-8 w-8 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15c-1.12 0-2.163-.306-3.072-.828M12 15c1.12 0 2.163-.306 3.072-.828m-3.072.828l.14.091m-3.212-.919A9.75 9.75 0 015.25 6.75m13.5 0A9.75 9.75 0 0012 3.75m0 0A9.75 9.75 0 005.25 6.75M12 3.75c1.12 0 2.163.306 3.072.828" />
                    </svg>
                </div>
                <div class="ml-4 flex-1">
                    <h3 class="text-lg font-bold text-red-800">SPRECHWUNSCH!</h3>
                    <p id="sprechwunschVehicleName" class="text-gray-700 mt-1">Fahrzeug [Name] wünscht Sprechkontakt.</p>
                    <div class="mt-4 flex gap-4">
                        <button id="sprechwunschButtonJ" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg shadow transition duration-150">
                            "J" Senden (Kommen)
                        </button>
                        <button id="sprechwunschModalClose" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg border border-gray-300 transition duration-150">
                            Schließen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, addDoc, collection, onSnapshot, query, where, serverTimestamp, setLogLevel, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ----- KONFIGURATION -----
        const firebaseConfig = {
          apiKey: "AIzaSyAUmkqte2nAP9XOPfKZvK54aYXIZXtwoQc",
          authDomain: "alert-display.firebaseapp.com",
          projectId: "alert-display",
          storageBucket: "alert-display.firebasestorage.app",
          messagingSenderId: "731953568741",
          appId: "1:731953568741:web:49be862b329dd4f71bad0c",
          measurementId: "G-3BX1HB9RXZ"
        };
        
        // Stichwort-Schlagwort-Map (gekürzt zur Übersicht)
        const stichwortMap = {
            "B 1": ["B - Fläche klein (< 10m x 10m)", "B - Gasgeruch im Freien", "B - Kleinfeuer"],
            "B 2": ["B - Alarmstufenerhöhung auf B 2", "B - Bus", "B - Campingplatz"],
            "B 3": ["B - Alarmstufenerhöhung auf B 3", "B - Baustelle", "B - Bordell / Laufhaus", "B - Wohnung", "B - Zimmer"],
            "B - BMA": ["B - Auslösung BMA", "B - Auslösung Löschanlage"],
            "TH 1": ["TH - Ast / Baum entfernen", "TH - Fahrbahn reinigen / aufräumen"],
            "TH 3": ["TH - Notfalltüröffnung", "TH - Notfalltüröffnung + NA", "TH - Türöffnung"],
            // ... (Rest deiner Liste)
        };
        const allStichworte = Object.keys(stichwortMap);
        
        let app, auth, db, userId;
        let settingsDocRef, operationsCollectionRef, vehicleStatusCollectionRef;
        let globalVehicleList = []; // Globale Liste aller Fahrzeuge
        
        // NEU: Für Sprechwunsch-Logik
        let activeSprechwunschVehicleId = null;
        let handledSprechwunschIds = new Set(); // Verhindert Pop-up-Spam

        // DOM-Elemente
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Settings
        const homeAddressInput = document.getElementById('homeAddress');
        const saveHomeAddressBtn = document.getElementById('saveHomeAddress');
        const newVehicleNameInput = document.getElementById('newVehicleName');
        const addVehicleBtn = document.getElementById('addVehicle');
        const vehicleListDiv = document.getElementById('vehicleList');

        // Create
        const createForm = document.getElementById('createOperationForm');
        const stichwortInput = document.getElementById('stichwort');
        const schlagwortInput = document.getElementById('schlagwort');
        const stichwortList = document.getElementById('stichwort-list');
        const schlagwortList = document.getElementById('schlagwort-list');
        const fahrzeugCheckboxesCreate = document.getElementById('fahrzeug-checkboxes-create');

        // Manage
        const activeOperationsContainer = document.getElementById('activeOperationsContainer');
        const preppedOperationsContainer = document.getElementById('preppedOperationsContainer');
        
        // Edit Modal
        const editModal = document.getElementById('editModal');
        const editModalClose = document.getElementById('editModalClose');
        const saveOperationChangesBtn = document.getElementById('saveOperationChanges');
        const fahrzeugCheckboxesEdit = document.getElementById('fahrzeug-checkboxes-edit');
        
        // NEU: Log Modal
        const logModal = document.getElementById('logModal');
        const logModalTitle = document.getElementById('logModalTitle');
        const logModalClose = document.getElementById('logModalClose');
        const logContent = document.getElementById('logContent');
        
        // NEU: Sprechwunsch Modal
        const sprechwunschModal = document.getElementById('sprechwunschModal');
        const sprechwunschVehicleName = document.getElementById('sprechwunschVehicleName');
        const sprechwunschButtonJ = document.getElementById('sprechwunschButtonJ');
        const sprechwunschModalClose = document.getElementById('sprechwunschModalClose');


        // ----- UTILITY FUNKTIONEN -----
        
        // Formatiert Datum/Zeit
        function formatFirebaseTimestamp(timestamp) {
            if (!timestamp || !timestamp.seconds) return 'N/A';
            return new Date(timestamp.seconds * 1000).toLocaleString('de-DE', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }
        
        // Schaltet Tabs um
        function switchTab(targetTabId) {
            tabContents.forEach(content => content.classList.remove('active'));
            tabButtons.forEach(button => button.classList.remove('active'));
            
            document.getElementById(targetTabId).classList.add('active');
            document.querySelector(`.tab-button[data-tab="${targetTabId}"]`).classList.add('active');
        }

        // Füllt die Stichwort-Vorschläge
        function populateStichwortList() {
            stichwortList.innerHTML = '';
            allStichworte.forEach(stichwort => {
                stichwortList.innerHTML += `<option value="${stichwort}">`;
            });
        }

        // Aktualisiert Schlagwort-Vorschläge basierend auf Stichwort
        function updateSchlagwortList(e) {
            const selectedStichwort = e.target.value;
            schlagwortList.innerHTML = '';
            if (stichwortMap[selectedStichwort]) {
                stichwortMap[selectedStichwort].forEach(schlagwort => {
                    schlagwortList.innerHTML += `<option value="${schlagwort}">`;
                });
            }
        }
        
        // Rendert die Checkboxen für die Fahrzeugauswahl
        function renderVehicleCheckboxes(containerElement, selectedVehicles = []) {
            containerElement.innerHTML = '';
            if (globalVehicleList.length === 0) {
                containerElement.innerHTML = '<p class="text-gray-500 col-span-full">Keine Fahrzeuge in den Einstellungen definiert.</p>';
                return;
            }
            globalVehicleList.forEach(vehicle => {
                const isChecked = selectedVehicles.includes(vehicle);
                containerElement.innerHTML += `
                    <label class="flex items-center space-x-2 p-2 rounded-md bg-gray-100 hover:bg-gray-200 transition duration-150 cursor-pointer">
                        <input type="checkbox" value="${vehicle}" ${isChecked ? 'checked' : ''} class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-800">${vehicle}</span>
                    </label>
                `;
            });
        }
        
        // Holt die ausgewählten Fahrzeuge aus einem Checkbox-Container
        function getSelectedVehicles(containerElement) {
            const vehicles = [];
            containerElement.querySelectorAll('input[type="checkbox"]:checked').forEach(input => {
                vehicles.push(input.value);
            });
            return vehicles;
        }


        // ----- CORE APP-LOGIK (Firebase) -----

        // 1. App-Initialisierung & Auth
        async function authInit() {
            onAuthStateChanged(auth, async user => {
                if (user) {
                    userId = user.uid;
                    // Referenzen setzen
                    settingsDocRef = doc(db, "settings", "mainSettings");
                    operationsCollectionRef = collection(db, "operations");
                    vehicleStatusCollectionRef = collection(db, "vehicleStatus");

                    // Listener starten
                    loadSettings(); // Lädt Adresse und Fahrzeugliste (startet auch Listener)
                    listenForOperations();
                    listenForSprechwunsch(); // NEUER LISTENER
                } else {
                    await signInAnonymously(auth);
                }
            });
        }

        // 2. Einstellungen (Adresse & Fahrzeuge)
        async function loadSettings() {
            onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    homeAddressInput.value = data.address || '';
                    globalVehicleList = data.vehicles || [];
                    
                    // Fahrzeugliste im Einstellungs-Tab rendern
                    vehicleListDiv.innerHTML = '';
                    if (globalVehicleList.length > 0) {
                        globalVehicleList.forEach(vehicle => {
                            vehicleListDiv.innerHTML += `
                                <div class="flex justify-between items-center p-2 bg-white rounded shadow-sm border border-gray-200">
                                    <span class="font-medium text-gray-700">${vehicle}</span>
                                    <button data-vehicle="${vehicle}" class="delete-vehicle-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
                                </div>
                            `;
                        });
                    } else {
                        vehicleListDiv.innerHTML = '<p class="text-gray-500 italic">Noch keine Fahrzeuge hinzugefügt.</p>';
                    }
                    
                    // Checkboxen in Erstellen- und Edit-Modal neu rendern
                    renderVehicleCheckboxes(fahrzeugCheckboxesCreate);
                    renderVehicleCheckboxes(fahrzeugCheckboxesEdit);
                }
            }, (error) => console.error("Fehler beim Laden der Einstellungen: ", error));
        }

        async function saveHomeAddress() {
            await setDoc(settingsDocRef, { address: homeAddressInput.value }, { merge: true });
        }

        async function addVehicle() {
            const newVehicle = newVehicleNameInput.value.trim();
            if (newVehicle && !globalVehicleList.includes(newVehicle)) {
                const updatedList = [...globalVehicleList, newVehicle].sort();
                await setDoc(settingsDocRef, { vehicles: updatedList }, { merge: true });
                newVehicleNameInput.value = '';
            }
        }

        async function deleteVehicle(e) {
            if (!e.target.classList.contains('delete-vehicle-btn')) return;
            const vehicleToDelete = e.target.dataset.vehicle;
            const updatedList = globalVehicleList.filter(v => v !== vehicleToDelete);
            await setDoc(settingsDocRef, { vehicles: updatedList }, { merge: true });
        }

        // 3. Einsätze Erstellen & Senden
        async function handleFormSubmit(e) {
            e.preventDefault();
            const action = e.submitter.dataset.action; // 'alarm' or 'prepare'
            
            const operationData = {
                stichwort: document.getElementById('stichwort').value,
                schlagwort: document.getElementById('schlagwort').value,
                adresse: document.getElementById('adresse').value,
                fahrzeuge: getSelectedVehicles(fahrzeugCheckboxesCreate),
                sonderechte: document.querySelector('input[name="sonderechte"]:checked').value === 'ja',
                freitext: document.getElementById('freitext').value,
                isPrepped: action === 'prepare',
                isActive: action === 'alarm',
                timestamp: serverTimestamp() // Setzt Zeitstempel
            };

            // Validierung (einfach)
            if (!operationData.stichwort || !operationData.schlagwort || !operationData.adresse) {
                console.error("Bitte alle Felder ausfüllen."); // Später durch UI-Feedback ersetzen
                return;
            }

            try {
                const docRef = await addDoc(operationsCollectionRef, operationData);
                console.log("Einsatz erstellt mit ID: ", docRef.id);
                
                // NEU: Wenn sofort alarmiert wird, "C" senden
                if (operationData.isActive) {
                    await sendCommandToVehicles(operationData.fahrzeuge, "C", "Neuer Alarm");
                }
                
                createForm.reset(); // Formular zurücksetzen
                renderVehicleCheckboxes(fahrzeugCheckboxesCreate); // Checkboxen zurücksetzen
                switchTab('tab-manage'); // Zum Verwalten-Tab wechseln
            } catch (error) {
                console.error("Fehler beim Erstellen des Einsatzes: ", error);
            }
        }

        // 4. Einsätze Verwalten (Anzeigen)
        function listenForOperations() {
            const q = query(operationsCollectionRef, orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                activeOperationsContainer.innerHTML = '';
                preppedOperationsContainer.innerHTML = '';
                let activeCount = 0;
                let preppedCount = 0;

                snapshot.docs.forEach(doc => {
                    const operation = doc.data();
                    const id = doc.id;
                    const time = operation.timestamp ? formatFirebaseTimestamp(operation.timestamp) : 'N/A';
                    
                    const fahrzeugeListe = operation.fahrzeuge.length > 0 
                        ? operation.fahrzeuge.join(', ') 
                        : 'Keine';

                    if (operation.isActive) {
                        // Aktive Einsätze
                        activeCount++;
                        activeOperationsContainer.innerHTML += `
                            <div class="border border-red-300 bg-red-50 rounded-lg p-4 shadow-sm">
                                <div class="flex flex-wrap justify-between items-center mb-3">
                                    <h3 class="text-xl font-bold text-red-700">${operation.stichwort} - ${operation.schlagwort}</h3>
                                    <span class="text-sm font-medium text-red-600">${time}</span>
                                </div>
                                <p class="text-gray-700 mb-1"><span class="font-semibold">Ort:</span> ${operation.adresse}</p>
                                <p class="text-gray-700 mb-4"><span class="font-semibold">Fahrzeuge:</span> ${fahrzeugeListe}</p>
                                <div class="flex flex-wrap gap-3">
                                    <button data-id="${id}" class="edit-op-btn px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow transition duration-150">Bearbeiten</button>
                                    <button data-id="${id}" class="log-op-btn px-4 py-2 text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 rounded-lg shadow transition duration-150">Protokoll</button>
                                    <button data-id="${id}" class="end-op-btn px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg shadow transition duration-150">Beenden</button>
                                </div>
                            </div>
                        `;
                    } else if (operation.isPrepped) {
                        // Vorbereitete Einsätze
                        preppedCount++;
                        preppedOperationsContainer.innerHTML += `
                            <div class="border border-blue-300 bg-blue-50 rounded-lg p-4 shadow-sm">
                                <h3 class="text-xl font-bold text-blue-700">${operation.stichwort} - ${operation.schlagwort}</h3>
                                <p class="text-gray-700 mb-1 mt-2"><span class="font-semibold">Ort:</span> ${operation.adresse}</p>
                                <p class="text-gray-700 mb-4"><span class="font-semibold">Fahrzeuge:</span> ${fahrzeugeListe}</p>
                                <div class="flex flex-wrap gap-3">
                                    <button data-id="${id}" class="trigger-op-btn px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg shadow transition duration-150">JETZT ALARMIEREN</button>
                                    <button data-id="${id}" class="edit-op-btn px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow transition duration-150">Bearbeiten</button>
                                    <button data-id="${id}" class="delete-op-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg shadow transition duration-150">Löschen</button>
                                </div>
                            </div>
                        `;
                    }
                });

                if (activeCount === 0) activeOperationsContainer.innerHTML = '<p class="text-gray-500">Keine aktiven Einsätze.</p>';
                if (preppedCount === 0) preppedOperationsContainer.innerHTML = '<p class="text-gray-500">Keine vorbereiteten Einsätze.</p>';
            });
        }
        
        // 5. Einsätze Verwalten (Aktionen)
        async function handleManageClick(e) {
            const target = e.target;
            const id = target.dataset.id;
            if (!id) return;
            
            const opDocRef = doc(db, "operations", id);

            try {
                // Einsatz Beenden
                if (target.classList.contains('end-op-btn')) {
                    await updateDoc(opDocRef, { isActive: false, isPrepped: false, isFinished: true });
                }
                // Einsatz Löschen (Vorbereitete)
                else if (target.classList.contains('delete-op-btn')) {
                    await deleteDoc(opDocRef);
                }
                // Einsatz Bearbeiten (Modal öffnen)
                else if (target.classList.contains('edit-op-btn')) {
                    const docSnap = await getDoc(opDocRef);
                    if (docSnap.exists()) {
                        openEditModal(id, docSnap.data());
                    }
                }
                // Einsatz Auslösen (Vorbereitete)
                else if (target.classList.contains('trigger-op-btn')) {
                    const updateData = {
                        isActive: true,
                        isPrepped: false,
                        timestamp: serverTimestamp() // Alarmzeit jetzt setzen
                    };
                    await updateDoc(opDocRef, updateData);
                    
                    // NEU: "C" senden, da jetzt alarmiert wird
                    const docSnap = await getDoc(opDocRef);
                    if(docSnap.exists()) {
                        await sendCommandToVehicles(docSnap.data().fahrzeuge, "C", "Neuer Alarm");
                    }
                }
                // NEU: Protokoll anzeigen
                else if (target.classList.contains('log-op-btn')) {
                    const docSnap = await getDoc(opDocRef);
                    if (docSnap.exists()) {
                        await showLog(docSnap.data());
                    }
                }
            } catch (error) {
                console.error("Fehler bei Einsatz-Aktion: ", error);
            }
        }
        
        // 6. Edit-Modal Logik
        function openEditModal(id, data) {
            document.getElementById('editOperationId').value = id;
            document.getElementById('editStichwort').value = data.stichwort;
            document.getElementById('editSchlagwort').value = data.schlagwort;
            document.getElementById('editAdresse').value = data.adresse;
            document.getElementById('editFreitext').value = data.freitext || '';
            
            // Sonderechte Radio-Buttons
            const sonderechteInputs = document.querySelectorAll('input[name="editSonderechte"]');
            sonderechteInputs.forEach(input => input.checked = (input.value === 'ja') === data.sonderechte);
            
            // Fahrzeug-Checkboxen
            renderVehicleCheckboxes(fahrzeugCheckboxesEdit, data.fahrzeuge);
            
            editModal.classList.remove('modal-hidden');
            editModal.classList.add('modal-visible');
        }

        function closeEditModal() {
            editModal.classList.add('modal-hidden');
            editModal.classList.remove('modal-visible');
        }
        
        async function saveChanges() {
            const id = document.getElementById('editOperationId').value;
            if (!id) return;
            
            const updatedData = {
                stichwort: document.getElementById('editStichwort').value,
                schlagwort: document.getElementById('editSchlagwort').value,
                adresse: document.getElementById('editAdresse').value,
                freitext: document.getElementById('editFreitext').value,
                sonderechte: document.querySelector('input[name="editSonderechte"]:checked').value === 'ja',
                fahrzeuge: getSelectedVehicles(fahrzeugCheckboxesEdit)
            };
            
            await updateDoc(doc(db, "operations", id), updatedData);
            closeEditModal();
        }
        
        // 7. NEU: Protokoll-Modal Logik
        function closeLogModal() {
            logModal.classList.add('modal-hidden');
            logModal.classList.remove('modal-visible');
        }

        async function showLog(operation) {
            logModalTitle.textContent = `Protokoll: ${operation.stichwort}`;
            logContent.innerHTML = '<div class="text-center"><p class="text-gray-600 animate-pulse">Lade Protokoll...</p></div>';
            logModal.classList.remove('modal-hidden');
            logModal.classList.add('modal-visible');
            
            let logHTML = '<ul class="space-y-3">';
            
            // 1. Alarmierungs-Eintrag
            logHTML += `
                <li class="flex items-center gap-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                    <span class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-red-500 text-white rounded-full font-bold">!</span>
                    <div>
                        <p class="font-semibold text-red-800">ALARMIERUNG</p>
                        <p class="text-sm text-gray-700">${formatFirebaseTimestamp(operation.timestamp)}</p>
                    </div>
                </li>
            `;
            
            // 2. Status-Historie für jedes Fahrzeug abrufen
            // (Erfordert, dass fahrzeug-display.html die Historie in /statusLog/ schreibt!)
            for (const vehicleName of operation.fahrzeuge) {
                logHTML += `<li class="pt-2"><h4 class="font-bold text-gray-800">${vehicleName}</h4><ul class="pl-4 border-l-2 border-gray-300 ml-5 py-2 space-y-2">`;
                
                try {
                    // Versuche, die Sub-Kollektion zu lesen
                    const logQuery = query(
                        collection(db, "vehicleStatus", vehicleName, "statusLog"), 
                        orderBy("timestamp", "desc")
                    );
                    const logSnap = await getDocs(logQuery);
                    
                    if (logSnap.empty) {
                        // Fallback: Nur aktuellen Status anzeigen
                        const statusSnap = await getDoc(doc(db, "vehicleStatus", vehicleName));
                        if (statusSnap.exists()) {
                            const data = statusSnap.data();
                            logHTML += `<li><span class="font-semibold">Status ${data.currentStatus}</span> (${data.statusText}) - ${formatFirebaseTimestamp(data.lastUpdated)}</li>`;
                        } else {
                            logHTML += `<li class="text-gray-500 italic">Keine Statusdaten gefunden.</li>`;
                        }
                    } else {
                        // Log-Historie anzeigen
                        logSnap.docs.forEach(doc => {
                            const data = doc.data();
                            logHTML += `<li><span class="font-semibold">Status ${data.status}</span> (${data.text}) - ${formatFirebaseTimestamp(data.timestamp)}</li>`;
                        });
                    }
                } catch (error) {
                    console.error(`Fehler beim Laden des Logs für ${vehicleName}:`, error);
                    logHTML += `<li class="text-red-500 italic">Protokoll konnte nicht geladen werden. (Index?)</li>`;
                }
                logHTML += `</ul></li>`;
            }
            logHTML += '</ul>';
            logContent.innerHTML = logHTML;
        }

        // 8. NEU: Sprechwunsch (Status 5) Logik
        
        /**
         * Hört auf alle Fahrzeuge, die Status 5 setzen UND bei denen 'sprechwunschAck' auf false steht.
         * Erfordert einen Composite-Index in Firestore!
         */
        function listenForSprechwunsch() {
            try {
                const q = query(
                    vehicleStatusCollectionRef, 
                    where("currentStatus", "==", 5),
                    where("sprechwunschAck", "==", false)
                );
                
                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) return; // Kein aktiver Sprechwunsch
                    
                    // Nimm den ersten, der reinkommt
                    const doc = snapshot.docs[0];
                    const vehicleId = doc.id;
                    
                    // Verhindern, dass derselbe Wunsch mehrmals angezeigt wird
                    if (handledSprechwunschIds.has(vehicleId)) return;
                    
                    activeSprechwunschVehicleId = vehicleId;
                    sprechwunschVehicleName.textContent = `${vehicleId} wünscht Sprechkontakt.`;
                    
                    sprechwunschModal.classList.remove('modal-hidden');
                    sprechwunschModal.classList.add('modal-visible');
                    
                    handledSprechwunschIds.add(vehicleId); // Als "gesehen" markieren
                });
                
            } catch (error) {
                console.error("Fehler beim Erstellen des Sprechwunsch-Listeners:", error);
                console.warn("Stelle sicher, dass der Firestore-Index für vehicleStatus (currentStatus ASC, sprechwunschAck ASC) existiert.");
            }
        }
        
        // Schickt "J" (Kommen) an das Fahrzeug
        async function sendJ() {
            if (!activeSprechwunschVehicleId) return;
            
            const vehicleRef = doc(db, "vehicleStatus", activeSprechwunschVehicleId);
            try {
                // Bestätigen (Ack) und Befehl "J" senden.
                // Die Mobile-App wird dies sehen und ihren Status zurücksetzen.
                await setDoc(vehicleRef, { 
                    sprechwunschAck: true, // Verhindert, dass der Listener hier erneut auslöst
                    lastCommand: {
                        type: "ACK",
                        code: "J",
                        message: "Sprechwunsch bestätigt, bitte kommen."
                    },
                    lastCommandTimestamp: serverTimestamp()
                }, { merge: true });
                
                closeSprechwunschModal();
            } catch (error) {
                console.error("Fehler beim Senden von 'J':", error);
            }
        }
        
        function closeSprechwunschModal() {
            sprechwunschModal.classList.add('modal-hidden');
            sprechwunschModal.classList.remove('modal-visible');
            // Erlaube, dass dasselbe Fahrzeug nach dem Schließen erneut anfragen kann
            if(activeSprechwunschVehicleId) {
                handledSprechwunschIds.delete(activeSprechwunschVehicleId);
            }
            activeSprechwunschVehicleId = null;
        }

        // 9. NEU: Befehle an Fahrzeuge senden (z.B. "C")
        async function sendCommandToVehicles(vehicleList, commandCode, message) {
            const command = {
                type: "ALARM",
                code: commandCode,
                message: message
            };
            
            for (const vehicleName of vehicleList) {
                try {
                    const vehicleRef = doc(db, "vehicleStatus", vehicleName);
                    await setDoc(vehicleRef, {
                        lastCommand: command,
                        lastCommandTimestamp: serverTimestamp()
                    }, { merge: true });
                } catch (error) {
                    console.error(`Fehler beim Senden von '${commandCode}' an ${vehicleName}:`, error);
                }
            }
            console.log(`Befehl '${commandCode}' an ${vehicleList.length} Fahrzeuge gesendet.`);
        }


        // ----- EVENT LISTENERS -----
        window.addEventListener('DOMContentLoaded', () => {
            setLogLevel('Debug');
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            authInit();
            populateStichwortList();

            // Tab-Navigation
            tabButtons.forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
            
            // Stichwort/Schlagwort Logik
            stichwortInput.addEventListener('input', updateSchlagwortList);
            document.getElementById('editStichwort').addEventListener('input', updateSchlagwortList);

            // Settings-Tab
            saveHomeAddressBtn.addEventListener('click', saveHomeAddress);
            addVehicleBtn.addEventListener('click', addVehicle);
            vehicleListDiv.addEventListener('click', deleteVehicle);
            
            // Create-Tab
            createForm.addEventListener('submit', handleFormSubmit);
            
            // Manage-Tab
            document.getElementById('tab-manage').addEventListener('click', handleManageClick);
            
            // Edit-Modal
            editModalClose.addEventListener('click', closeEditModal);
            saveOperationChangesBtn.addEventListener('click', saveChanges);
            
            // NEU: Log-Modal
            logModalClose.addEventListener('click', closeLogModal);
            
            // NEU: Sprechwunsch-Modal
            sprechwunschButtonJ.addEventListener('click', sendJ);
            sprechwunschModalClose.addEventListener('click', closeSprechwunschModal);
        });

    </script>
</body>
</html>
