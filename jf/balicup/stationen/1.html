<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ergebnisse Station 1 – Bali‑Cup 2025</title>
  <style>
    :root {
      --bg-dark: #222; --bg-light: #f5f5f5;
      --btn-bg-dark: #555; --btn-hover-dark: #444; --btn-border-dark: #666;
      --btn-bg-light: #e7e7e7; --btn-hover-light: #d7d7d7; --btn-border-light: #ccc;
    }
    body {
      margin: 20px; font-family: Arial, sans-serif;
      background: var(--bg-dark); color: #fff;
      transition: .3s;
    }
    body.light-mode {
      background: var(--bg-light); color: #333;
    }
    header { text-align: center; margin-bottom: 20px; }
    .container {
      max-width: 400px; margin: auto; padding: 20px;
      background: #333; border: 1px solid #444; border-radius: 4px;
    }
    body.light-mode .container {
      background: #fff; border-color: #ccc;
    }
    label, select, input, button {
      display: block; width: 100%; margin-top: 10px;
      font-size: 1em; padding: 8px; box-sizing: border-box;
    }
    button {
      cursor: pointer;
      background: var(--btn-bg-dark); border: 1px solid var(--btn-border-dark);
      color: #fff; transition: .3s;
    }
    button:hover { background: var(--btn-hover-dark); }
    body.light-mode button {
      background: var(--btn-bg-light); border-color: var(--btn-border-light);
      color: #333;
    }
    body.light-mode button:hover { background: var(--btn-hover-light); }

    #feedback {
      display: none; text-align: center; margin-top: 15px;
      padding: 8px; border-radius: 4px;
    }
    #feedback.success { background: #4caf50; color: #fff; }
    #feedback.error   { background: #f44336; color: #fff; }

    .teams-info { margin-top: 20px; }
    .teams-info h2 { margin-bottom: 10px; text-align: center; }
    .group-container { margin-bottom: 20px; }
    .team-card {
      margin: 8px 0; padding: 8px; border-radius: 4px; border: 1px solid;
      text-align: center;
    }
    .participated   { background: #388e3c; border-color: #2e7d32; color: #fff; }
    .not-participated { background: #d32f2f; border-color: #c62828; color: #fff; }
    body.light-mode .participated   { background: #81c784; border-color: #66bb6a; color: #333; }
    body.light-mode .not-participated { background: #e57373; border-color: #ef5350; color: #333; }

    .toggle-mode {
      position: fixed; bottom: 10px; right: 10px;
      padding: 4px 8px; font-size: 0.8em;
      border: 1px solid var(--btn-border-dark); background: var(--btn-bg-dark);
      color: #fff; cursor: pointer; transition: .3s;
      white-space: nowrap;
    }
    .toggle-mode:hover { background: var(--btn-hover-dark); }
    body.light-mode .toggle-mode {
      background: var(--btn-bg-light); border-color: var(--btn-border-light);
      color: #333;
    }
    body.light-mode .toggle-mode:hover { background: var(--btn-hover-light); }

    @media (max-width: 600px) {
      body { margin: 10px; }
      .container { padding: 15px; }
      header h1 { font-size: 1.3em; }
      .toggle-mode { bottom: 5px; right: 5px; padding: 3px 6px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Ergebnisse für Station 1 – Schätzspiel</h1>
  </header>

  <div class="container">
    <form id="resultForm">
      <label for="teamSelect">Team auswählen:</label>
      <select id="teamSelect" required>
        <option value="" disabled selected>Bitte wählen</option>
      </select>

      <label for="points">Punkte:</label>
      <input type="number" id="points" min="0" placeholder="0" required>

      <button type="submit">Speichern</button>
    </form>

    <div id="feedback"></div>

    <div class="teams-info" id="teamsInfo"></div>
  </div>

  <button class="toggle-mode" onclick="toggleMode()">Light</button>

  <script type="module">
    const stationNumber = 1;
    const app = initializeApp({
      apiKey: "...", authDomain: "bali-cup2025.firebaseapp.com",
      projectId: "bali-cup2025", storageBucket: "", messagingSenderId: "",
      appId: "", measurementId: ""
    });
    const db = getFirestore(app);

    // Dropdown befüllen (nur confirmed=true)
    async function loadTeamsDropdown() {
      const sel = document.getElementById('teamSelect');
      sel.innerHTML = '<option value="" disabled selected>Bitte wählen</option>';
      const snaps = await getDocs(collection(db, 'teams'));
      const groups = { normal: [], kinder: [] };

      snaps.forEach(s => {
        const d = s.data();
        if (!d.confirmed || (d['station'+stationNumber] || 0) > 0) return;
        const key = d.teamType.toLowerCase() === 'kindergruppe' ? 'kinder' : 'normal';
        groups[key].push({ id: s.id, name: d.teamName });
      });

      ['normal','kinder'].forEach(type => {
        if (groups[type].length) {
          groups[type].sort((a,b)=>a.name.localeCompare(b.name));
          const og = document.createElement('optgroup');
          og.label = type==='normal' ? 'Normale Gruppe' : 'Kindergruppe';
          groups[type].forEach(t => {
            const o = document.createElement('option');
            o.value = t.id; o.textContent = t.name;
            og.appendChild(o);
          });
          sel.appendChild(og);
        }
      });
    }

    // Übersicht laden (nur confirmed=true)
    async function loadTeamsInfo() {
      const div = document.getElementById('teamsInfo');
      div.innerHTML = '';
      const snaps = await getDocs(collection(db, 'teams'));
      const groups = { normal: [], kinder: [] };

      snaps.forEach(s => {
        const d = s.data();
        if (!d.confirmed) return;
        const pts = d['station'+stationNumber] || 0;
        const key = d.teamType.toLowerCase() === 'kindergruppe' ? 'kinder' : 'normal';
        groups[key].push({ name: d.teamName, points: pts });
      });

      ['normal','kinder'].forEach(type => {
        if (groups[type].length) {
          groups[type].sort((a,b)=>a.name.localeCompare(b.name));
          const h2 = document.createElement('h2');
          h2.textContent = type==='normal' ? 'Normale Gruppe' : 'Kindergruppe';
          const wrap = document.createElement('div');
          wrap.className = 'group-container';
          groups[type].forEach(t => {
            const c = document.createElement('div');
            c.className = 'team-card ' + (t.points>0?'participated':'not-participated');
            c.innerHTML = `<strong>${t.name}</strong><br>${
              t.points>0 ? `${t.points} Punkte` : 'Noch nicht teilgenommen'
            }`;
            wrap.appendChild(c);
          });
          div.appendChild(h2);
          div.appendChild(wrap);
        }
      });
    }

    // Feedback + Submit
    function showFeedback(msg, ok=true) {
      const f = document.getElementById('feedback');
      f.textContent = msg;
      f.className = ok ? 'success' : 'error';
      f.style.display = 'block';
      setTimeout(()=>f.style.display='none', 3000);
    }

    document.getElementById('resultForm')
      .addEventListener('submit', async e => {
        e.preventDefault();
        const teamId = e.target.teamSelect.value;
        const pts    = parseInt(e.target.points.value,10);
        if (!teamId) { showFeedback('Bitte Team wählen',false); return; }

        const sRef = doc(db,'teams',teamId);
        const snap = await getDoc(sRef);
        const data = snap.data() || {};

        if (data['station'+stationNumber] > 0
            && !confirm('Überschreiben?')) {
          showFeedback('Abgebrochen',false);
          return;
        }

        const update = { ['station'+stationNumber]: pts };
        update.total = Object.keys(data)
          .filter(k=>k.startsWith('station'))
          .reduce((sum,k)=>(k===`station${stationNumber}`?pts:(data[k]||0))+sum,0);

        await updateDoc(sRef, update);
        showFeedback('Gespeichert');
        e.target.reset();
        loadTeamsDropdown();
        loadTeamsInfo();
      });

    // Dark/Light
    window.toggleMode = () => {
      document.body.classList.toggle('light-mode');
      document.querySelector('.toggle-mode').textContent =
        document.body.classList.contains('light-mode') ? 'Dark' : 'Light';
    };

    // Init
    loadTeamsDropdown();
    loadTeamsInfo();
  </script>

  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js"></script>
</body>
</html>
