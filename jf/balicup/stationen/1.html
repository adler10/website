<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ergebnisse Station 1 – Bali‑Cup 2025</title>
  <style>
    :root {
      --bg-dark: #222; --bg-light: #f5f5f5;
      --btn-bg-dark: #555; --btn-border-dark: #666; --btn-hover-dark: #444;
      --btn-bg-light: #e7e7e7; --btn-border-light: #ccc; --btn-hover-light: #d7d7d7;
    }
    body {
      margin: 20px; font-family: Arial, sans-serif;
      background: var(--bg-dark); color: #fff; transition: .3s;
    }
    body.light-mode {
      background: var(--bg-light); color: #333;
    }
    header { text-align: center; margin-bottom: 20px; }
    .container {
      max-width: 400px; margin: auto; padding: 20px;
      background: #333; border: 1px solid #444; border-radius: 4px;
    }
    body.light-mode .container {
      background: #fff; border-color: #ccc;
    }
    label, select, input, button {
      display: block; width: 100%; margin-top: 10px;
      font-size: 1em; padding: 8px; box-sizing: border-box;
    }
    button {
      cursor: pointer; background: var(--btn-bg-dark);
      border: 1px solid var(--btn-border-dark); color: #fff;
      transition: .3s;
    }
    button:hover { background: var(--btn-hover-dark); }
    body.light-mode button {
      background: var(--btn-bg-light);
      border-color: var(--btn-border-light); color: #333;
    }
    body.light-mode button:hover { background: var(--btn-hover-light); }
    #feedback {
      display: none; text-align: center; margin-top: 15px;
      padding: 8px; border-radius: 4px;
    }
    #feedback.success { background: #4caf50; color: #fff; }
    #feedback.error   { background: #f44336; color: #fff; }
    .teams-info { margin-top: 20px; }
    .teams-info h2 {
      margin-bottom: 10px; text-align: center;
    }
    .group-container { margin-bottom: 20px; }
    .team-card {
      margin: 8px 0; padding: 8px;
      border-radius: 4px; border: 1px solid; text-align: center;
    }
    .participated    { background: #388e3c; border-color: #2e7d32; color: #fff; }
    .not-participated{ background: #d32f2f; border-color: #c62828; color: #fff; }
    body.light-mode .participated    { background: #81c784; border-color: #66bb6a; color: #333; }
    body.light-mode .not-participated{ background: #e57373; border-color: #ef5350; color: #333; }
    .toggle-mode {
      position: fixed; bottom: 10px; right: 10px;
      padding: 4px 8px; font-size: 0.8em;
      border: 1px solid var(--btn-border-dark);
      background: var(--btn-bg-dark); color: #fff;
      cursor: pointer; transition: .3s; white-space: nowrap;
    }
    .toggle-mode:hover { background: var(--btn-hover-dark); }
    body.light-mode .toggle-mode {
      background: var(--btn-bg-light); border-color: var(--btn-border-light);
      color: #333;
    }
    body.light-mode .toggle-mode:hover { background: var(--btn-hover-light); }
    @media (max-width: 600px) {
      body { margin: 10px; }
      .container { padding: 15px; }
      .toggle-mode { bottom: 5px; right: 5px; padding: 3px 6px; }
    }
  </style>
</head>
<body>

  <header>
    <h1>Ergebnisse Station 1 – Schätzspiel</h1>
  </header>

  <div class="container">
    <form id="resultForm">
      <label for="teamSelect">Team auswählen:</label>
      <select id="teamSelect" required>
        <option value="" disabled selected>Bitte wählen</option>
        <optgroup label="Kindergruppen" id="optKinder"></optgroup>
        <optgroup label="Normale Gruppen" id="optNormal"></optgroup>
      </select>

      <label for="points">Punkte:</label>
      <input type="number" id="points" min="0" placeholder="0" required>

      <button type="submit">Speichern</button>
    </form>

    <div id="feedback"></div>

    <div class="teams-info" id="teamsInfo">
      <!-- Hier kommen später die beiden Gruppen-Container -->
    </div>
  </div>

  <button class="toggle-mode" onclick="toggleMode()">Light</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, getDoc, doc,
      updateDoc, setDoc, onSnapshot, addDoc
    } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

    // ---------- Init ----------
    const firebaseConfig = {
      apiKey: "AIzaSyByMYvt0OdfhteOgyNplMqxbWWYQJBwTpg",
      authDomain: "bali-cup2025.firebaseapp.com",
      projectId: "bali-cup2025",
      storageBucket: "bali-cup2025.firebasestorage.app",
      messagingSenderId: "867421335336",
      appId: "1:867421335336:web:e046ccb32b631dcbf86a1d",
      measurementId: "G-484CZNKVQ1"
    };
    initializeApp(firebaseConfig);
    const db = getFirestore();
    const station = 1;
    const teamsCol = collection(db, "teams");

    // ---------- Dropdown befüllen ----------
    async function loadTeamsDropdown() {
      const optKinder = document.getElementById("optKinder");
      const optNormal = document.getElementById("optNormal");
      optKinder.innerHTML = "";
      optNormal.innerHTML = "";

      const snaps = await getDocs(teamsCol);
      snaps.forEach(snap => {
        const d = snap.data();
        if (!d.confirmed || (d["station"+station] || 0) > 0) return;
        const isChild = d.teamType.toLowerCase() === "kindergruppe";
        const opt = document.createElement("option");
        opt.value = snap.id;
        opt.textContent = d.teamName;
        (isChild ? optKinder : optNormal).appendChild(opt);
      });
    }

    // ---------- Team-Übersicht ----------
    async function loadTeamsInfo() {
      const container = document.getElementById("teamsInfo");
      container.innerHTML = "";

      const snaps = await getDocs(teamsCol);
      const groups = { kinder: [], normal: [] };
      snaps.forEach(snap => {
        const d = snap.data();
        if (!d.confirmed) return;
        const isChild = d.teamType.toLowerCase() === "kindergruppe";
        groups[isChild ? "kinder" : "normal"].push({
          name: d.teamName,
          points: d["station"+station] || 0
        });
      });

      // Kindergruppen
      if (groups.kinder.length) {
        const h2 = document.createElement("h2");
        h2.textContent = "Kindergruppen";
        const wrap = document.createElement("div");
        wrap.className = "group-container";
        groups.kinder.sort((a,b)=>a.name.localeCompare(b.name))
          .forEach(t=>{
            const c = document.createElement("div");
            c.className = "team-card " + (t.points>0?"participated":"not-participated");
            c.innerHTML = `<strong>${t.name}</strong><br>` +
              (t.points>0 ? `${t.points} Punkte` : `<em>Noch nicht teilgenommen</em>`);
            wrap.appendChild(c);
          });
        container.appendChild(h2);
        container.appendChild(wrap);
      }

      // Normale Gruppen
      if (groups.normal.length) {
        const h2 = document.createElement("h2");
        h2.textContent = "Normale Gruppen";
        const wrap = document.createElement("div");
        wrap.className = "group-container";
        groups.normal.sort((a,b)=>a.name.localeCompare(b.name))
          .forEach(t=>{
            const c = document.createElement("div");
            c.className = "team-card " + (t.points>0?"participated":"not-participated");
            c.innerHTML = `<strong>${t.name}</strong><br>` +
              (t.points>0 ? `${t.points} Punkte` : `<em>Noch nicht teilgenommen</em>`);
            wrap.appendChild(c);
          });
        container.appendChild(h2);
        container.appendChild(wrap);
      }
    }

    // ---------- Formular-Logik ----------
    document.getElementById("resultForm")
      .addEventListener("submit", async e => {
        e.preventDefault();
        const teamId = e.target.teamSelect.value;
        const pts    = parseInt(e.target.points.value,10);
        if (!teamId) return showFeedback("Bitte ein Team wählen",false);

        const ref  = doc(teamsCol, teamId);
        const snap = await getDoc(ref);
        const d    = snap.data() || {};

        if (d["station"+station] > 0
            && !confirm("Eintrag überschreiben?")) {
          return showFeedback("Abgebrochen",false);
        }

        // neuen Total berechnen
        let total = 0;
        Object.keys(d)
          .filter(k=>k.startsWith("station"))
          .forEach(k=> total += (k==="station"+station ? pts : (d[k]||0)));

        await updateDoc(ref, {
          ["station"+station]: pts,
          total
        });

        showFeedback("Gespeichert");
        e.target.reset();
        await loadTeamsDropdown();
        await loadTeamsInfo();
      });

    // ---------- Feedback ----------
    function showFeedback(msg, ok=true) {
      const fb = document.getElementById("feedback");
      fb.textContent = msg;
      fb.className   = ok ? "success" : "error";
      fb.style.display = "block";
      setTimeout(()=> fb.style.display="none", 3000);
    }

    // ---------- Station session setzen ----------
    onSnapshot(doc(db, "stationSessions","station"+station), snap => {
      if (!snap.exists() || snap.data().loggedIn===false) {
        setDoc(doc(db,"stationSessions","station"+station),
               { loggedIn:true }, { merge:true });
      }
    });

    // ---------- Dark/Light Mode ----------
    window.toggleMode = ()=> {
      document.body.classList.toggle("light-mode");
      document.querySelector(".toggle-mode").textContent =
        document.body.classList.contains("light-mode") ? "Dark" : "Light";
    };

    // ---------- Initial Load ----------
    loadTeamsDropdown();
    loadTeamsInfo();
  </script>
</body>
</html>
