<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ergebnisse für Station <span id="stationLabel"></span> – Bali-Cup 2025</title>
  <style>
    :root {
      --btn-bg-dark: #555;
      --btn-border-dark: #666;
      --btn-hover-dark: #444;
      --btn-bg-light: #e7e7e7;
      --btn-border-light: #ccc;
      --btn-hover-light: #d7d7d7;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #222;
      color: #fff;
      transition: background 0.3s, color 0.3s;
    }
    body.light-mode {
      background: #f5f5f5;
      color: #333;
    }
    header { text-align: center; margin-bottom: 20px; }
    .container {
      max-width: 400px; margin: 0 auto;
      padding: 20px; background: #333;
      border: 1px solid #444; border-radius: 4px;
    }
    body.light-mode .container {
      background: #fff; border: 1px solid #ccc;
    }
    label { display: block; margin-top: 10px; }
    select, input, button {
      font-size: 1em; padding: 10px;
      margin-top: 5px; width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      background: var(--btn-bg-dark);
      border: 1px solid var(--btn-border-dark);
      color: #fff; transition: background 0.3s;
    }
    button:hover { background: var(--btn-hover-dark); }
    body.light-mode button {
      background: var(--btn-bg-light);
      border: 1px solid var(--btn-border-light);
      color: #333;
    }
    body.light-mode button:hover {
      background: var(--btn-hover-light);
    }
    #feedback {
      margin-top: 15px; padding: 10px;
      border-radius: 4px; text-align: center;
      display: none;
    }
    #feedback.success { background: #4caf50; color: #fff; }
    #feedback.error   { background: #f44336; color: #fff; }
    .toggle-mode {
      position: fixed; top: 10px; right: 10px;
      padding: 4px 6px; font-size: 0.9em;
      cursor: pointer;
      border: 1px solid var(--btn-border-dark);
      background: var(--btn-bg-dark);
      transition: background 0.3s; white-space: nowrap;
    }
    .toggle-mode:hover { background: var(--btn-hover-dark); }
    body.light-mode .toggle-mode {
      border: 1px solid var(--btn-border-light);
      background: var(--btn-bg-light);
    }
    body.light-mode .toggle-mode:hover {
      background: var(--btn-hover-light);
    }
    .teams-info { margin-top: 20px; }
    .teams-info h2 {
      text-align: center; margin-bottom: 10px;
    }
    .group-container { margin-bottom: 20px; }
    .team-card {
      padding: 10px; margin: 10px;
      border-radius: 4px; border: 1px solid;
      text-align: center;
    }
    body:not(.light-mode) .team-card.participated {
      background: #388e3c; border-color: #2e7d32; color: #fff;
    }
    body:not(.light-mode) .team-card.not-participated {
      background: #d32f2f; border-color: #c62828; color: #fff;
    }
    body.light-mode .team-card.participated {
      background: #81c784; border-color: #66bb6a; color: #333;
    }
    body.light-mode .team-card.not-participated {
      background: #e57373; border-color: #ef5350; color: #333;
    }
    /* Mobile */
    @media (max-width: 600px) {
      body { margin: 10px; }
      .container { padding: 15px; margin: 0 5px; }
      header h1 { font-size: 1.3em; }
      label, select, input, button { font-size: 1em; }
      .toggle-mode {
        top: 5px; right: 5px;
        padding: 3px 5px; font-size: 0.8em;
      }
      .teams-info h2 { font-size: 1.1em; }
      .team-card { margin: 8px 5px; font-size: 0.9em; padding: 8px; }
    }
  </style>
</head>
<body>
  <button class="toggle-mode" onclick="toggleMode()">Light Mode</button>

  <header>
    <h1>Ergebnisse für Station <span id="stationId"></span> – <span id="stationLabel"></span> erfassen</h1>
  </header>
  <div class="container">
    <form id="resultForm">
      <label for="teamSelect">Team auswählen:</label>
      <select id="teamSelect" required>
        <option value="" disabled selected>Bitte wähle ein Team</option>
      </select>

      <label for="points">Punkte:</label>
      <input type="number" id="points" placeholder="Punkte" min="0" required>

      <button type="submit">Ergebnis speichern</button>
    </form>
    <div id="feedback"></div>
    <div class="teams-info" id="teamsInfo"></div>
  </div>

  <script type="module">
    // Konfiguration
    const stationName   = "Schätzspiel";
    const stationNumber = 1;
    const allowedGroups = {
      dropdown: ["normale gruppe", "kindergruppe"],
      teams:     ["normale gruppe", "kindergruppe"]
    };

    // Überschrift
    document.getElementById("stationLabel").textContent = stationName;
    document.getElementById("stationId").textContent    = stationNumber;

    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, updateDoc, doc,
      addDoc, setDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyByMYvt0OdfhteOgyNplMqxbWWYQJBwTpg",
      authDomain: "bali-cup2025.firebaseapp.com",
      projectId: "bali-cup2025",
      storageBucket: "bali-cup2025.firebasestorage.app",
      messagingSenderId: "867421335336",
      appId: "1:867421335336:web:e046ccb32b631dcbf86a1d",
      measurementId: "G-484CZNKVQ1"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Station-Status setzen
    async function setStationStatus(id, status) {
      await setDoc(doc(db, "stationSessions", id), { loggedIn: status }, { merge: true });
    }
    const stationRef = doc(db, "stationSessions", "station" + stationNumber);
    onSnapshot(stationRef, async snap => {
      if (!snap.exists() || snap.data().loggedIn === false) {
        await setStationStatus("station" + stationNumber, true);
      }
    });

    // Dropdown befüllen (confirmed === true)
    async function loadTeamsDropdown() {
      const snaps = await getDocs(collection(db, "teams"));
      const sel   = document.getElementById("teamSelect");
      sel.innerHTML = '<option value="" disabled selected>Bitte wähle ein Team</option>';

      const normal = [], kinder = [];
      snaps.forEach(docSnap => {
        const data = docSnap.data();
        if (!data.confirmed) return;
        if ((data["station" + stationNumber] || 0) > 0) return;
        const type = (data.teamType || "normale gruppe").toLowerCase();
        if (!allowedGroups.dropdown.includes(type)) return;
        const obj = { id: docSnap.id, name: data.teamName };
        (type === "kindergruppe" ? kinder : normal).push(obj);
      });

      normal.sort((a,b)=>a.name.localeCompare(b.name));
      kinder.sort((a,b)=>a.name.localeCompare(b.name));

      if (normal.length) {
        const og = document.createElement("optgroup");
        og.label = "Normale Gruppe";
        normal.forEach(t => {
          const o = document.createElement("option");
          o.value = t.id; o.textContent = t.name;
          og.appendChild(o);
        });
        sel.appendChild(og);
      }
      if (kinder.length) {
        const og = document.createElement("optgroup");
        og.label = "Kindergruppe";
        kinder.forEach(t => {
          const o = document.createElement("option");
          o.value = t.id; o.textContent = t.name;
          og.appendChild(o);
        });
        sel.appendChild(og);
      }
    }

    // Teams-Übersicht
    async function loadTeamsInfo() {
      const snaps = await getDocs(collection(db, "teams"));
      const div   = document.getElementById("teamsInfo");
      div.innerHTML = "";

      const normal = [], kinder = [];
      snaps.forEach(docSnap => {
        const data = docSnap.data();
        const pts  = data["station" + stationNumber] || 0;
        const type = (data.teamType || "normale gruppe").toLowerCase();
        if (!allowedGroups.teams.includes(type)) return;
        const card = { name: data.teamName, points: pts };
        (type === "kindergruppe" ? kinder : normal).push(card);
      });

      normal.sort((a,b)=>a.name.localeCompare(b.name));
      kinder.sort((a,b)=>a.name.localeCompare(b.name));

      if (normal.length) {
        div.append(createGroupSection("Normale Gruppe", normal));
      }
      if (kinder.length) {
        div.append(createGroupSection("Kindergruppe", kinder));
      }
    }

    function createGroupSection(title, list) {
      const frag = document.createDocumentFragment();
      const h2   = document.createElement("h2");
      h2.textContent = title;
      frag.append(h2);
      const wrap = document.createElement("div");
      wrap.className = "group-container";
      list.forEach(t => {
        const c = document.createElement("div");
        c.className = "team-card " + (t.points > 0 ? "participated" : "not-participated");
        c.innerHTML = `<strong>${t.name}</strong><br>` +
                      (t.points > 0
                        ? `Teilgenommen mit <em>${t.points}</em> Punkten.`
                        : `<em>Noch nicht teilgenommen</em>`);
        wrap.append(c);
      });
      frag.append(wrap);
      return frag;
    }

    // Feedback
    function showFeedback(msg, ok = true) {
      const f = document.getElementById("feedback");
      f.textContent = msg;
      f.className   = ok ? "success" : "error";
      f.style.display = "block";
      setTimeout(()=> f.style.display = "none", 3000);
    }

    // Formular absenden
    document.getElementById("resultForm").addEventListener("submit", async e => {
      e.preventDefault();
      const teamId = document.getElementById("teamSelect").value;
      const pts    = parseInt(document.getElementById("points").value, 10);
      if (!teamId) { showFeedback("Bitte wähle ein Team aus!", false); return; }

      const teamsRef = collection(db, "teams");
      const snaps    = await getDocs(teamsRef);
      let data;
      snaps.forEach(s => { if (s.id === teamId) data = s.data(); });

      if (data && (data["station" + stationNumber] || 0) > 0) {
        if (!confirm("Eintrag überschreiben?")) {
          showFeedback("Nicht überschrieben.", false);
          return;
        }
      }

      try {
        if (!data) {
          const obj = { teamName: "Unbekannt", total: pts };
          for (let i = 1; i <= 8; i++) obj["station" + i] = (i === stationNumber ? pts : 0);
          await addDoc(teamsRef, obj);
        } else {
          let total = 0;
          for (let i = 1; i <= 8; i++) {
            total += (i === stationNumber ? pts : (data["station" + i] || 0));
          }
          await updateDoc(doc(db, "teams", teamId), {
            ["station" + stationNumber]: pts,
            total
          });
        }
        showFeedback("Ergebnis gespeichert!");
        document.getElementById("resultForm").reset();
        loadTeamsDropdown();
        loadTeamsInfo();
      } catch (err) {
        console.error(err);
        showFeedback("Fehler beim Speichern!", false);
      }
    });

    // Dark/Light Mode
    window.toggleMode = () => {
      document.body.classList.toggle("light-mode");
      document.querySelector(".toggle-mode").textContent =
        document.body.classList.contains("light-mode") ? "Dark Mode" : "Light Mode";
    };

    // Initial laden
    loadTeamsDropdown();
    loadTeamsInfo();
  </script>
</body>
</html>
