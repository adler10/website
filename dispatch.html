<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fire Department Dispatch System (Local Persistence)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        #map { height: 100%; }
        .leaflet-container { border-radius: 0.5rem; }
        .suggestion-item:hover { background-color: #f0f0ff; }
        .offline-form input,
        .offline-form button[type="submit"] {
            pointer-events: none;
            opacity: 0.5;
            background-color: #f3f4f6;
        }
        .offline-form button[type="submit"] {
            background-color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex flex-col md:flex-row h-screen">
        <div class="w-full md:w-1/3 bg-white p-4 overflow-y-auto shadow-lg">
            <h1 class="text-2xl font-bold text-red-700 mb-4">Local Dispatch Console</h1>
            <div id="status-indicator" class="text-sm p-2 mb-4 rounded text-center font-medium transition duration-300 bg-green-100 text-green-700">Online: Address Lookup Active</div>

            <form id="dispatch-form" class="mb-6">
                <div class="mb-4 relative">
                    <label for="address" class="block text-gray-700 text-sm font-bold mb-2">Address</label>
                    <input type="text" id="address" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter address... (76... postcodes)" autocomplete="off">
                    <div id="address-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 mt-1 rounded-md shadow-lg hidden"></div>
                </div>
                <div class="mb-4">
                    <label for="keyword" class="block text-gray-700 text-sm font-bold mb-2">Alarm Keyword</label>
                    <input type="text" id="keyword" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., Tree down, Basement flooded" required>
                </div>
                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded w-full focus:outline-none focus:shadow-outline transition duration-150">
                    Create Incident
                </button>
            </form>

            <div>
                <h2 class="text-xl font-bold text-gray-800 mb-3">Active Incidents</h2>
                <div id="incident-list" class="space-y-3"></div>
                <p class="text-xs text-gray-500 mt-4 text-center">Data saved locally in this browser. Not synchronized.</p>
            </div>
        </div>
        <div class="w-full md:w-2/3 h-64 md:h-full" id="map"></div>
    </div>

    <script>
        const LOCAL_STORAGE_KEY = "localDispatchIncidents_v1";
        const incidents = new Map();
        const markers = new Map();

        const dispatchForm = document.getElementById('dispatch-form');
        const addressInput = document.getElementById('address');
        const keywordInput = document.getElementById('keyword');
        const incidentList = document.getElementById('incident-list');
        const statusIndicator = document.getElementById('status-indicator');

        const map = L.map('map').setView([49.0069, 8.4037], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        function saveIncidents() {
            const incidentsArray = Array.from(incidents.values()).filter(i => i.status !== 'completed');
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(incidentsArray));
        }

        function loadIncidents() {
            const cachedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (cachedData) {
                try {
                    const incidentsArray = JSON.parse(cachedData);
                    incidentsArray.forEach(incident => {
                        if (!incident.id) incident.id = crypto.randomUUID();
                        incidents.set(incident.id, incident);
                    });
                    renderAllIncidents();
                } catch (e) {
                    console.error("Error loading incidents:", e);
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                }
            }
        }

        function getStatusColor(status) {
            if (status === 'open') return 'red';
            if (status === 'dispatched') return 'blue';
            if (status === 'completed') return 'yellow';
            return 'grey';
        }

        function createMarkerIcon(color) {
            const svgIcon = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}" width="36px" height="36px">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>`;
            return L.divIcon({
                html: svgIcon,
                className: '',
                iconSize: [36, 36],
                iconAnchor: [18, 36],
                popupAnchor: [0, -36]
            });
        }

        function renderAllIncidents() {
            incidentList.innerHTML = '';
            markers.forEach(marker => map.removeLayer(marker));
            markers.clear();

            incidents.forEach(incident => {
                if (incident.status === 'open' || incident.status === 'dispatched') {
                    const el = document.createElement('div');
                    el.id = `incident-${incident.id}`;
                    el.className = 'p-3 bg-gray-50 border rounded-lg shadow-sm';

                    let statusColorClass = 'bg-gray-100 text-gray-800';
                    let buttonHTML = '';

                    if (incident.status === 'open') {
                        statusColorClass = 'bg-red-100 text-red-800';
                        buttonHTML = `<button data-id="${incident.id}" class="update-status-btn dispatch-btn bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded w-full transition duration-150">Dispatch Unit</button>`;
                    } else if (incident.status === 'dispatched') {
                        statusColorClass = 'bg-blue-100 text-blue-800';
                        buttonHTML = `<button data-id="${incident.id}" class="update-status-btn complete-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded w-full transition duration-150">Mark as Completed</button>`;
                    }

                    el.innerHTML = `
                        <p class="font-semibold text-gray-800">${incident.keyword}</p>
                        <p class="text-sm text-gray-600">${incident.formattedAddress}</p>
                        <div class="mt-2">
                            <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded ${statusColorClass}">${incident.status.toUpperCase()}</span>
                        </div>
                        <div class="mt-2 space-y-2">${buttonHTML}</div>
                    `;
                    incidentList.appendChild(el);

                    if (incident.lat && incident.lon) {
                        const color = getStatusColor(incident.status);
                        const newIcon = createMarkerIcon(color);
                        const popup = `<b>${incident.keyword}</b><br>${incident.formattedAddress}`;
                        const marker = L.marker([incident.lat, incident.lon], { icon: newIcon }).addTo(map);
                        marker.bindPopup(popup);
                        markers.set(incident.id, marker);
                    }
                }
            });
        }

        incidentList.addEventListener('click', (e) => {
            if (!e.target.classList.contains('update-status-btn')) return;
            const id = e.target.dataset.id;
            const incident = incidents.get(id);
            if (!incident) return;

            if (e.target.classList.contains('dispatch-btn')) incident.status = 'dispatched';
            else if (e.target.classList.contains('complete-btn')) incident.status = 'completed';

            incidents.set(id, incident);
            saveIncidents();
            renderAllIncidents();
        });

        const suggestionsContainer = document.getElementById('address-suggestions');
        let selectedLocation = null;
        let debounceTimer;

        function setOnlineStatus(isOnline) {
            if (isOnline) {
                statusIndicator.textContent = 'Online: Address Lookup Active';
                statusIndicator.className = 'text-sm p-2 mb-4 rounded text-center font-medium bg-green-100 text-green-700';
                dispatchForm.classList.remove('offline-form');
            } else {
                statusIndicator.textContent = 'Offline: Address Lookup Disabled';
                statusIndicator.className = 'text-sm p-2 mb-4 rounded text-center font-medium bg-yellow-100 text-yellow-700';
                dispatchForm.classList.add('offline-form');
            }
        }

        window.addEventListener('online', () => setOnlineStatus(true));
        window.addEventListener('offline', () => setOnlineStatus(false));
        setOnlineStatus(navigator.onLine);

        function formatGermanAddress(address) {
            const parts = [];
            const street = address.road || '';
            const houseNumber = address.house_number || '';
            const postcode = address.postcode || '';
            const city = address.city || address.town || address.village || '';
            if (street) parts.push(`${street} ${houseNumber}`.trim());
            if (postcode && city) parts.push(`${postcode} ${city}`);
            else if (city && !parts.includes(city)) parts.push(city);
            return parts.join(', ');
        }

        addressInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            const query = addressInput.value;
            if (query.length < 3 || !navigator.onLine) {
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.classList.add('hidden');
                return;
            }

            debounceTimer = setTimeout(() => {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=de&addressdetails=1`)
                    .then(res => res.json())
                    .then(data => {
                        suggestionsContainer.innerHTML = '';
                        suggestionsContainer.classList.remove('hidden');
                        const filtered = data.filter(p => p.address && p.address.postcode && p.address.postcode.startsWith('76'));
                        if (filtered.length > 0) {
                            filtered.slice(0, 5).forEach(place => {
                                const formatted = formatGermanAddress(place.address);
                                if (!formatted) return;
                                const item = document.createElement('div');
                                item.textContent = formatted;
                                item.className = 'p-2 cursor-pointer suggestion-item';
                                item.addEventListener('click', () => {
                                    addressInput.value = formatted;
                                    selectedLocation = place;
                                    suggestionsContainer.classList.add('hidden');
                                    suggestionsContainer.innerHTML = '';
                                });
                                suggestionsContainer.appendChild(item);
                            });
                        } else {
                            suggestionsContainer.innerHTML = '<div class="p-2 text-gray-500">No results in 76... area</div>';
                        }
                    })
                    .catch(() => {
                        suggestionsContainer.innerHTML = '<div class="p-2 text-red-500">Network error</div>';
                        suggestionsContainer.classList.remove('hidden');
                    });
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (!suggestionsContainer.contains(e.target) && e.target !== addressInput)
                suggestionsContainer.classList.add('hidden');
        });

        dispatchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const keyword = keywordInput.value.trim();
            const address = addressInput.value.trim();
            if (!keyword || !address) {
                alert("Please enter an address and keyword.");
                return;
            }

            let location = selectedLocation;

            if (!location) {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=de&addressdetails=1&limit=1`);
                    const data = await res.json();
                    if (data.length > 0) location = data[0];
                } catch (err) {
                    console.error("Manual geocoding failed:", err);
                }
            }

            if (!location) {
                alert("Could not resolve the address.");
                return;
            }

            const cleanAddress = formatGermanAddress(location.address);
            const newIncident = {
                id: crypto.randomUUID(),
                formattedAddress: cleanAddress,
                keyword: keyword,
                lat: parseFloat(location.lat),
                lon: parseFloat(location.lon),
                status: "open",
                createdAt: new Date().toISOString()
            };

            incidents.set(newIncident.id, newIncident);
            saveIncidents();
            renderAllIncidents();

            dispatchForm.reset();
            selectedLocation = null;
            suggestionsContainer.classList.add('hidden');
        });

        window.onload = loadIncidents;
    </script>
</body>
</html>
