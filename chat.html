<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- PWA & iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>CanvasConnect</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* iOS Safe Area helpers */
        .pt-safe-top { padding-top: env(safe-area-inset-top); }
        .pb-safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Canvas Background Pattern */
        .bg-grid-pattern {
            background-image: radial-gradient(#fff 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Touch handling */
        .touch-none { touch-action: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans overflow-hidden fixed inset-0 flex flex-col">

    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="absolute inset-0 z-50 flex items-center justify-center bg-slate-950">
        <div class="animate-pulse text-indigo-400 font-bold">Loading CanvasConnect...</div>
    </div>

    <!-- LOGIN / LOBBY SCREEN -->
    <div id="login-screen" class="hidden absolute inset-0 z-40 bg-slate-950 flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm bg-slate-900 p-8 rounded-3xl shadow-2xl border border-slate-800">
            <div class="flex justify-center mb-6">
                <div class="bg-indigo-500 p-4 rounded-2xl shadow-lg shadow-indigo-500/20">
                    <i data-lucide="maximize-2" class="w-8 h-8 text-white"></i>
                </div>
            </div>
            <h1 class="text-3xl font-bold text-center mb-2 tracking-tight">CanvasConnect</h1>
            <p class="text-slate-400 text-center mb-8 text-sm">Spatial Chat Messenger</p>
            
            <div class="space-y-4">
                <input id="input-display-name" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white focus:outline-none focus:border-indigo-500 transition-colors" placeholder="Your Name">
                <input id="input-room-code" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white focus:outline-none focus:border-indigo-500 transition-colors" placeholder="Room Code (e.g. 'chill')">
                <button id="btn-join" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">Enter Space</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="app-screen" class="hidden flex-1 flex flex-col relative h-full">
        
        <!-- HEADER -->
        <header class="flex-none bg-slate-900/80 backdrop-blur-md border-b border-slate-800 pt-safe-top px-4 py-3 flex items-center justify-between z-30">
            <div class="flex items-center gap-3">
                <div id="status-indicator" class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></div>
                <span id="header-room-code" class="font-bold text-lg tracking-tight">Room</span>
            </div>
            
            <div class="flex bg-slate-800/50 p-1 rounded-full">
                <button id="tab-chat" class="px-4 py-1.5 rounded-full text-xs font-bold transition-all bg-white text-black shadow-sm">Chat</button>
                <button id="tab-canvas" class="px-4 py-1.5 rounded-full text-xs font-bold transition-all text-slate-400 hover:text-white">Canvas</button>
            </div>
    
            <button id="btn-logout" class="text-slate-500 hover:text-white">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </button>
        </header>

        <!-- CHAT VIEW -->
        <div id="view-chat" class="flex-1 flex flex-col relative overflow-hidden">
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 scroll-smooth">
                <!-- Messages injected here -->
            </div>
            <div class="p-3 bg-slate-900 border-t border-slate-800 pb-safe-bottom">
                <form id="form-chat" class="flex gap-2">
                    <input id="input-chat" type="text" class="flex-1 bg-slate-800 rounded-full px-4 py-3 text-sm focus:outline-none text-white" placeholder="iMessage...">
                    <button type="submit" class="bg-indigo-600 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-indigo-500 transition-colors">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- CANVAS VIEW -->
        <div id="view-canvas" class="hidden flex-1 relative overflow-y-auto overflow-x-hidden bg-slate-950 touch-pan-y" style="-webkit-overflow-scrolling: touch;">
            <!-- Infinite Board Container -->
            <div id="canvas-content" class="w-full min-h-[200vh] relative">
                <!-- Grid BG -->
                <div class="absolute inset-0 pointer-events-none opacity-10 bg-grid-pattern"></div>
                
                <!-- Start Marker -->
                <div class="absolute top-4 left-0 right-0 text-center text-slate-700 text-xs font-mono">-- TOP OF THREAD --</div>
                
                <!-- Canvas Items Container -->
                <div id="canvas-items-layer" class="absolute inset-0 w-full h-full"></div>
                
                <!-- Spacer for scrolling -->
                <div class="h-[50vh] w-full pointer-events-none"></div>
            </div>

            <!-- Canvas Toolbar -->
            <div class="fixed bottom-6 left-4 right-4 bg-slate-900/90 backdrop-blur-xl border border-slate-700 rounded-3xl p-2 shadow-2xl z-40 flex items-center gap-2 pb-safe-bottom">
                <button id="btn-emoji-open" class="w-10 h-10 bg-slate-800 hover:bg-slate-700 rounded-full flex items-center justify-center text-yellow-400 transition-colors">
                    <i data-lucide="smile" class="w-5 h-5"></i>
                </button>

                <input id="input-canvas" type="text" class="flex-1 bg-slate-950/50 border border-slate-800 rounded-full px-4 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500 placeholder-slate-500" placeholder="Type text...">

                <button id="btn-add-text" class="w-10 h-10 bg-indigo-600 hover:bg-indigo-500 rounded-full flex items-center justify-center text-white transition-colors disabled:opacity-50">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- EMOJI MODAL -->
        <div id="emoji-modal" class="hidden fixed inset-0 z-50 flex flex-col bg-slate-950/95 backdrop-blur-sm animate-in slide-in-from-bottom duration-300">
            <div class="flex items-center justify-between p-4 border-b border-slate-800 pt-safe-top">
                <h3 class="text-white font-bold">Emoji Finder</h3>
                <button id="btn-emoji-close" class="p-2 bg-slate-800 rounded-full text-slate-300">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 pb-safe-bottom">
                <div id="emoji-grid" class="grid grid-cols-6 gap-2 pb-20">
                    <!-- Emojis injected here -->
                </div>
            </div>
        </div>

    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            doc, 
            updateDoc, 
            deleteDoc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD0bYsfuu1EipFJ_i-2WAikHQ9ycP1jye0",
            authDomain: "game-8e351.firebaseapp.com",
            projectId: "game-8e351",
            storageBucket: "game-8e351.firebasestorage.app",
            messagingSenderId: "713515393193",
            appId: "1:713515393193:web:534d68c9f0d223f6e149b8",
            measurementId: "G-F21SP6RW0B"
        };

        const appId = 'canvas-connect-production'; 
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        let currentUser = null;
        let currentRoom = localStorage.getItem('cc_last_room') || '';
        let displayName = localStorage.getItem('cc_username') || '';
        let viewMode = 'chat'; // 'chat' or 'canvas'
        let messagesUnsub = null;
        let canvasUnsub = null;
        
        // Canvas Interaction State
        let canvasItems = [];
        let selectedItemId = null;
        let interactionMode = null; // 'move' or 'resize'
        let dragStart = { x: 0, y: 0 };
        let initialItemState = null;

        // --- DOM Elements ---
        const els = {
            loading: document.getElementById('loading-screen'),
            login: document.getElementById('login-screen'),
            app: document.getElementById('app-screen'),
            inputName: document.getElementById('input-display-name'),
            inputRoom: document.getElementById('input-room-code'),
            btnJoin: document.getElementById('btn-join'),
            headerRoom: document.getElementById('header-room-code'),
            btnLogout: document.getElementById('btn-logout'),
            tabChat: document.getElementById('tab-chat'),
            tabCanvas: document.getElementById('tab-canvas'),
            statusInd: document.getElementById('status-indicator'),
            
            // Views
            viewChat: document.getElementById('view-chat'),
            viewCanvas: document.getElementById('view-canvas'),
            
            // Chat
            chatList: document.getElementById('chat-messages'),
            formChat: document.getElementById('form-chat'),
            inputChat: document.getElementById('input-chat'),
            
            // Canvas
            canvasContent: document.getElementById('canvas-content'), // Scrollable container
            canvasLayer: document.getElementById('canvas-items-layer'), // Items layer
            inputCanvas: document.getElementById('input-canvas'),
            btnAddText: document.getElementById('btn-add-text'),
            btnEmojiOpen: document.getElementById('btn-emoji-open'),
            
            // Emoji
            emojiModal: document.getElementById('emoji-modal'),
            btnEmojiClose: document.getElementById('btn-emoji-close'),
            emojiGrid: document.getElementById('emoji-grid')
        };

        // --- Icons ---
        lucide.createIcons();

        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            els.loading.classList.add('hidden');
            if (user) {
                currentUser = user;
                // If we have saved room data, auto-fill but don't auto-join to allow changing
                if (displayName) els.inputName.value = displayName;
                if (currentRoom) els.inputRoom.value = currentRoom;
                els.login.classList.remove('hidden');
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        // --- Logic: Join Room ---
        els.btnJoin.addEventListener('click', () => {
            const name = els.inputName.value.trim();
            const room = els.inputRoom.value.trim();
            
            if (!name || !room) return;
            
            displayName = name;
            currentRoom = room;
            localStorage.setItem('cc_username', name);
            localStorage.setItem('cc_last_room', room);
            
            setupRoom(room);
        });

        function setupRoom(roomCode) {
            els.login.classList.add('hidden');
            els.app.classList.remove('hidden');
            els.headerRoom.textContent = roomCode;
            
            // 1. Chat Sync
            if (messagesUnsub) messagesUnsub();
            const msgRef = collection(db, 'artifacts', appId, 'public', 'data', `cc_msg_${roomCode}`);
            messagesUnsub = onSnapshot(msgRef, (snap) => {
                const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                msgs.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                renderMessages(msgs);
            });

            // 2. Canvas Sync
            if (canvasUnsub) canvasUnsub();
            const canvasRef = collection(db, 'artifacts', appId, 'public', 'data', `cc_canvas_${roomCode}`);
            canvasUnsub = onSnapshot(canvasRef, (snap) => {
                canvasItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderCanvasItems();
            });
        }

        // --- Logic: Chat ---
        function renderMessages(msgs) {
            els.chatList.innerHTML = msgs.map(msg => {
                const isMe = msg.uid === currentUser.uid;
                return `
                    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                        <span class="text-[10px] text-slate-500 px-2 mb-0.5">${escapeHtml(msg.sender)}</span>
                        <div class="max-w-[75%] px-4 py-2.5 rounded-2xl text-sm ${isMe ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-200'}">
                            ${escapeHtml(msg.text)}
                        </div>
                    </div>
                `;
            }).join('');
            // Auto scroll to bottom
            els.chatList.scrollTop = els.chatList.scrollHeight;
        }

        els.formChat.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = els.inputChat.value.trim();
            if (!text) return;
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `cc_msg_${currentRoom}`), {
                    text,
                    sender: displayName,
                    uid: currentUser.uid,
                    timestamp: serverTimestamp(),
                });
                els.inputChat.value = '';
            } catch (err) { console.error(err); }
        });

        // --- Logic: Canvas ---
        function renderCanvasItems() {
            els.canvasLayer.innerHTML = '';
            
            canvasItems.forEach(item => {
                const el = document.createElement('div');
                el.dataset.id = item.id;
                el.className = `absolute cursor-move select-none group ${selectedItemId === item.id ? 'z-50' : 'z-10'}`;
                
                // Positioning
                const displayY = (item.y < 100 && !item.isPx) ? (item.y * 10) : item.y;
                el.style.left = `${item.x}%`;
                el.style.top = `${displayY}px`;
                el.style.transform = `scale(${item.scale || 1})`;
                el.style.transformOrigin = 'top left';
                el.style.touchAction = 'none'; // Critical for custom drag

                // Content
                let contentHtml = '';
                if (item.type === 'text') {
                    contentHtml = `
                        <div class="px-4 py-3 rounded-2xl shadow-xl min-w-[120px] max-w-[250px] ${item.color || 'bg-slate-700'} text-slate-900">
                            <p class="text-[10px] opacity-60 uppercase font-bold mb-1 tracking-wider">${escapeHtml(item.sender)}</p>
                            <p class="text-sm font-medium leading-snug">${escapeHtml(item.content)}</p>
                        </div>
                    `;
                } else {
                    contentHtml = `
                        <div class="text-6xl relative">
                            ${item.content}
                            <div class="absolute -top-4 left-1/2 -translate-x-1/2 bg-black/50 text-white text-[9px] px-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap">
                                ${escapeHtml(item.sender)}
                            </div>
                        </div>
                    `;
                }

                // Controls (only if selected)
                let controlsHtml = '';
                if (selectedItemId === item.id) {
                    controlsHtml = `
                        <div class="absolute -inset-2 border-2 border-indigo-500 rounded-xl pointer-events-none opacity-50"></div>
                        <button class="btn-delete absolute -top-4 -right-4 bg-rose-500 text-white p-1.5 rounded-full shadow-md hover:scale-110 transition-transform pointer-events-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                        <div class="handle-resize absolute -bottom-4 -right-4 w-8 h-8 bg-indigo-500 rounded-full shadow-lg flex items-center justify-center cursor-nwse-resize touch-none active:scale-125 transition-transform pointer-events-auto">
                             <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 3 9 15"/><path d="M12 3H3v18h18v-9"/><path d="M16 21h5v-5"/></svg>
                        </div>
                    `;
                }

                el.innerHTML = contentHtml + controlsHtml;

                // Event Listeners for this item
                el.addEventListener('pointerdown', (e) => handleItemPointerDown(e, item, 'move'));
                
                // Specific listeners for controls
                const delBtn = el.querySelector('.btn-delete');
                if (delBtn) {
                    delBtn.addEventListener('pointerdown', (e) => {
                        e.stopPropagation();
                        deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `cc_canvas_${currentRoom}`, item.id));
                        selectedItemId = null;
                    });
                }

                const resizeHandle = el.querySelector('.handle-resize');
                if (resizeHandle) {
                    resizeHandle.addEventListener('pointerdown', (e) => handleItemPointerDown(e, item, 'resize'));
                }

                els.canvasLayer.appendChild(el);
            });
        }

        // Drag & Drop Logic
        function handleItemPointerDown(e, item, mode) {
            e.stopPropagation();
            // e.target.setPointerCapture(e.pointerId); // Can cause issues if clicking children, let's stick to window events
            
            selectedItemId = item.id;
            interactionMode = mode;
            dragStart = { x: e.clientX, y: e.clientY };
            
            // Normalize Y
            let safeY = item.y;
            if (item.y < 100 && item.y > 0 && !item.isPx) { 
                safeY = (item.y / 100) * 1000; 
            }
            initialItemState = { ...item, y: safeY };
            
            renderCanvasItems(); // Re-render to show controls
        }

        // Global Pointer Move/Up (attached to the canvas container for better drag handling)
        els.viewCanvas.addEventListener('pointermove', (e) => {
            if (!interactionMode || !initialItemState) return;
            e.preventDefault(); // Prevent scrolling while dragging

            const dx = e.clientX - dragStart.x;
            const dy = e.clientY - dragStart.y;

            if (interactionMode === 'move') {
                const containerWidth = els.canvasLayer.clientWidth || window.innerWidth;
                const newX = Math.min(Math.max(initialItemState.x + (dx / containerWidth * 100), 0), 90);
                const newY = Math.max(initialItemState.y + dy, 0);
                
                // Optimistic update logic could go here, for now we rely on visual feedback if we updated DOM directly,
                // but pure Firestore update is cleaner for code. 
                // To make it smooth without React, we manually update the DOM element style:
                const el = els.canvasLayer.querySelector(`[data-id="${initialItemState.id}"]`);
                if(el) {
                    el.style.left = `${newX}%`;
                    el.style.top = `${newY}px`;
                }
            } else if (interactionMode === 'resize') {
                const scaleDelta = dx * 0.005;
                const newScale = Math.min(Math.max((initialItemState.scale || 1) + scaleDelta, 0.5), 5);
                
                const el = els.canvasLayer.querySelector(`[data-id="${initialItemState.id}"]`);
                if(el) el.style.transform = `scale(${newScale})`;
            }
        });

        els.viewCanvas.addEventListener('pointerup', async (e) => {
            if (interactionMode && initialItemState) {
                const el = els.canvasLayer.querySelector(`[data-id="${initialItemState.id}"]`);
                
                // Calculate final values from DOM or recalc
                if (interactionMode === 'move') {
                    const dx = e.clientX - dragStart.x;
                    const dy = e.clientY - dragStart.y;
                    const containerWidth = els.canvasLayer.clientWidth || window.innerWidth;
                    const newX = Math.min(Math.max(initialItemState.x + (dx / containerWidth * 100), 0), 90);
                    const newY = Math.max(initialItemState.y + dy, 0);
                    
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `cc_canvas_${currentRoom}`, initialItemState.id), {
                        x: newX, y: newY, isPx: true
                    });
                } else if (interactionMode === 'resize') {
                    const dx = e.clientX - dragStart.x;
                    const scaleDelta = dx * 0.005;
                    const newScale = Math.min(Math.max((initialItemState.scale || 1) + scaleDelta, 0.5), 5);
                    
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `cc_canvas_${currentRoom}`, initialItemState.id), {
                        scale: newScale
                    });
                }
            }
            interactionMode = null;
            initialItemState = null;
        });

        // Click on background to deselect
        els.viewCanvas.addEventListener('pointerdown', (e) => {
            if(e.target === els.viewCanvas || e.target === els.canvasContent || e.target === els.canvasLayer) {
                if (selectedItemId) {
                    selectedItemId = null;
                    renderCanvasItems();
                }
            }
        });

        // Canvas Add Text
        async function addCanvasItem(type, content) {
            if (!content.trim()) return;
            
            // Calc Y based on scroll
            const container = els.viewCanvas;
            const y = container.scrollTop + (container.clientHeight / 2) - 50;
            const x = 10 + Math.random() * 60;
            const color = ['bg-rose-400', 'bg-indigo-400', 'bg-emerald-400', 'bg-amber-400', 'bg-sky-400'][Math.floor(Math.random()*5)];

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `cc_canvas_${currentRoom}`), {
                    type, content, x, y, scale: 1, isPx: true,
                    sender: displayName, uid: currentUser.uid, color
                });
                els.inputCanvas.value = '';
                els.emojiModal.classList.add('hidden');
            } catch(e) { console.error(e); }
        }

        els.btnAddText.addEventListener('click', () => addCanvasItem('text', els.inputCanvas.value));
        els.inputCanvas.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') addCanvasItem('text', els.inputCanvas.value);
        });

        // --- UI View Switching ---
        function setView(mode) {
            viewMode = mode;
            if (mode === 'chat') {
                els.viewChat.classList.remove('hidden');
                els.viewCanvas.classList.add('hidden');
                els.tabChat.className = "px-4 py-1.5 rounded-full text-xs font-bold transition-all bg-white text-black shadow-sm";
                els.tabCanvas.className = "px-4 py-1.5 rounded-full text-xs font-bold transition-all text-slate-400 hover:text-white";
                els.statusInd.className = "w-2 h-2 rounded-full bg-indigo-500 animate-pulse";
            } else {
                els.viewChat.classList.add('hidden');
                els.viewCanvas.classList.remove('hidden');
                els.tabChat.className = "px-4 py-1.5 rounded-full text-xs font-bold transition-all text-slate-400 hover:text-white";
                els.tabCanvas.className = "px-4 py-1.5 rounded-full text-xs font-bold transition-all bg-white text-black shadow-sm";
                els.statusInd.className = "w-2 h-2 rounded-full bg-emerald-400 animate-pulse";
            }
        }
        els.tabChat.addEventListener('click', () => setView('chat'));
        els.tabCanvas.addEventListener('click', () => setView('canvas'));
        
        els.btnLogout.addEventListener('click', () => {
            currentRoom = '';
            localStorage.removeItem('cc_last_room');
            els.app.classList.add('hidden');
            els.login.classList.remove('hidden');
            if(messagesUnsub) messagesUnsub();
            if(canvasUnsub) canvasUnsub();
        });

        // --- Emoji Picker ---
        const COMMON_EMOJIS = [
            "ðŸ˜€","ðŸ˜‚","ðŸ˜","ðŸ¥°","ðŸ˜Ž","ðŸ˜­","ðŸ˜±","ðŸ˜¡","ðŸ¥³","ðŸ¤”",
            "ðŸ‘","ðŸ‘Ž","ðŸ‘‹","ðŸ™","ðŸ’ª","ðŸ’…","ðŸ¤³","ðŸ§ ","ðŸ‘€","ðŸ’‹",
            "â¤ï¸","ðŸ’”","ðŸ”¥","âœ¨","ðŸ’©","ðŸ‘»","ðŸ’€","ðŸ‘½","ðŸ¤–","ðŸŽƒ",
            "ðŸ¶","ðŸ±","ðŸ¦„","ðŸ¦‹","ðŸ™","ðŸ¸","ðŸŽ","ðŸ•","ðŸº","ðŸš€",
            "ðŸ’¡","ðŸŽ‰","ðŸŽˆ","ðŸŽ","ðŸ†","ðŸ’°","ðŸ’Ž","ðŸ’£","ðŸ”ª","ðŸ’Š",
            "ðŸ’¯","âœ…","âŒ","â“","â—ï¸","ðŸ³ï¸â€ðŸŒˆ","ðŸ‡ºðŸ‡¸","ðŸŒ","ðŸª","ðŸŒ™"
        ];

        els.emojiGrid.innerHTML = COMMON_EMOJIS.map(char => `
            <button class="btn-emoji aspect-square flex items-center justify-center text-3xl hover:bg-slate-800 rounded-xl transition-colors active:scale-90">${char}</button>
        `).join('');

        els.emojiGrid.querySelectorAll('.btn-emoji').forEach(btn => {
            btn.addEventListener('click', () => addCanvasItem('emoji', btn.textContent));
        });

        els.btnEmojiOpen.addEventListener('click', () => els.emojiModal.classList.remove('hidden'));
        els.btnEmojiClose.addEventListener('click', () => els.emojiModal.classList.add('hidden'));

        // Helper
        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/&/g, "&amp;")
                       .replace(/</g, "&lt;")
                       .replace(/>/g, "&gt;")
                       .replace(/"/g, "&quot;")
                       .replace(/'/g, "&#039;");
        }

    </script>
</body>
</html>
